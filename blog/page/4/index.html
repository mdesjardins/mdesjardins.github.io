
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>My Octopress Blog</title>
  <meta name="author" content="Your Name">

  
  <meta name="description" content="One feature of JPA that didn&#8217;t exist in plain-vanilla Hibernate is support for Enumerated types. I haven&#8217;t seen a lot of examples of this &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://mdesjardins.github.io/blog/page/4">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="My Octopress Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">My Octopress Blog</a></h1>
  
    <h2>A blogging framework for hackers.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:mdesjardins.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2008/02/18/enumerated-types-with-jpa-and-your-sock/">Enumerated Types With JPA, and Your Sock Drawer</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-02-18T00:00:00-05:00" pubdate data-updated="true">Feb 18<span>th</span>, 2008</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a onblur="try {parent.deselectBloggerImageGracefully();} catch(e) {}" href="http://mikedesjardins.us/blog/uploaded_images/sockdrawer-773600.jpg"><img style="margin: 0pt 0pt 10px 10px; float: right; cursor: pointer; width: 226px; height: 341px;" src="http://mikedesjardins.us/blog/uploaded_images/sockdrawer-773596.jpg" alt="" border="0" /></a>One feature of JPA that didn&#8217;t exist in plain-vanilla Hibernate is support for Enumerated types. I haven&#8217;t seen a lot of examples of this in practice or on the internet, so in this post I&#8217;ll show one example of how to use JDK 5 enumerations with JPA.</p>

<p>For our example, we are going to create an inventory system for our sock drawer. It is comprised of only two tables. The first table, called SOCK, contains one row per sock in our drawer. The columns of the table are:</p>

<ul>
<li>sock_id &#8211; an auto-incrementing identity column.</li>
<li>sock_description &#8211; a varchar column for a free-form text description of the sock.</li>
<li>sock_pattern_id &#8211; a reference to a row in the SOCK_PATTERN table.</li>
</ul>


<p>As you may have guessed, the SOCK_PATTERN table looks like this:
*   sock_pattern_id &#8211; an integer primary key. It&#8217;s not auto-incrementing, because we will want to have control over the contents of the field.
*   sock_pattern_description &#8211; a varchar column for a free-form text description of the pattern.</p>

<p>We need to &#8220;prime&#8221; our SOCK_PATTERN table with the valid patterns and create a foreign key relationship between the two tables:</p>

<div class="wp_syntax">
  <div class="code">
    <pre class="sql" style="font-family:monospace;"><span style="color: #993333; font-weight: bold;">INSERT</span> <span style="color: #993333; font-weight: bold;">INTO</span> SOCK_PATTERN <span style="color: #66cc66;">&#40;</span>sock_pattern_id<span style="color: #66cc66;">,</span>sock_pattern_description<span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">VALUES</span> <span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;"></span><span style="color: #66cc66;">,</span><span style="color: #ff0000;">'SOLID'</span><span style="color: #66cc66;">&#41;</span>;
<span style="color: #993333; font-weight: bold;">INSERT</span> <span style="color: #993333; font-weight: bold;">INTO</span> SOCK_PATTERN <span style="color: #66cc66;">&#40;</span>sock_pattern_id<span style="color: #66cc66;">,</span>sock_pattern_description<span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">VALUES</span> <span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">1</span><span style="color: #66cc66;">,</span><span style="color: #ff0000;">'STRIPES'</span><span style="color: #66cc66;">&#41;</span>;
<span style="color: #993333; font-weight: bold;">INSERT</span> <span style="color: #993333; font-weight: bold;">INTO</span> SOCK_PATTERN <span style="color: #66cc66;">&#40;</span>sock_pattern_id<span style="color: #66cc66;">,</span>sock_pattern_description<span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">VALUES</span> <span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">2</span><span style="color: #66cc66;">,</span><span style="color: #ff0000;">'POLKA_DOT'</span><span style="color: #66cc66;">&#41;</span>;
<span style="color: #993333; font-weight: bold;">INSERT</span> <span style="color: #993333; font-weight: bold;">INTO</span> SOCK_PATTERN <span style="color: #66cc66;">&#40;</span>sock_pattern_id<span style="color: #66cc66;">,</span>sock_pattern_description<span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">VALUES</span> <span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">3</span><span style="color: #66cc66;">,</span><span style="color: #ff0000;">'ARGYLE'</span><span style="color: #66cc66;">&#41;</span>;</pre>
  </div>
</div>


<p>Note that we populated sock_pattern_id starting with zero; this is important because the Enumeration below is zero-indexed.</p>

<p>Next, let&#8217;s create the classes:</p>

<div class="wp_syntax">
  <div class="code">
    <pre class="java" style="font-family:monospace;"><span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">enum</span> SockPattern <span style="color: #009900;">&#123;</span>
 SOLID, STRIPES, POLKA_DOT, ARGYLE
<span style="color: #009900;">&#125;</span>
&nbsp;
@<span style="color: #003399;">Entity</span> @Table<span style="color: #009900;">&#40;</span>name<span style="color: #339933;">=</span><span style="color: #0000ff;">"SOCK"</span><span style="color: #009900;">&#41;</span>
<span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">class</span> Sock <span style="color: #009900;">&#123;</span>
 @Id @GeneratedValue<span style="color: #009900;">&#40;</span>strategy<span style="color: #339933;">=</span>GenerationType.<span style="color: #006633;">IDENTITY</span><span style="color: #009900;">&#41;</span>
 @Column<span style="color: #009900;">&#40;</span>name<span style="color: #339933;">=</span><span style="color: #0000ff;">"sock_id"</span><span style="color: #009900;">&#41;</span>
 <span style="color: #000000; font-weight: bold;">private</span> <span style="color: #003399;">Integer</span> id<span style="color: #339933;">;</span>
&nbsp;
 @Column<span style="color: #009900;">&#40;</span>name<span style="color: #339933;">=</span><span style="color: #0000ff;">"sock_description"</span><span style="color: #009900;">&#41;</span>
 <span style="color: #000000; font-weight: bold;">private</span> <span style="color: #003399;">String</span> description<span style="color: #339933;">;</span>
&nbsp;
 @Enumerated @Column<span style="color: #009900;">&#40;</span>name<span style="color: #339933;">=</span><span style="color: #0000ff;">"sock_pattern_id"</span><span style="color: #009900;">&#41;</span>
 <span style="color: #000000; font-weight: bold;">private</span> SockPattern pattern<span style="color: #339933;">;</span>
&nbsp;
 <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #003399;">Integer</span> getId<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> <span style="color: #000000; font-weight: bold;">return</span> id<span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span>
 <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000066; font-weight: bold;">void</span> setId<span style="color: #009900;">&#40;</span><span style="color: #003399;">Integer</span> id<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> <span style="color: #000000; font-weight: bold;">this</span>.<span style="color: #006633;">id</span> <span style="color: #339933;">=</span> id<span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span>
&nbsp;
 <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #003399;">String</span> getDescription<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> <span style="color: #000000; font-weight: bold;">return</span> description<span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span>
 <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000066; font-weight: bold;">void</span> setDescription<span style="color: #009900;">&#40;</span><span style="color: #003399;">String</span> description<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> <span style="color: #000000; font-weight: bold;">this</span>.<span style="color: #006633;">description</span> <span style="color: #339933;">=</span> description<span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span>
&nbsp;
 <span style="color: #000000; font-weight: bold;">public</span> SockPattern getPattern<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> <span style="color: #000000; font-weight: bold;">return</span> pattern<span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span>
 <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000066; font-weight: bold;">void</span> setPattern<span style="color: #009900;">&#40;</span>SockPattern pattern<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> <span style="color: #000000; font-weight: bold;">this</span>.<span style="color: #006633;">pattern</span> <span style="color: #339933;">=</span> pattern<span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span>
<span style="color: #009900;">&#125;</span></pre>
  </div>
</div>


<p>Now, to use our wonderful contraption, you&#8217;d do something like the following:</p>

<div class="wp_syntax">
  <div class="code">
    <pre class="java" style="font-family:monospace;"><span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">class</span> Demo <span style="color: #009900;">&#123;</span>
 <span style="color: #000000; font-weight: bold;">private</span> <span style="color: #000000; font-weight: bold;">static</span> EntityManagerFactory emf<span style="color: #339933;">;</span>
 <span style="color: #000000; font-weight: bold;">static</span> <span style="color: #009900;">&#123;</span>
     Demo.<span style="color: #006633;">emf</span> <span style="color: #339933;">=</span> Persistence.<span style="color: #006633;">createEntityManagerFactory</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">"sockdrawer"</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
 <span style="color: #009900;">&#125;</span>
&nbsp;
 @Test
 <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000066; font-weight: bold;">void</span> socksOne<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
     Sock sock <span style="color: #339933;">=</span> <span style="color: #000000; font-weight: bold;">new</span> Sock<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
     sock.<span style="color: #006633;">setDescription</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">"My favorite sock."</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
     sock.<span style="color: #006633;">setPattern</span><span style="color: #009900;">&#40;</span>SockPattern.<span style="color: #006633;">ARGYLE</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
     EntityManager em <span style="color: #339933;">=</span> Demo.<span style="color: #006633;">emf</span>.<span style="color: #006633;">createEntityManager</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
     em.<span style="color: #006633;">getTransaction</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>.<span style="color: #006633;">begin</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
     em.<span style="color: #006633;">persist</span><span style="color: #009900;">&#40;</span>sock<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
     em.<span style="color: #006633;">getTransaction</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>.<span style="color: #006633;">commit</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
     em.<span style="color: #006633;">close</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
 <span style="color: #009900;">&#125;</span>
<span style="color: #009900;">&#125;</span></pre>
  </div>
</div>


<p>There are some obvious pitfalls to this approach. The object/relational mapping is very brittle; for this code to work, the IDs in the database always need to match the values that the ORM tool gets from the enumeration. Changing these values at a later date could cause some surprising results, and you can&#8217;t insert new rows without updating the Enumeration and recompiling. It does obviate the need to map the SOCK_PATTERN table, and you won&#8217;t need to worry about the details of cascading the persistent state of related Sock and SockPattern objects.</p>

<p>It&#8217;s just a new tool in the JPA toolbox.</p>

<p>(The code in this blog post was tested w/ Postgres and Toplink)</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2008/01/31/new-jpa-tutorial-pizza-shop/">A Delicious and Simple JPA Mapping Tutorial: The Pizza Shop</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-01-31T00:00:00-05:00" pubdate data-updated="true">Jan 31<span>st</span>, 2008</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a onblur="try {parent.deselectBloggerImageGracefully();} catch(e) {}" href="http://mikedesjardins.us/blog/uploaded_images/pizzasign-715213.jpg"><img style="margin: 0pt 0pt 10px 10px; float: right; cursor: pointer;" src="http://mikedesjardins.us/blog/uploaded_images/pizzasign-715207.jpg" alt="" border="0" /></a>So, another JPA tutorial. What makes this one different? Well, for one thing, this one comes with a working, downloadable project that works with Eclipse, NetBeans, and IntelliJ IDEA 7. It&#8217;s packaged with Hibernate, Toplink, and OpenJPA. And it&#8217;s been tested with MySQL, PostgreSQL, MS SQL Server, and Sybase. In other words, it works with 36 different IDE/JPA Provider/Database combinations!</p>

<p>Another thing that makes this tutorial different is the subject matter: Pizza! Who doesn&#8217;t love pizza? Except lactose intolerant people. And people who can&#8217;t eat gluten. But <span style="font-style: italic;">other than them</span>, who doesn&#8217;t love pizza? So we&#8217;re going to create a simple database model for a pizza shop&#8217;s point-of-sale system.</p>

<p><span style="font-weight: bold;font-size:130%;" >The Schema</span><br/>
Unsurprisingly, the starting point for any ORM task is usually the database schema (there are people who start with the Objects and work &#8220;backward&#8221; to the schema, but I haven&#8217;t worked with any of them yet). In our example, we have a pristine, consistent, completely normalized schema. In other words, it&#8217;s probably nothing like you&#8217;ll ever be lucky enough to see in the real world! Here&#8217;s our simple little ERD:<a onblur="try {parent.deselectBloggerImageGracefully();} catch(e) {}" href="http://mikedesjardins.us/blog/uploaded_images/pizza-erd-737227.jpg"><img style="margin: 0px auto 10px; display: block; text-align: center; cursor: pointer; width: 454px; height: 326px;" src="http://mikedesjardins.us/blog/uploaded_images/pizza-erd-737223.jpg" alt="" border="0" /></a>From this ERD, we can infer the following: 1.) An order is comprised of zero or more pizzas. 2.) A pizza is associated with one size. 3.) A pizza may be associated with a string of text containing &#8220;special instructions.&#8221; 4.) A pizza may have zero or more toppings. You probably also notice that each table has a column called version. This will be used for an <a href="http://en.wikipedia.org/wiki/Optimistic_concurrency_control">optimistic locking strategy</a>.</p>

<p>The first question is, &#8220;Where should we start?&#8221; There&#8217;s no right answer for this, but I find that it&#8217;s easiest to start working with the entities with the fewest dependencies. For example, you can&#8217;t have an order without a pizza, and you can&#8217;t have a pizza without a size, so maybe it makes sense to start with the size. But before that, we&#8217;ll want an ID interface.</p>

<p><span style="font-size:130%;"><span style="font-weight: bold;">An ID Interface</span></span><br/>
First things first. You&#8217;ll notice that, in our schema, every table has an integer ID. It&#8217;s often a good idea to have all of your objects implement the same interface for accessing the ID, because it makes it easier to create Generic DAOs (more about that in a future post). For now, let&#8217;s make a really simple interface like this:</p>

<div class="wp_syntax">
  <div class="code">
    <pre class="java" style="font-family:monospace;"><span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">interface</span> IdObject <span style="color: #009900;">&#123;</span>
  <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000066; font-weight: bold;">void</span> setId<span style="color: #009900;">&#40;</span><span style="color: #003399;">Integer</span> id<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
  <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #003399;">Integer</span> getId<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<span style="color: #009900;">&#125;</span></pre>
  </div>
</div>


<p><span style="font-weight: bold;font-size:130%;" >Many-to-One Unidirectional Relationships</span><br/>
Now that we&#8217;ve gotten that out of the way, let&#8217;s create the Size class. It&#8217;s a simple POJO littered with annotations, like this:</p>

<div class="wp_syntax">
  <div class="code">
    <pre class="java" style="font-family:monospace;">@<span style="color: #003399;">Entity</span>
@Table<span style="color: #009900;">&#40;</span>name<span style="color: #339933;">=</span><span style="color: #0000ff;">"PIZZA_SIZE"</span><span style="color: #009900;">&#41;</span>
<span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">class</span> Size <span style="color: #000000; font-weight: bold;">implements</span> IdObject <span style="color: #009900;">&#123;</span>
  @Id
  @Column<span style="color: #009900;">&#40;</span>name<span style="color: #339933;">=</span><span style="color: #0000ff;">"pizza_size_id"</span><span style="color: #009900;">&#41;</span>
  <span style="color: #000000; font-weight: bold;">private</span> <span style="color: #003399;">Integer</span> id<span style="color: #339933;">;</span>
&nbsp;
  @Column<span style="color: #009900;">&#40;</span>name<span style="color: #339933;">=</span><span style="color: #0000ff;">"pizza_size_description"</span><span style="color: #009900;">&#41;</span>
  <span style="color: #000000; font-weight: bold;">private</span> <span style="color: #003399;">String</span> description<span style="color: #339933;">;</span>
&nbsp;
  @Column<span style="color: #009900;">&#40;</span>name<span style="color: #339933;">=</span><span style="color: #0000ff;">"pizza_size_base_price"</span><span style="color: #009900;">&#41;</span>
  <span style="color: #000000; font-weight: bold;">private</span> <span style="color: #003399;">BigDecimal</span> basePrice<span style="color: #339933;">;</span>
&nbsp;
  @Version @Column<span style="color: #009900;">&#40;</span>name<span style="color: #339933;">=</span><span style="color: #0000ff;">"version"</span><span style="color: #009900;">&#41;</span>
  <span style="color: #000000; font-weight: bold;">private</span> <span style="color: #003399;">Integer</span> version<span style="color: #339933;">;</span>
&nbsp;
  <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #003399;">Integer</span> getId<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> <span style="color: #000000; font-weight: bold;">return</span> id<span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span>
  <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000066; font-weight: bold;">void</span> setId<span style="color: #009900;">&#40;</span><span style="color: #003399;">Integer</span> id<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> <span style="color: #000000; font-weight: bold;">this</span>.<span style="color: #006633;">id</span> <span style="color: #339933;">=</span> id<span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span>
&nbsp;
  <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #003399;">String</span> getDescription<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> <span style="color: #000000; font-weight: bold;">return</span> description<span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span>
  <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000066; font-weight: bold;">void</span> setDescription<span style="color: #009900;">&#40;</span><span style="color: #003399;">String</span> description<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> <span style="color: #000000; font-weight: bold;">this</span>.<span style="color: #006633;">description</span> <span style="color: #339933;">=</span> description<span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span>
&nbsp;
  <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #003399;">BigDecimal</span> getBasePrice<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> <span style="color: #000000; font-weight: bold;">return</span> basePrice<span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span>
  <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000066; font-weight: bold;">void</span> setBasePrice<span style="color: #009900;">&#40;</span><span style="color: #003399;">BigDecimal</span> basePrice<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> <span style="color: #000000; font-weight: bold;">this</span>.<span style="color: #006633;">basePrice</span> <span style="color: #339933;">=</span> basePrice<span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span>
&nbsp;
  <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #003399;">Integer</span> getVersion<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> <span style="color: #000000; font-weight: bold;">return</span> version<span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span>
  <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000066; font-weight: bold;">void</span> setVersion<span style="color: #009900;">&#40;</span><span style="color: #003399;">Integer</span> version<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> <span style="color: #000000; font-weight: bold;">this</span>.<span style="color: #006633;">version</span> <span style="color: #339933;">=</span> version<span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span>
<span style="color: #009900;">&#125;</span></pre>
  </div>
</div>


<p>Here are some notes on the annotations that were used in the above class: <span style="font-weight: bold;"><br />@Entity</span> tells the JPA provider that this is a managed object.<br/>
<span style="font-weight: bold;">@Table</span> specifies the table name. The JPA provider will attempt to default the table name to a sane value based on the class name, but I like to be explicit. I&#8217;m funny that way. Perhaps it&#8217;s <a href="http://en.wikipedia.org/wiki/Obsessive-compulsive_disorder">OCD</a>. Or a <a href="http://en.wikipedia.org/wiki/Dick_cheney">power-trip</a>.<br/>
<span style="font-weight: bold;">@Column</span> indicates the name of the column, and can include other attributes about the column (you&#8217;ll see a few additional attributes later on). Again, JPA can try to default this to sane values for you, but I like to be explicit.<br/>
<span style="font-weight: bold;">@Version</span> indicates that a particular column is used for indicating when a row is updated. This column can then be used in an <a href="http://en.wikipedia.org/wiki/Optimistic_concurrency_control">optimistic locking</a> scheme.</p>

<p>Next, let&#8217;s do the Pizza object to show how we map a Pizza to a Size.<br/>
<a onblur="try {parent.deselectBloggerImageGracefully();} catch(e) {}" href="http://mikedesjardins.us/blog/uploaded_images/iStock_000004523455XSmall-738223.jpg"><img style="margin: 0pt 0pt 10px 10px; float: right; cursor: pointer; width: 400px; height: 264px;" src="http://mikedesjardins.us/blog/uploaded_images/iStock_000004523455XSmall-738216.jpg" alt="" border="0" /></a> One thing I that always tripped me up when I started out with ORM<br/>
tools was the difference between &#8220;One-to-Many&#8221; and &#8220;Many-to-One.&#8221; I never knew, if I call a relationship many-to-one in my metadata, is <span style="font-style: italic;">this</span> object the one that there are many of, or is it the other way around? The answer is that &#8220;this&#8221; object always comes first. <span>Many</span>ToOne means that &#8220;there are many of <span style="font-style: italic;">this</span> object to one of <span style="font-style: italic;">those</span> objects.&#8221; The &#8220;Many&#8221; side is often the side that has the foreign key.</p>

<p>In our case, there will be many Pizzas that are the same size. So when we make our Pizza object, we will want to use the <span style="font-weight: bold;">@ManyToOne</span> annotation. Here&#8217;s what the Pizza object looks like so far. I&#8217;ve omitted the getters and setters to save space:</p>

<div class="wp_syntax">
  <div class="code">
    <pre class="java" style="font-family:monospace;">@<span style="color: #003399;">Entity</span>
@Table<span style="color: #009900;">&#40;</span>name<span style="color: #339933;">=</span><span style="color: #0000ff;">"PIZZA"</span><span style="color: #009900;">&#41;</span>
<span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">class</span> Pizza <span style="color: #000000; font-weight: bold;">implements</span> IdObject <span style="color: #009900;">&#123;</span>
  @Id
  @Column<span style="color: #009900;">&#40;</span>name<span style="color: #339933;">=</span><span style="color: #0000ff;">"pizza_id"</span><span style="color: #009900;">&#41;</span>
  <span style="color: #000000; font-weight: bold;">private</span> <span style="color: #003399;">Integer</span> id<span style="color: #339933;">;</span>
&nbsp;
  @ManyToOne<span style="color: #009900;">&#40;</span>cascade<span style="color: #339933;">=</span><span style="color: #009900;">&#123;</span>CascadeType.<span style="color: #006633;">ALL</span><span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span>
  @JoinColumn<span style="color: #009900;">&#40;</span>name<span style="color: #339933;">=</span><span style="color: #0000ff;">"pizza_size_id"</span>,nullable<span style="color: #339933;">=</span><span style="color: #000066; font-weight: bold;">false</span><span style="color: #009900;">&#41;</span>
  <span style="color: #000000; font-weight: bold;">private</span> Size size<span style="color: #339933;">;</span>
&nbsp;
  @Version @Column<span style="color: #009900;">&#40;</span>name<span style="color: #339933;">=</span><span style="color: #0000ff;">"version"</span><span style="color: #009900;">&#41;</span>
  <span style="color: #000000; font-weight: bold;">private</span> <span style="color: #003399;">Integer</span> version<span style="color: #339933;">;</span>
&nbsp;
  <span style="color: #666666; font-style: italic;">// (Accessor methods omitted)</span>
<span style="color: #009900;">&#125;</span></pre>
  </div>
</div>


<p>Note that, when we made our Size object, we did not include a reference to the Pizza. That was an intentional design decision. In this application, it&#8217;s unlikely that we will want to instantiate a Size object, and get a collection containing all of the Pizzas of that size, so we don&#8217;t bother with mapping it. This is called <span style="font-style: italic;">unidirectional association</span>.</p>

<p>The <span style="font-weight: bold;">@ManyToOne</span> annotation specifies a cascade attribute. There are several different settings for this attribute, which you can read more about <a href="http://www.oracle.com/technology/products/ias/toplink/jpa/resources/toplink-jpa-annotations.html#ManyToOne">here</a>. I tend to cascade the persistent state to all related objects because it reduces the amount of redundant API calls. By default, JPA does <span style="font-style: italic;">not</span> cascade pers istence to related objects. I&#8217;ll cover the cascade attribute in future posts, but for now, we&#8217;ll go with my personal preference, because I&#8217;m writing the article!</p>

<p>The <span style="font-weight: bold;">@JoinColumn</span> annotation indicates the column name that defines the linkage between the Pizza and the Size. You&#8217;ll also note that we&#8217;ve included some additional attributes on our <span style="font-weight: bold;">@Column</span> and <span style="font-weight: bold;">@JoinColumn</span> annotations. The unique and nullable attributes are particularly useful if you use tools to generate schema DDL from your mappings.</p>

<p><span style="font-size:130%;"><span style="font-weight: bold;">One-to-Many bidirectional relationships</span></span><br/>
<a onblur="try {parent.deselectBloggerImageGracefully();} catch(e) {}" href="http://mikedesjardins.us/blog/uploaded_images/iStock_000004945600XSmall-743572.jpg"><img style="margin: 0pt 0pt 10px 10px; float: right; cursor: pointer; width: 229px; height: 157px;" src="http://mikedesjardins.us/blog/uploaded_images/iStock_000004945600XSmall-743564.jpg" alt="" border="0" /></a> Both the SpecialInstruction and the Order objects are examples of One-to-Many bidirectional relationships. In the case of SpecialInstruction, it is likely that we will care about which Pizza an instruction is associated with, and likewise for the Order. A bidirectional one-to-many relationship implies that one object has a <span style="font-style: italic;">collection</span> of other o bjects. For example, an Order has a collection of Pizzas. First, lets add an order attribute to our Pizza object:</p>

<div class="wp_syntax">
  <div class="code">
    <pre class="java" style="font-family:monospace;">@<span style="color: #003399;">Entity</span>
@Table<span style="color: #009900;">&#40;</span>name<span style="color: #339933;">=</span><span style="color: #0000ff;">"PIZZA"</span><span style="color: #009900;">&#41;</span>
<span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">class</span> Pizza <span style="color: #000000; font-weight: bold;">implements</span> IdObject <span style="color: #009900;">&#123;</span>
.
.
  @ManyToOne<span style="color: #009900;">&#40;</span>cascade<span style="color: #339933;">=</span><span style="color: #009900;">&#123;</span>CascadeType.<span style="color: #006633;">ALL</span><span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span>
  @JoinColumn<span style="color: #009900;">&#40;</span>name<span style="color: #339933;">=</span><span style="color: #0000ff;">"pizza_order_id"</span>,nullable<span style="color: #339933;">=</span><span style="color: #000066; font-weight: bold;">false</span><span style="color: #009900;">&#41;</span>
  <span style="color: #000000; font-weight: bold;">private</span> Order order<span style="color: #339933;">;</span>
&nbsp;
  <span style="color: #000000; font-weight: bold;">public</span> Order getOrder<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> <span style="color: #000000; font-weight: bold;">return</span> order<span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span>
  <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000066; font-weight: bold;">void</span> setOrder<span style="color: #009900;">&#40;</span>Order order<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> <span style="color: #000000; font-weight: bold;">this</span>.<span style="color: #006633;">order</span> <span style="color: #339933;">=</span> order<span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span>
.
.
<span style="color: #009900;">&#125;</span></pre>
  </div>
</div>


<p>Next, let&#8217;s create an Order object to contain our collection of Pizzas, like this:</p>

<div class="wp_syntax">
  <div class="code">
    <pre class="java" style="font-family:monospace;">@<span style="color: #003399;">Entity</span>
@Table<span style="color: #009900;">&#40;</span>name<span style="color: #339933;">=</span><span style="color: #0000ff;">"PIZZA_ORDER"</span><span style="color: #009900;">&#41;</span>
<span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">class</span> Order <span style="color: #000000; font-weight: bold;">implements</span> IdObject <span style="color: #009900;">&#123;</span>
  @Id
  @Column<span style="color: #009900;">&#40;</span>name<span style="color: #339933;">=</span><span style="color: #0000ff;">"pizza_order_id"</span><span style="color: #009900;">&#41;</span>
  <span style="color: #000000; font-weight: bold;">private</span> <span style="color: #003399;">Integer</span> id<span style="color: #339933;">;</span>
&nbsp;
  @OneToMany<span style="color: #009900;">&#40;</span>cascade<span style="color: #339933;">=</span><span style="color: #009900;">&#123;</span>CascadeType.<span style="color: #006633;">ALL</span><span style="color: #009900;">&#125;</span>,mappedBy<span style="color: #339933;">=</span><span style="color: #0000ff;">"order"</span><span style="color: #009900;">&#41;</span>
  <span style="color: #000000; font-weight: bold;">private</span> <span style="color: #003399;">Set</span> pizzas <span style="color: #339933;">=</span> <span style="color: #000000; font-weight: bold;">new</span> <span style="color: #003399;">HashSet</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
&nbsp;
  @Version @Column<span style="color: #009900;">&#40;</span>name<span style="color: #339933;">=</span><span style="color: #0000ff;">"version"</span><span style="color: #009900;">&#41;</span>
  <span style="color: #000000; font-weight: bold;">private</span> <span style="color: #003399;">Integer</span> version<span style="color: #339933;">;</span>
&nbsp;
  <span style="color: #666666; font-style: italic;">// (version and id accessors omitted)</span>
&nbsp;
  <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #003399;">Set</span> getPizzas<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>  <span style="color: #000000; font-weight: bold;">return</span> pizzas<span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span>
  <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000066; font-weight: bold;">void</span> setPizzas<span style="color: #009900;">&#40;</span><span style="color: #003399;">Set</span> pizzas<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> <span style="color: #000000; font-weight: bold;">this</span>.<span style="color: #006633;">pizzas</span> <span style="color: #339933;">=</span> pizzas<span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span>
  <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000066; font-weight: bold;">void</span> addPizza<span style="color: #009900;">&#40;</span>Pizza pizza<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>  pizza.<span style="color: #006633;">setOrder</span><span style="color: #009900;">&#40;</span><span style="color: #000000; font-weight: bold;">this</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>  <span style="color: #000000; font-weight: bold;">this</span>.<span style="color: #006633;">pizzas</span>.<span style="color: #006633;">add</span><span style="color: #009900;">&#40;</span>pizza<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span>
<span style="color: #009900;">&#125;</span></pre>
  </div>
</div>


<p>There are a couple of things you worth noting about this mapping:<br/>
1.) The <span style="font-weight: bold;">@OneToMany</span> annotation uses the <span style="font-style: italic;">mappedBy</span> attribute to indicate which member of the related object defines the linkage between the two tables. In this case, we are saying that the Pizza object contains a member named order, which defines the linkage between the two objects.<br/>
2.) I&#8217;ve created a utility method called <span style="font-weight: bold;">addPizza</span>. This simplifies setting both sides of the bidirectional relationship by setting the Order object on the Pizza <span style="font-style: italic;">and</span> adding the Pizza to the Order&#8217;s collection. Users of this class will only need to make one method call to do both.</p>

<p><span style="font-size:130%;"><span style="font-weight: bold;">Many-to-Ma</span></span><span style="font-size:130%;"><span style="font-weight: bold;">ny relationships via a Join Table</span></span><br/>
<a onblur="try {parent.deselectBloggerImageGracefully();} catch(e) {}" href="http://mikedesjardins.us/blog/uploaded_images/cohdra100_1404-732725.JPG"><img style="margin: 0pt 10px 10px 0pt; float: left; cursor: pointer; width: 233px; height: 174px;" src="http://mikedesjardins.us/blog/uploaded_images/cohdra100_1404-732719.JPG" alt="" border="0" /></a> The last thing we&#8217;ll cover is how to map Join Tables. In our ERD, you can see that Toppings are modeled in the database with a TOPPING table that contains all of the valid toppings, a PIZZA table that contains all of the valid Pizzas, and a PIZZA_TOPPING table in the middle that maps all of the valid Pizzas to all of the valid Toppings. You <span style="font-style: italic;">could</span> create an object called PizzaTopping that corresponds to the PIZZA_TOPPING table. Then you could have a One-to-Many relationship from the Pizza to the PizzaTopping, and a One-to-One from each PizzaTopping to a Topping. That would be very cumbersome to work with! Fortunately, there&#8217;s a better way.</p>

<p>Logically, a Pizza has a collection of Toppings. In our Java code, we really shouldn&#8217;t care about the fact that there is a PIZZA_TOPPING join table in the middle. First, let&#8217;s create a simple Topping class:</p>

<div class="wp_syntax">
  <div class="code">
    <pre class="java" style="font-family:monospace;">@<span style="color: #003399;">Entity</span>
@Table<span style="color: #009900;">&#40;</span>name<span style="color: #339933;">=</span><span style="color: #0000ff;">"TOPPING"</span><span style="color: #009900;">&#41;</span>
<span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">class</span> Topping <span style="color: #000000; font-weight: bold;">implements</span> IdObject <span style="color: #009900;">&#123;</span>
  @Id
  @Column<span style="color: #009900;">&#40;</span>name<span style="color: #339933;">=</span><span style="color: #0000ff;">"topping_id"</span><span style="color: #009900;">&#41;</span>
  <span style="color: #000000; font-weight: bold;">private</span> <span style="color: #003399;">Integer</span> id<span style="color: #339933;">;</span>
&nbsp;
  @Column<span style="color: #009900;">&#40;</span>name<span style="color: #339933;">=</span><span style="color: #0000ff;">"topping_description"</span><span style="color: #009900;">&#41;</span>
  <span style="color: #000000; font-weight: bold;">private</span> <span style="color: #003399;">String</span> description<span style="color: #339933;">;</span>
&nbsp;
  @Column<span style="color: #009900;">&#40;</span>name<span style="color: #339933;">=</span><span style="color: #0000ff;">"topping_price"</span><span style="color: #009900;">&#41;</span>
  <span style="color: #000000; font-weight: bold;">private</span> <span style="color: #003399;">BigDecimal</span> price<span style="color: #339933;">;</span>
&nbsp;
  @Version @Column<span style="color: #009900;">&#40;</span>name<span style="color: #339933;">=</span><span style="color: #0000ff;">"version"</span><span style="color: #009900;">&#41;</span>
  <span style="color: #000000; font-weight: bold;">private</span> <span style="color: #003399;">Integer</span> version<span style="color: #339933;">;</span>
&nbsp;
  <span style="color: #666666; font-style: italic;">// (Accessors omitted)</span>
<span style="color: #009900;">&#125;</span></pre>
  </div>
</div>


<p>This is how the association would be mapped in the Pizza class:</p>

<div class="wp_syntax">
  <div class="code">
    <pre class="java" style="font-family:monospace;">@<span style="color: #003399;">Entity</span>
@Table<span style="color: #009900;">&#40;</span>name<span style="color: #339933;">=</span><span style="color: #0000ff;">"PIZZA"</span><span style="color: #009900;">&#41;</span>
<span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">class</span> Pizza <span style="color: #000000; font-weight: bold;">implements</span> IdObject <span style="color: #009900;">&#123;</span>
.
.
  @ManyToMany<span style="color: #009900;">&#40;</span>cascade<span style="color: #339933;">=</span><span style="color: #009900;">&#123;</span>CascadeType.<span style="color: #006633;">ALL</span><span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span>
  @JoinTable<span style="color: #009900;">&#40;</span>name<span style="color: #339933;">=</span><span style="color: #0000ff;">"PIZZA_TOPPING"</span>,
             joinColumns<span style="color: #339933;">=</span>@JoinColumn<span style="color: #009900;">&#40;</span>name<span style="color: #339933;">=</span><span style="color: #0000ff;">"pizza_id"</span><span style="color: #009900;">&#41;</span>,
             inverseJoinColumns<span style="color: #339933;">=</span>@JoinColumn<span style="color: #009900;">&#40;</span>name<span style="color: #339933;">=</span><span style="color: #0000ff;">"topping_id"</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span>
  <span style="color: #000000; font-weight: bold;">private</span> <span style="color: #003399;">Set</span> toppings <span style="color: #339933;">=</span> <span style="color: #000000; font-weight: bold;">new</span> <span style="color: #003399;">HashSet</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
&nbsp;
  <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #003399;">Set</span> getToppings<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> <span style="color: #000000; font-weight: bold;">return</span> toppings<span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span>
  <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000066; font-weight: bold;">void</span> setToppings<span style="color: #009900;">&#40;</span><span style="color: #003399;">Set</span> toppings<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> <span style="color: #000000; font-weight: bold;">this</span>.<span style="color: #006633;">toppings</span> <span style="color: #339933;">=</span> toppings<span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span>
  <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000066; font-weight: bold;">void</span> addTopping<span style="color: #009900;">&#40;</span>Topping topping<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> <span style="color: #000000; font-weight: bold;">this</span>.<span style="color: #006633;">toppings</span>.<span style="color: #006633;">add</span><span style="color: #009900;">&#40;</span>topping<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span>
.
.
<span style="color: #009900;">&#125;</span></pre>
  </div>
</div>


<p>The @JoinTable annotation defines three key attributes:<br/>
<span style="font-weight: bold;">name</span>: Identifies the name of the join table.<br/>
<span style="font-weight: bold;">joinColumns</span>: This attribute identifies the column name in the join table that points to <span style="font-style: italic;">this</span> object.<br/>
<span style="font-weight: bold;">inverseJoinColumns</span>: This attribute defines the column name in the join table that points to <span style="font-style: italic;">the other</span> objects.</p>

<p>From your Java code, the semantics for dealing with toppings on a pizza are just like any other set, much like you&#8217;d work with a One-to-many object.</p>

<p><span style="font-size:130%;"><span style="font-weight: bold;">Conclusion</span></span><br/>
Since the introduction of annotations, object/relational mapping is one of the easiest aspects of working with JPA over other frameworks. You can see this whole project in action on your IDE of choice by downloading it <a href="http://www.mediafire.com/?2jgrzkizfy9"><span style="text-decoration: underline;">here</span></a> (or from <a href="http://mikedesjardins.us/blog/pizzashop-1.1.tar.gz">here</a> if that doesn&#8217;t work for some reason). It should be a pretty reasonable starting point if you want a reference project to start playing with JPA. I hope to revisit the Pizza Shop project to cover other JPA topics in future posts.<br/>
<a href="http://mikedesjardins.us/blog/pizzashop-1.0.tar.gz"><br/>
</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2008/01/23/what-i-learned-from-contributing-to/">What I Learned From Contributing to an Open Source Project</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-01-23T00:00:00-05:00" pubdate data-updated="true">Jan 23<span>rd</span>, 2008</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a onblur="try {parent.deselectBloggerImageGracefully();} catch(e) {}" href="http://mikedesjardins.us/blog/uploaded_images/opensource_logo-772146.gif"><img style="margin: 0pt 0pt 10px 10px; float: right; cursor: pointer;" src="http://mikedesjardins.us/blog/uploaded_images/opensource_logo-772137.gif" alt="" border="0" /></a>A while ago, I had the opportunity to contribute to the <a href="http://wiki.awn-project.org/">Avant Window Navigator</a> open source project. My participation in the project has waned lately, but I&#8217;ve had a little time to reflect on the time that I spent working on it. In no particular order, here were some of the things I took away from the project. Note that this is just based on a single project, and that my experience might have been quite different had I participated in other projects:</p>

<p><span style="font-weight: bold;">Learn to detach yourself from from your code. </span> Once your stuff is checked into a public repository, anything can happen. Generally, most people will respect what they see as &#8220;your turf,&#8221; but that isn&#8217;t always the case. People will suggest improvements, implement them, and share them with the world before you even get a chance to review them. Overall, it&#8217;s a good thing and part of the ecology of an open-source project. At your typical office-programmer job, people usually end up becoming specialists in specific areas and the demarkation of responsibilities are quite clear, sometimes at the expense of progress. The boundaries are a lot looser in the open source community.</p>

<p><span style="font-weight: bold;">Interpersonal Relationships are Weird</span>. When you&#8217;re in an office, you know that Fred is a little odd, and gets touchy when people criticize his font selection, because your co-worker warns you when you&#8217;re at the coffee machine. Anyone who lives and dies by their e-mail knows that emotions don&#8217;t get conveyed adequately in text, and the same is true with online forums and IRC channels. Some people lose their inhibitions when they don&#8217;t understand that they&#8217;re communicating with other people, and turn into jerks. Fortunately, there aren&#8217;t very many of these people.</p>

<p><span style="font-weight: bold;">There&#8217;s a wide range in quality.</span> There&#8217;s no entrance requirement, so there&#8217;s a pretty wide variety in code quality. There are some incredible, amazing, talented people out there who are coding for their love of the craft. There are also people who make some sub-par stuff.</p>

<p><span style="font-weight: bold;">Apprehension about bugs.</span> When I started, I was really worried about what would happen when I released software that was buggy. In a commercial environment, there are often layers of people between the programmer and the end-user, so bug reports come to you filtered and sanitized. In the open source world, people will report bugs openly, directly to you, on forums, for all the world to see. That made me nervous as hell. It turned out to be not so bad. The users knew that they were using bleeding edge stuff, and they expected a degree of instability and seemed to accept it quite well. They were helpful and sympathetic when reporting problems. I think it cuts both ways; when users report their software defects to someone far removed from the programmer, they&#8217;re less sympathetic and more irate than if they&#8217;re communicating directly with a person who can help them. Users are people, just like programmers, and they usually realize that the programmers are doing this for free and are quite polite.</p>

<p><span style="font-weight: bold;">Uptake on Localization was less enthusiastic than I thought it&#8217;d be.</span> My weather applet was among the first to support multiple languages. Because there were so many contributers from outside the U.S. working on AWN, I thought people would jump at the opportunity to translate my applet to their native language. In the end, there were only three people who volunteered.</p>

<p><span style="font-weight: bold;">I felt old. </span> Most of the people contributing to the project were in college or in their mid-twenties. I&#8217;m in my mid-thirties, and after working for 10 hours, coming home, feeding the kids and getting them ready for the next day, it&#8217;s 8:00 and I don&#8217;t feel much like getting out the laptop and coding. I managed to sneak in a few cycles at work, but I always felt a little guilty about it. While the other contributers were complaining about their upcoming finals, I had to deal with the upcoming PTA meeting.</p>

<p><span style="font-weight: bold;">You can learn a lot.</span> I got into this project to &#8220;scratch an itch.&#8221; I was using Linux at work, I needed a dock, because I&#8217;m a Mac guy and I like docks. AWN was a Dock for Linux, but it was missing a clock. So I learned Python to create one. Now I know some Python, and I have a clock on my dock. I&#8217;m a happy man.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2008/01/21/glassfish-to-tomcat-w-jdbc-connection/">Glassfish to Tomcat W/ JDBC Connection Pooling</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-01-21T00:00:00-05:00" pubdate data-updated="true">Jan 21<span>st</span>, 2008</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Here&#8217;s your don&#8217;t-waste-hours-on-something-silly-that-I-did tip for the day.</p>

<p>I recently had the opportunity to change an existing in-house web application from running under Tomcat 5.5, to Glassfish v2. The application uses JDBC connection pooling in the application server, and uses JNDI to find the pool. The only stumbling block I encountered was that, immediately after deploying the application, Hibernate would always complain that it couldn&#8217;t find the connection:</p>

<p><span style="font-size:78%;"><span style="font-family:courier new;">org.hibernate.HibernateException: Could not find datasource</span><br /><span style="font-family:courier new;"> at org.hibernate.connection.DatasourceConnectionProvider.configure(DatasourceConnectionProvider.java:56)</span><br /><span style="font-family:courier new;"> at org.hibernate.connection.ConnectionProviderFactory.newConnectionProvider(ConnectionProviderFactory.java:124)</span><br /><span style="font-family:courier new;"> at </span><span style="font-family:courier new;"></span><br /><span style="font-family:courier new;">.</span><br /><span style="font-family:courier new;">.</span><br /><span style="font-family:courier new;">(yadda yadda)</span><br /><span style="font-family:courier new;">.</span><br /><span style="font-family:courier new;">Caused by: javax.naming.NameNotFoundException: No object bound to name java:/comp/env/jdbc/MyDB<br />.<br />.<br /></span></span><br/>
As it turns out, the datasource that I was using in hibernate.cfg.xml was perfectly fine for Tomcat, but not for Glassfish. I had put the fully qualified JNDI file in my config file:</p>

<div class="wp_syntax">
  <div class="code">
    <pre class="xml" style="font-family:monospace;"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;property</span> <span style="color: #000066;">name</span>=<span style="color: #ff0000;">"connection.datasource"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>java:/comp/env/jdbc/ApptrackDB<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/property<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></pre>
  </div>
</div>


<p>Glassfish doesn&#8217;t like that. Once I changed it to:</p>

<div class="wp_syntax">
  <div class="code">
    <pre class="xml" style="font-family:monospace;"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;property</span> <span style="color: #000066;">name</span>=<span style="color: #ff0000;">"connection.datasource"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>jdbc/ApptrackDB<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/property<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></pre>
  </div>
</div>


<p>Everything worked swimmingly.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2007/12/13/build-date-on-a-tapestry-4-login-page/">Build Date on a Tapestry 4 Login Page Using Ant</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2007-12-13T00:00:00-05:00" pubdate data-updated="true">Dec 13<span>th</span>, 2007</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Recently, I had to put a build timestamp onto a login page for a web application I&#8217;m developing at work. The web application is written using Tapestry 4.1, but some of the techniques are equally applicable to other frameworks. I thought I&#8217;d share.</p>

<p>First, you need to setup your ant task to grab a timestamp, and put it into your manifest file. You do so using the tstamp task, like this:<br/>
<span style="font-size:85%;"> <span style="font-family:courier new;"><br /></span></span><a onblur="try {parent.deselectBloggerImageGracefully();} catch(e) {}" href="http://www.dragonflymarsh.com/blog/uploaded_images/Screenshot-718923.png"><img style="margin: 0px auto 10px; display: block; text-align: center; cursor: pointer;" src="http://www.dragonflymarsh.com/blog/uploaded_images/Screenshot-718919.png" alt="" border="0" /></a>The tstamp task is taking the current date and time, formatting it as specified by pattern (just as you&#8217;d specify it in a <a href="http://java.sun.com/javase/6/docs/api/java/text/SimpleDateFormat.html">SimpleDateFormat</a>) and placing it in the <span style="font-weight: bold;">buildtstamp</span> variable. The manifest task builds a MANIFEST.MF file which ends up in your deployed web application&#8217;s META-INF directory. You&#8217;ll notice that I&#8217;m also putting the name of the user who built the application into the manifest.</p>

<p>Next, we need to read the Manifest from our application. The first screen presented by my Tapestry app is LogOn.java. First, use <a href="http://hivemind.apache.org/">HiveMind</a> to inject the ServletContext into my page:</p>

<p><span style="font-size:85%;"><span style="font-family:courier new;"> @InjectObject(&#8220;service:tapestry.globals.ServletContext&#8221;)</span><br /><span style="font-family:courier new;"> public abstract ServletContext getServletContext();</span><br /></span><br/>
Also, we need to create an abstract method into which we&#8217;ll store and retrieve the build date:</p>

<p><span style="font-size:85%;"><span style="font-family:courier new;"> public abstract String getBuiltOn();</span><br /><span style="font-family:courier new;"> public abstract void setBuiltOn(String builtOn);</span><br /></span><br/>
Finally, we need to read the Manifest file in our <span style="font-weight: bold;">pageBeginRender</span> method, and set the &#8220;Built On&#8221; date accordingly. This is how I did this:</p>

<pre>public void pageBeginRender(PageEvent event) {ServletContext sc = this.getServletContext();String filename = sc.getRealPath("/META-INF/MANIFEST.MF");try {  BufferedInputStream i = new BufferedInputStream(new FileInputStream(filename));  Manifest m = new Manifest(i);  Attributes attrib = m.getMainAttributes();  this.setBuiltOn(attrib.getValue("Build-Date"));} catch (Exception e) {  log.warn("Unable to read MANIFEST.MF");}}</pre>


<p>Finally, we need to actually render this on the LogOn page. I did this with a simple Insert component directly on the html page:</p>

<p><span style="font-size:85%;"><span style="font-family:courier new;">Built: <span jwcid=&#8221;@Insert&#8221; value=&#8221;ognl:builtOn&#8221;></span></span></p>

<p>And <span style="font-style: italic;">voila</span>! You have a build date on your log page, which can come in handy, e.g., when your QA team doesn&#8217;t know which version they&#8217;re testing!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2007/11/16/python-and-gconf/">Python and GConf</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2007-11-16T00:00:00-05:00" pubdate data-updated="true">Nov 16<span>th</span>, 2007</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>The <a href="http://wiki.awn-project.org/index.php?title=Weather_Applet">weather applet</a> and <a href="http://wiki.awn-project.org/index.php?title=Clock/Calendar_Applet">clock/calendar applet</a> for the <a href="http://www.awn-project.org/">Avant Window Navigator</a> both use <a href="http://www.gnome.org/projects/gconf/">GConf</a> to store their configuration settings. GConf is part of the GNOME environment on Linux. It maintains a hierarchical set of configuration data in (key,value) pairs, much like the registry on Windows or the &#8220;plist files&#8221; on OSX. One of the nice things about GConf is that you can register your application to receive notifications in a callback function whenever any interesting configuration values change.</p>

<p>I noticed that there weren&#8217;t a lot of tutorials out there on the topic of mixing Python with GConf, so I decided to write one.</p>

<p>First, you&#8217;ll need to import the Python bindings for GConf:</p>

<div class="wp_syntax">
  <div class="code">
    <pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">import</span> gconf</pre>
  </div>
</div>


<p>Next, you want to create a GConf &#8220;client&#8221; in your Python app. You&#8217;ll probably want to do this in an __init__() function somewhere. You&#8217;ll also want to register your application to receive notifications when ever your configuration values change. The hierarchy of configuration values in GConf follows the familiar slash-separated path notation. For example, the configuration values for my AWN weather applet are stored in /apps/avant-window-navigator/applets/weather. So, if I want to register a callback named config_event to be called whenever configuration values on that path are modified, I&#8217;d do the following:</p>

<div class="wp_syntax">
  <div class="code">
    <pre class="python" style="font-family:monospace;"><span style="color: #008000;">self</span>.<span style="color: black;">gconf_client</span> = gconf.<span style="color: black;">client_get_default</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
<span style="color: #008000;">self</span>.<span style="color: black;">gconf_client</span>.<span style="color: black;">notify_add</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">"/apps/avant-window-navigator/applets/weather"</span>, <span style="color: #008000;">self</span>.<span style="color: black;">config_event</span><span style="color: black;">&#41;</span></pre>
  </div>
</div>


<p><span style="font-size:100%;">I usually write a generic &#8220;get_config&#8221; function, and have the callback call get_config. That way, I can use the same configuration code when I initialize. The config callback then looks simple&#8230; something like this:</p> <div class="wp_syntax">
  <div class="code"></p>

<pre><code>&lt;pre class="python" style="font-family:monospace;"&gt;&lt;span style="color: #ff7700;font-weight:bold;"&gt;def&lt;/span&gt; config_event&lt;span style="color: black;"&gt;&amp;#40;&lt;/span&gt;&lt;span style="color: #008000;"&gt;self&lt;/span&gt;, gconf_client, &lt;span style="color: #66cc66;"&gt;*&lt;/span&gt;args, &lt;span style="color: #66cc66;"&gt;**&lt;/span&gt;kwargs&lt;span style="color: black;"&gt;&amp;#41;&lt;/span&gt;:
</code></pre>

<p>  <span style="color: #008000;">self</span>.<span style="color: black;">get_config</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span></pre>
  </div>
</div></p>

<p>
  <span style="font-size:100%;">The kwargs parameter gives you a list of parameters that changed. You can fine-tune your configuration code based on this, but I usually just ignore it and re-read everything because I don&#8217;t usually have very many parameters.</p>


<p> <p></p>

<pre><code>GConf provides functions for reading your parameters. They look like this:&lt;/span&gt;
</code></pre>

<p>  </p></p>

<p>  <div class="wp_syntax"></p>

<pre><code>&lt;div class="code"&gt;
  &lt;pre class="python" style="font-family:monospace;"&gt;foo = &lt;span style="color: #008000;"&gt;self&lt;/span&gt;.&lt;span style="color: black;"&gt;gconf_client&lt;/span&gt;.&lt;span style="color: black;"&gt;get_string&lt;/span&gt;&lt;span style="color: black;"&gt;&amp;#40;&lt;/span&gt;&lt;span style="color: #483d8b;"&gt;"/path/to/my/config/data/foo"&lt;/span&gt;&lt;span style="color: black;"&gt;&amp;#41;&lt;/span&gt;
</code></pre>

<p>bar = <span style="color: #008000;">self</span>.<span style="color: black;">gconf_client</span>.<span style="color: black;">get_int</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&ldquo;/path/to/my/config/data/bar&rdquo;</span><span style="color: black;">&#41;</span>
baz = <span style="color: #008000;">self</span>.<span style="color: black;">gconf_client</span>.<span style="color: black;">get_bool</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&ldquo;/path/to/my/config/data/baz&rdquo;</span><span style="color: black;">&#41;</span></pre></p>

<pre><code>&lt;/div&gt;
</code></pre>

<p>  </div></p>

<p>  <p></p>

<pre><code>&lt;span style="font-size:100%;"&gt;All of the functions except &lt;/span&gt;&lt;span style=";font-family:courier new;font-size:100%;"  &gt;get_bool&lt;/span&gt;return None if the key isn&amp;#8217;t found. Oddly, &lt;span style=";font-family:courier new;font-size:100%;"  &gt;get_bool&lt;/span&gt; seems to return False if the key isn&amp;#8217;t found. In my configuration code, I like to initialize my GConf values when the key isn&amp;#8217;t found. So when if my code were to read the &amp;#8220;foo&amp;#8221; parameter like the above example, it&amp;#8217;d actually be coded something like this:&lt;/span&gt;
</code></pre>

<p>  </p></p>

<p>  <div class="wp_syntax"></p>

<pre><code>&lt;div class="code"&gt;
  &lt;pre class="python" style="font-family:monospace;"&gt;foo = &lt;span style="color: #008000;"&gt;self&lt;/span&gt;.&lt;span style="color: black;"&gt;gconf_client&lt;/span&gt;.&lt;span style="color: black;"&gt;get_string&lt;/span&gt;&lt;span style="color: black;"&gt;&amp;#40;&lt;/span&gt;&lt;span style="color: #483d8b;"&gt;"/path/to/my/config/foo"&lt;/span&gt;&lt;span style="color: black;"&gt;&amp;#41;&lt;/span&gt;
</code></pre>

<p><span style="color: #ff7700;font-weight:bold;">if</span> foo == <span style="color: #008000;">None</span>:
  <span style="color: #008000;">self</span>.<span style="color: black;">gconf_client</span>.<span style="color: black;">set_string</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&ldquo;/path/to/my/config/foo&rdquo;</span>, <span style="color: #483d8b;">&ldquo;Default Value&rdquo;</span><span style="color: black;">&#41;</span>
  foo = <span style="color: #483d8b;">&ldquo;Default Value&rdquo;</span></pre></p>

<pre><code>&lt;/div&gt;
</code></pre>

<p>  </div></p>

<p>  <p></p>

<pre><code>&lt;span style="font-size:100%;"&gt;&lt;br /&gt;And I usually wrap the above idiom in its own function that accepts a key name and a default value.&lt;br /&gt;&lt;/span&gt;&lt;br /&gt;&lt;a onblur="try {parent.deselectBloggerImageGracefully();} catch(e) {}" href="http://www.dragonflymarsh.com/blog/uploaded_images/Screenshot-Configuration-Editor---weather-703851.png"&gt;&lt;img style="margin: 0pt 0pt 10px 10px; float: right; cursor: pointer; width: 264px; height: 210px;" src="http://mikedesjardins.us/blog/uploaded_images/Screenshot-Configuration-Editor---weather-703844.png" alt="" border="0" /&gt;&lt;/a&gt;&lt;br /&gt;&lt;span style="font-size:100%;"&gt;Note that you can edit and interact with your GConf settings in realtime using &lt;/span&gt;&lt;span style="font-size:100%;"&gt;the GNOME configuration tool. If you use Ubuntu, then this utility may be found under the &amp;#8220;System Tools&amp;#8221; menu. Editing configuration values in the configuration tool will result in your callback being executed as you might expect.&lt;/p&gt; &lt;p&gt;
  This also makes creating a configuration dialog easy. The configuration dialog just needs to write its updated values to gconf when the user clicks Apply or OK. If you&amp;#8217;ve created a callback and generic configuration function, then the application will automatically reconfigure itself after the user applies their modifications!&lt;/span&gt;
&lt;/p&gt;
</code></pre>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2007/11/13/last-day-of-month-w-javascript/">Last Day of the Month W/ JavaScript</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2007-11-13T00:00:00-05:00" pubdate data-updated="true">Nov 13<span>th</span>, 2007</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I recently had to calculate the last day of the month using JavaScript. When I Google&#8217;d for a way to do this (I had an idea for a solution already, but I wanted to look online first), I was pretty surprised by how much work some of the proposed solutions were, like <a href="http://javascript.about.com/library/bllday.htm">this</a> and (even worse) <a href="http://www.irt.org/script/1568.htm">this</a>. One trick I learned from SQL programming is that it doesn&#8217;t need to be that complicated. All you need to do is jump to the next month, go to the first day of that month, then subtract one day. Here&#8217;s the code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">now</span><span class="p">.</span><span class="nx">setMonth</span><span class="p">(</span><span class="nx">now</span><span class="p">.</span><span class="nx">getMonth</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span> <span class="c1">// rounds back to January if needed (e.g., 13th month).</span>
</span><span class='line'><span class="nx">now</span><span class="p">.</span><span class="nx">setDate</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1">// now is now set to the last day of the previous month,</span>
</span><span class='line'>                <span class="c1">// i.e., the &quot;zeroth&quot; day of the current month = the last day of the previous month.</span>
</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2007/10/30/l10n-with-python-in-avant-window/">L10N With Python in Avant Window Navigator Applets</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2007-10-30T00:00:00-04:00" pubdate data-updated="true">Oct 30<span>th</span>, 2007</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a onblur="try {parent.deselectBloggerImageGracefully();} catch(e) {}" href="http://www.dragonflymarsh.com/blog/uploaded_images/file-788164.png"><img style="margin: 0pt 0pt 10px 10px; float: right; cursor: pointer;" src="http://www.dragonflymarsh.com/blog/uploaded_images/file-788161.png" alt="" border="0" /></a>It&#8217;s been a while since I blogged about my latest &#8220;hobby&#8221; (oh, how my wife would cringe), writing Python-based applets for the <a href="http://wiki.awn-project.org/">Avant Window Navigator</a>. I&rsquo;ve been spending a lot of time working on my <a href="http://wiki.awn-project.org/index.php?title=Clock/Calendar_Applet">clock/calendar applet</a> lately, but today I&rsquo;m
going to go back to my <a href="http://wiki.awn-project.org/index.php?title=Weather_Applet">weather applet</a> because it&rsquo;s more interesting to write about.</p>

<p>A while ago, I decided it was time to add some alternate (that is, non-English) language
support to the applet. The de-facto standard tool to accomplish this is the Python variant
of GNU&rsquo;s <a href="http://docs.python.org/lib/module-gettext.html">gettext</a>. I found a couple of resources that helped guide me through this.
The first was the <a href="http://wiki.laptop.org/go/Python_i18n">wiki</a> for the &ldquo;one laptop per child&rdquo; project, which does a lot of
L10N in Python. The second was an excellent <a href="http://http//www.learningpython.com/2006/12/03/translating-your-pythonpygtk-application/">post</a> in the &ldquo;Learning Python&rdquo; blog (the author
doesn&rsquo;t give his/her name in the <a href="http://www.learningpython.com/who-am-i/">Who am I</a> section, otherwise I&rsquo;d give props). And
of course, there&rsquo;s always the official Python <a href="http://docs.python.org/lib/node732.html">library documentation</a>, too.</p>

<p>The first step is to import the gettext libraries into your Python code, and do some setup work, thusly:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">APP</span><span class="o">=</span><span class="s">&quot;&gt;&quot;</span><span class="n">awn</span><span class="o">-</span><span class="n">weather</span><span class="o">-</span><span class="n">applet</span><span class="s">&quot;</span>
</span><span class='line'><span class="n">DIR</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span> <span class="p">(</span><span class="n">__file__</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;/locale&#39;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">locale</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">gettext</span>
</span><span class='line'><span class="n">locale</span><span class="o">.</span><span class="n">setlocale</span><span class="p">(</span><span class="n">locale</span><span class="o">.</span><span class="n">LC_ALL</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">gettext</span><span class="o">.</span><span class="n">bindtextdomain</span><span class="p">(</span><span class="n">APP</span><span class="p">,</span> <span class="n">DIR</span><span class="p">)</span>
</span><span class='line'><span class="n">gettext</span><span class="o">.</span><span class="n">textdomain</span><span class="p">(</span><span class="n">APP</span><span class="p">)</span>
</span><span class='line'><span class="n">_</span> <span class="o">=</span> <span class="n">gettext</span><span class="o">.</span><span class="n">gettext</span>
</span></code></pre></td></tr></table></div></figure>


<p>(Note: Made an edit to the above source code on Nov 16 2007 &#8211; evidently, the
DIR parameter needs the full path to work properly)</p>

<p>Now, here&#8217;s what we&#8217;re actually doing. The call to <span style="font-family:courier new;">bindtextdomain</span> is <span style="font-style: italic;">binding</span> the <span style="font-weight: bold;">awn-weather-applet</span> domain to the <span style="font-weight: bold;">locale</span> subdirectory. When the applet is deployed, it has a locale directory right underneath the main script, weather.py. The directory argument of <span style="font-family:courier new;">bindtextdomain</span> is relative, so we&#8217;re pointing gettext at that directory. We&#8217;re basically telling gettext to look in the locale subdirectory for files named <span class="file"><var>language</var>/LC_MESSAGES/<var></var>awn-weather-applet.mo, where language is the two-letter language code defined by the environment (more on that later).</p>

<p>It should be noted that, customarily, locale files are stored in a default location which is a more global place in the filesystem, e.g. /usr/share/locale/<span style="font-style: italic;">language</span>/LC_MESSAGES. If you don&#8217;t supply a directory to the <span style="font-family:courier new;">bindtextdomain</span> method call, gettext will use the default directory for the system. I opted <span style="font-style: italic;">not</span> to use the default filesystem location because I wanted non-superusers to be able to easily use language files that I supply with the applet, using the standard AWN applet installation mechanism. Requiring the user to put .mo files in the /usr/share directory tree isn&#8217;t an option.</p>

<p>The call to <span style="font-family:courier new;">textdomain</span> sets the global domain to awn-weather-applet. Essentially we&#8217;re telling gettext that all future calls into gettext should use the </span><span class="file">awn-weather-applet domain as its source for translations.</p>

<p>Lastly, the line that reads <span style="font-family:courier new;">_ = gettext.gettext()</span> defines a convenient alias that we will use to identify strings in our code that need translation. If you&#8217;re familiar with i18n of C applications, this will look quite familiar; in the C implementation, an identically named macro is used for the same purpose.</p>

<p>The next step is to read through the code to identify the literal strings that will be translated. Generally, any UI element that a user will see is a candidate for translation. Things like log and console output are not as important. When we find a candidate string, we wrap it in _( ). For example, this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="bp">self</span><span class="o">.</span><span class="n">dialog</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s">&quot;Forecast&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>becomes</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="bp">self</span><span class="o">.</span><span class="n">dialog</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Forecast&quot;</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Because of the alias at the top of the source file, what we&#8217;re <span style="font-style: italic;">really</span> doing is this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="bp">self</span><span class="o">.</span><span class="n">dialog</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">gettext</span><span class="o">.</span><span class="n">gettext</span><span class="p">(</span><span class="s">&quot;Forecast&quot;</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>It&#8217;s a good thing we have the shorthand version!</p>

<p>As I alluded to earlier, gettext does its magic by reading files that ends in an .mo extension. At runtime, it reads
the string that&#8217;s passed into it (in the above example, &#8220;Forecast&#8221;), then looks up that string in
the proper .mo file to see if a translation is available. If it finds an entry, it returns the translated string,
otherwise it just returns the string that was passed into it. So our next task is to create the .mo files.</p>

<p>Creating .mo files is a three step process. First, we need to run a tool that extracts all of the strings to be translated into a usable text file that a translator can edit. The tool to do this is called xgettext. The command line to run looks like this:</p>

<pre><code>xgettext --language=Python --keyword=_ --output=awn-weather-applet.pot *.py&lt;/pre&gt;
</code></pre>

<p>This command generates an output file named awn-weather-applet.pot which acts as a template for translators to do their translation. The file has a bunch of lines that look like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c">#: weather.py:127</span>
</span><span class='line'><span class="n">msgid</span> <span class="s">&quot;Forecast&quot;</span>
</span><span class='line'><span class="n">msgstr</span> <span class="s">&quot;&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>So, let&#8217;s say we want to make a Spanish translation of the weather applet. First, we&#8217;d make
a copy of this file, and name it something sensible like awn-weather-applet.po (note, you can also use
the msginit tool, which does a few other housekeeping things for you like fill in the e-mail address).
We&#8217;d find all the lines that start with msgid, translate it, and put the result in the following
line&#8217;s msgstr, like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c">#: weather.py:127</span>
</span><span class='line'><span class="n">msgid</span> <span class="s">&quot;Forecast&quot;</span>
</span><span class='line'><span class="n">msgstr</span> <span class="s">&quot;Pronstico&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next, we need to &#8220;compile&#8221; the awn-weather-applet.po file into an awn-weather-applet.mo file, so that it&#8217;s usable by gettext at runtime. This is done using the msgfmt command, like this:</p>

<pre><code>msgfmt awn-weather-applet.po -o awn-weather-applet.mo
</code></pre>

<p>That&#8217;s it! Now all you need to do is ensure that the awn-weather-applet.mo file ends up in the (base of weather applet)/locale/es/LC_MESSAGES directory, and Spanish translations work!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2007/10/08/developing-applets-for-awn-drawing-icon/">Developing Applets for AWN: Drawing the Icon</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2007-10-08T00:00:00-04:00" pubdate data-updated="true">Oct 8<span>th</span>, 2007</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>(Continued from previous two posts)<br/>
If you&#8217;re familiar with the Avant Window Navigator, then you know that a fair amount of the project revolves around eye candy and visual effects. Making an applet that is consistent with the user&#8217;s expectations with respect to visual effects (e.g., reflection, bouncing, rotating, etc.) is very important. Fortunately, Neil and Co. have made this quite straightforward. By simply sub-classing the awn.AppletSimple class, your applet will inherit all of the special effects that it should.</p>

<p>Unfortunately, there&#8217;s one small trick you need to work around. If your applet is so simple that it just needs a single, static icon, then sub-classing awn.AppletSimple, followed by a call to set_icon, works great. It gets more difficult if you need to draw dynamic content in the area usually occupied by the icon.</p>

<p>The problem is that set_icon (as well as its misunderstood cousin, set_temp_icon) takes a Pixbuf as its input parameter. However, the drawing framework for doing just about anything, especially loading PNGs, is <a href="http://cairographics.org">cairo</a>. Cairo has no native support for converting a surface to a Pixbuf. I discovered a trick for doing this by looking at the source code for the PyClock and BlingSwitcher applets. Let&#8217;s say you have a Cairo image surface that you&#8217;ve created from an existing PNG, thusly:</p>

<div class="wp_syntax">
  <div class="code">
    <pre class="python" style="font-family:monospace;">cs = cairo.<span style="color: black;">ImageSurface</span>.<span style="color: black;">create_from_png</span><span style="color: black;">&#40;</span>iconName<span style="color: black;">&#41;</span>
ct = cairo.<span style="color: black;">Context</span><span style="color: black;">&#40;</span>cs<span style="color: black;">&#41;</span>
ct.<span style="color: black;">set_source_surface</span><span style="color: black;">&#40;</span>cs<span style="color: black;">&#41;</span>
ct.<span style="color: black;">paint</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span></pre>
  </div>
</div>


<p>&#8230;and you want to get a Pixbuf from that image. The following function takes the surface, writes it to a PNG that is stored in a string, then uses the Pixbuf loader to load it from that PNG string:</p>

<div class="wp_syntax">
  <div class="code">
    <pre class="python" style="font-family:monospace;"><span style="color: #808080; font-style: italic;"># Stolen from diogodivision's "BlingSwitcher"</span>
<span style="color: #ff7700;font-weight:bold;">def</span> get_pixbuf_from_surface<span style="color: black;">&#40;</span><span style="color: #008000;">self</span>, surface<span style="color: black;">&#41;</span>:
  sio = <span style="color: #dc143c;">StringIO</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
  surface.<span style="color: black;">write_to_png</span><span style="color: black;">&#40;</span>sio<span style="color: black;">&#41;</span>
  sio.<span style="color: black;">seek</span><span style="color: black;">&#40;</span><span style="color: #ff4500;"></span><span style="color: black;">&#41;</span>
  loader = gtk.<span style="color: black;">gdk</span>.<span style="color: black;">PixbufLoader</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
  loader.<span style="color: black;">write</span><span style="color: black;">&#40;</span>sio.<span style="color: black;">getvalue</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
  loader.<span style="color: black;">close</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
  <span style="color: #ff7700;font-weight:bold;">return</span> loader.<span style="color: black;">get_pixbuf</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span></pre>
  </div>
</div>


<p>Neat, huh? This is how I manage to display the temperature on the weather applet. I load up the icon into an ImageSurface, write the text on top of it by calling show_text, call the function above to convert the ImageSurface to a PixBuf, then call set_temp_icon using the new PixBuf.</p>

<p>You can see it in action by <a href="http://www.mikedesjardins.us/awn/weather-applet-0.8.tar.gz">downloading the weather applet</a>, and looking in weather.py. The relevant code is in the draw_current_conditions function.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2007/10/04/parsing-xml-with-python-and-minidom/">Parsing XML With Python and Minidom</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2007-10-04T00:00:00-04:00" pubdate data-updated="true">Oct 4<span>th</span>, 2007</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>(Continued from my last post)<br/>
So, the first thing I needed to do when creating my weather applet for Avant Window Navigator was actually parse weather data from a weather source. After messing around with Google&#8217;s weather API for a while, I decided to use <a href="http://xoap.weather.com/">weather.com</a>&#8216;s web service. weather.com has a well-documented, straightforward, predictable XML API. To parse the XML, I chose <a href="http://docs.python.org/lib/module-xml.dom.minidom.html">minidom</a>. Minidom is a &#8220;Lightweight DOM Implementation.&#8221; Here&#8217;s how it works: Let&#8217;s say you have an XML document that supplies a pizza menu, at some URL. Here&#8217;s the XML:</p>

<p><a onblur="try {parent.deselectBloggerImageGracefully();} catch(e) {}" href="http://www.dragonflymarsh.com/blog/uploaded_images/pizza-xml-2-706698.png"><img style="margin: 0px auto 10px; display: block; text-align: center; cursor: pointer;" src="http://www.dragonflymarsh.com/blog/uploaded_images/pizza-xml-2-706697.png" alt="" border="0" /></a>In the python script that will be parsing this, you&#8217;d want to import the minidom package. Let&#8217;s assume that the above XML is served by the URL <a href="http://menu.pizzaplace.us,">http://menu.pizzaplace.us,</a> so you&#8217;ll want to import urllib as well. The python code to read up the XML Document might look like the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">from</span> <span class="nn">xml.dom</span> <span class="kn">import</span> <span class="n">minidom</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">urllib</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">sys</span>
</span><span class='line'><span class="k">try</span><span class="p">:</span>
</span><span class='line'>  <span class="n">usock</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="s">&quot;http://menu.pizzaplace.us&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">xmldoc</span> <span class="o">=</span> <span class="n">minidom</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">usock</span><span class="p">)</span>
</span><span class='line'>  <span class="n">usock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span class='line'><span class="k">except</span><span class="p">:</span>
</span><span class='line'>  <span class="k">print</span> <span class="s">&quot;Something really bad happened! &quot;</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Easy, right? Now we want to get the actual data out of the Pizza Menu. Everything in your DOM tree is a Node. This includes text between element tags. In fact, in minidom, the whitespace between strings of text is a node, too (more on that in a minute!). To fetch nodes, you use the <span style="font-weight: bold;">getElementsByTagName</span> function. This function returns a List of nodes with matching element tag names. Another handy function is <span style="font-weight: bold;">getAttribute</span>. As you might expect, it returns the value for an attribute on a particular element.</p>

<p>Let&#8217;s say we want to iterate through all of the pizzas on the pizza-menu, printing the type of pizza. That code would look like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">from</span> <span class="nn">xml.dom</span> <span class="kn">import</span> <span class="n">minidom</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">urllib</span>
</span><span class='line'><span class="k">try</span><span class="p">:</span>
</span><span class='line'>  <span class="n">usock</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="s">&quot;http://menu.pizzaplace.us&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">xmldoc</span> <span class="o">=</span> <span class="n">minidom</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">usock</span>
</span><span class='line'>  <span class="n">usock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span class='line'>  <span class="n">pizza_list</span> <span class="o">=</span> <span class="n">xmldoc</span><span class="o">.</span><span class="n">getElementsByTagName</span><span class="p">(</span><span class="s">&#39;pizza&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">for</span> <span class="n">pizza_element</span> <span class="ow">in</span> <span class="n">pizza_list</span><span class="p">:</span>
</span><span class='line'>    <span class="n">pizza_type</span> <span class="o">=</span> <span class="n">pizza_element</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span><span class="s">&#39;type&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">print</span> <span class="s">&#39;Pizza Type: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">pizza_type</span>
</span><span class='line'><span class="k">except</span><span class="p">:</span>
</span><span class='line'>  <span class="k">print</span> <span class="s">&quot;Something really bad happened! &quot;</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next, let&#8217;s pretend that &#8220;heart-attack-special&#8221; pizza sounds really appetizing, and we want to estimate just how much our cholesterol count will spike if we have a slice. We probably want to iterate over the toppings on that pizza to perform that evaluation. To that end, we will hunt for the pizza with the type &#8220;heart-attack-special&#8221;, grab that node, then iterate over the topping sub-nodes. Here&#8217;s how we would do that:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">from</span> <span class="nn">xml.dom</span> <span class="kn">import</span> <span class="n">minidom</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">urllib</span>
</span><span class='line'><span class="k">try</span><span class="p">:</span>
</span><span class='line'>  <span class="n">usock</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="s">&quot;http://menu.pizzaplace.us&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">xmldoc</span> <span class="o">=</span> <span class="n">minidom</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">usock</span><span class="p">)</span>
</span><span class='line'>  <span class="n">usock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span class='line'>  <span class="n">pizza_list</span> <span class="o">=</span> <span class="n">xmldoc</span><span class="o">.</span><span class="n">getElementsByTagName</span><span class="p">(</span><span class="s">&quot;pizza&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">for</span> <span class="n">pizza_element</span> <span class="ow">in</span> <span class="n">pizza_list</span><span class="p">:</span>
</span><span class='line'>    <span class="n">pizza_type</span> <span class="o">=</span> <span class="n">pizza_element</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span><span class="s">&quot;type&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">print</span> <span class="s">&#39;Pizza Type: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">pizza_type</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">pizza_type</span> <span class="o">==</span> <span class="s">&#39;heart-attack-special&#39;</span><span class="p">:</span>
</span><span class='line'>      <span class="n">topping_list</span> <span class="o">=</span> <span class="n">pizza_element</span><span class="o">.</span><span class="n">getElementsByName</span><span class="p">(</span><span class="s">&#39;topping&#39;</span><span class="p">)</span>
</span><span class='line'>      <span class="k">for</span> <span class="n">topping_element</span> <span class="ow">in</span> <span class="n">topping_list</span><span class="p">:</span>
</span><span class='line'>        <span class="c"># (do something here)</span>
</span><span class='line'><span class="k">except</span><span class="p">:</span>
</span><span class='line'>  <span class="k">print</span> <span class="s">&quot;Something really bad happened! &quot;</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see, the pizza_element is a node like any other node, so you can call <span style="font-weight: bold;">getElementsByName</span> on it to get any child nodes of this pizza element. The toppings (pepperoni, sausage, hamburg, canadian bacon, and ham) are themselves child nodes of their respective elements. Each node has a nodeType property which describes the nature of that node. The nodeTypes are TEXT_NODE, ELEMENT_NODE, ATTRIBUTE_NODE, and DOCUMENT_NODE. Thus, the word &#8220;pepperoni&#8221; is a child node of the first topping node, and is of type TEXT_NODE.</p>

<p>You might be surprised to learn that the fourth topping node on the heart-attack-special is comprised of <span style="font-style: italic;">three</span> child text nodes. The text &#8220;canadian bacon&#8221; has a child with the value bacon, a child with a single character of whitespace, and a child with the value bacon. This is not usually how we want to access the data in our XML documents; we&#8217;d prefer that &#8220;canadian bacon&#8221; be treated as a single node comprised of one string.</p>

<p>To make the data behave the way we expect it to, we can introduce our own simple utility method called <span style="font-weight: bold;">getText</span>. This function concatenates all child nodes of the supplied node list which are of type TEXT_NODE. It looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">def</span> <span class="nf">getText</span><span class="p">(</span><span class="n">nodelist</span><span class="p">):</span>
</span><span class='line'>  <span class="n">rc</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
</span><span class='line'>  <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodelist</span><span class="p">:</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">nodeType</span> <span class="o">==</span> <span class="n">node</span><span class="o">.</span><span class="n">TEXT_NODE</span><span class="p">:</span>
</span><span class='line'>    <span class="n">rc</span> <span class="o">=</span> <span class="n">rc</span> <span class="o">+</span> <span class="n">node</span><span class="o">.</span><span class="n">data</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">rc</span>
</span></code></pre></td></tr></table></div></figure>


<p>To use it, we&#8217;d pass it the parent node of the text we&#8217;re interested in. Going back to our original example, we can use the getText function to print out each topping on our heart-attack-special pizza:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">from</span> <span class="nn">xml.dom</span> <span class="kn">import</span> <span class="n">minidom</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">urllib</span>
</span><span class='line'><span class="k">try</span><span class="p">:</span>
</span><span class='line'>  <span class="n">usock</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="s">&quot;http://menu.pizzaplace.us&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">xmldoc</span> <span class="o">=</span> <span class="n">minidom</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">usock</span><span class="p">)</span>
</span><span class='line'>  <span class="n">usock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span class='line'>  <span class="n">pizza_list</span> <span class="o">=</span> <span class="n">xmldoc</span><span class="o">.</span><span class="n">getElementsByTagName</span><span class="p">(</span><span class="s">&quot;pizza&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">for</span> <span class="n">pizza_element</span> <span class="ow">in</span> <span class="n">pizza_list</span><span class="p">:</span>
</span><span class='line'>    <span class="n">pizza_type</span> <span class="o">=</span> <span class="n">pizza_element</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span><span class="s">&quot;type&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">print</span> <span class="s">&#39;Pizza Type: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">pizza_type</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">pizza_type</span> <span class="o">==</span> <span class="s">&#39;heart-attack-special&#39;</span><span class="p">:</span>
</span><span class='line'>      <span class="n">topping_list</span> <span class="o">=</span> <span class="n">pizza_element</span><span class="o">.</span><span class="n">getElementsByName</span><span class="p">(</span><span class="s">&#39;topping&#39;</span><span class="p">)</span>
</span><span class='line'>      <span class="k">for</span> <span class="n">topping_element</span> <span class="ow">in</span> <span class="n">topping_list</span><span class="p">:</span>
</span><span class='line'>        <span class="n">topping_text</span> <span class="o">=</span> <span class="n">getText</span><span class="p">(</span><span class="n">topping_element</span><span class="p">)</span>
</span><span class='line'>        <span class="k">print</span> <span class="s">&quot; Topping </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">topping_text</span>
</span><span class='line'><span class="k">except</span><span class="p">:</span>
</span><span class='line'>  <span class="k">print</span> <span class="s">&quot;Something really bad happened! &quot;</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>The XML-parsing portions of the weather applet that I wrote for the Avant Window Navigator aren&#8217;t much more complicated than this. You can download the source code for the weather applet <a href="http://www.dragonflymarsh.com/awn/weather-applet-08.tar.gz">here</a>. The parts which parse weather.com&#8217;s data are in the weather.py script, in the <span style="font-weight: bold;">get_conditions</span> and <span style="font-weight: bold;">get_forecast</span> functions.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/5/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/page/3/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2011/08/23/amazon-ses-ses-verify-email-address-pl-failing-on-osx/">Amazon SES, ses-verify-email-address.pl Failing on OSX</a>
      </li>
    
      <li class="post">
        <a href="/2011/06/28/android-development-the-basics/">Android Development : The Basics</a>
      </li>
    
      <li class="post">
        <a href="/2011/03/18/how-i-debugged-a-jruby-stack-overflow/">How I Debugged a JRuby Stack Overflow</a>
      </li>
    
      <li class="post">
        <a href="/2011/01/23/skicast-pro-now-with-widgets/">Skicast Pro&#8230; Now With Widgets!</a>
      </li>
    
      <li class="post">
        <a href="/2010/10/25/skicast-1-0-released/">Skicast Android Application Released</a>
      </li>
    
  </ul>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Your Name -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
