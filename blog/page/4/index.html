<!DOCTYPE html lang="en">
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Mike Desjardins</title>
  <meta name="author" content="Mike Desjardins">

  
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://mdesjardins.github.io/blog/page/4">
  <link href="/favicon.ico" type="image/x-icon" rel="icon">
  <link href="/favicon.ico" type="image/x-icon" rel="shortcut icon">
  <link href="/atom.xml" rel="alternate" title="Mike Desjardins" type="application/atom+xml">

  <link href='https://fonts.googleapis.com/css?family=Oxygen:400,700,300' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Fenix' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Alegreya+SC:400,700' rel='stylesheet' type='text/css'>

  <link href="/assets/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" type="text/css">
<link href="/assets/bootstrap/dist/css/bootstrap-theme.min.css" rel="stylesheet" type="text/css">
<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">


  <script src="/javascripts/libs/jquery/jquery-2.0.3.min.js"></script>
  

</head>

  <body   >
    <div id="wrap">
      <div class="about-me">
        <div class="pull-right">
          <div class="well">
            <br/>
            <a href="http://about.me/mikedesjardins">about me</a>
            <br/>
            <a href="/resume">resume</a>
          </div>
        </div>
      </div>
      <header role="banner">
        <hgroup>
  <div class="title col-centered">
    <h1><a href="/">Mike Desjardins</a></h1>
  </div>
  <div class="subtitle col-centered">    
    <img class="mike" src="/images/mike.png" width="40" height="40" title="Mike" alt="images">
    <img class="of" src="/images/of-the.png" width="15" height="15" title="of" alt="images">
    <img class="garden" src="/images/gardens.png" width="67" height="67" title="The Gardens" alt="images">
  </div>
</hgroup>


      </header>
      <div id="main" class="container">
        <div id="content">
          <div class="row">
  <div class="page-content col-md-8 col-md-offset-2">
    <div class="blog-index">
      
      
      
        <article class="post" role="article">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        
      </p>
    
    
      <h2 class="entry-title"><a href="/2008/06/01/who-is-running-that-horrible-hibernate/">Who Is Running That Horrible Hibernate Query? Find Out With Comments</a></h2>
    
    












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2008-06-01T00:00:00-04:00" pubdate data-updated="true">Jun 1<span>st</span>, 2008</time>
  </header>


  <div class="entry-content clearfix"><p><span style="font-weight: bold;">The Dreaded Search Function</span><br/>
I&#8217;ve worked at several jobs where the users have asked for a general-purpose search function in their application. It&#8217;s the sort of thing where people want the ability to search on, e.g., all customers with a last name that starts with SM, or all of the customers with a balance greater than 1000.00, etc.</p>

<p>If you can resist the request to build such a thing, <span style="font-style: italic;">then by all means, <span style="font-weight: bold;">don&#8217;t implement it</span></span>. End-users have a knack for creating queries which will bring your database to its knees, no matter how clever you think you are with indexing or UI design.</p>

<p>If you must do it, you&#8217;ll want to keep a close eye on how its used from the outset for when the inevitable nightmare query is run. One way to do this is by using Hibernate&#8217;s comments feature.</p>

<p><span style="font-weight: bold;">Use Comments to Hunt them Down</span><br/>
My colleague <a href="http://mattbrock.net/">Matt Brock</a> implemented something like this where we work. Suppose you have a general method for creating an HQL query in a DAO class, the method could look like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">protected</span> <span class="n">Query</span> <span class="nf">createQuery</span><span class="o">(</span><span class="n">String</span> <span class="n">hql</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'><span class="k">return</span> <span class="nf">getSession</span><span class="o">().</span><span class="na">createQuery</span><span class="o">(</span><span class="n">hql</span><span class="o">).</span><span class="na">setComment</span><span class="o">(</span><span class="n">getUsername</span><span class="o">());</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next, make sure Hibernate&#8217;s SQL logging and comment logging is enabled in your hibernate.hbm.xml (warning &#8211; this log can get pretty huge):</p>

<div class="wp_syntax">
  <div class="code">
    <pre class="xml" style="font-family:monospace;">&nbsp;
true
true
.
.
.</pre>
  </div>
</div>


<p>Your log will now contain the users who are executing each query, like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nl">Hibernate:</span> <span class="o">/</span> <span class="n">johndoe</span> <span class="o">/</span> <span class="n">select</span> <span class="n">customer0</span><span class="o">.</span><span class="na">customer_id</span> <span class="n">as</span> <span class="n">col_0_0</span><span class="o">,</span> <span class="n">customer0</span><span class="o">.</span><span class="na">cust_company_name</span> <span class="n">from</span> <span class="n">CUSTOMER</span> <span class="n">customer0</span> <span class="n">where</span> <span class="o">(</span><span class="n">customer0</span><span class="o">.</span><span class="na">customer_id</span><span class="o">=</span><span class="mi">12136</span> <span class="n">or</span> <span class="n">customer0</span><span class="o">.</span><span class="na">customer_id</span><span class="o">=</span><span class="mi">16884</span> <span class="n">or</span> <span class="n">customer0</span><span class="o">.</span><span class="na">customer_id</span><span class="o">=</span><span class="mi">11150</span> <span class="n">or</span> <span class="n">customer0</span><span class="o">.</span><span class="na">customer_id</span><span class="o">=</span><span class="mi">155</span> <span class="n">or</span> <span class="n">customer0</span><span class="o">.</span><span class="na">customer_id</span>
</span><span class='line'><span class="o">=</span><span class="mi">27265</span> <span class="n">or</span> <span class="n">customer0</span><span class="o">.</span><span class="na">customer_id</span><span class="o">=</span><span class="mi">697</span> <span class="n">or</span> <span class="n">customer0</span><span class="o">.</span><span class="na">customer_id</span><span class="o">=</span><span class="mi">4133</span> <span class="n">or</span> <span class="n">customer0</span><span class="o">.</span><span class="na">customer_id</span><span class="o">=</span><span class="mi">248</span> <span class="n">or</span> <span class="n">customer0</span><span class="o">.</span><span class="na">customer_id</span><span class="o">=</span><span class="mi">2550</span> <span class="n">or</span> <span class="n">customer0</span><span class="o">.</span><span class="na">customer_id</span><span class="o">=</span><span class="mi">8449</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>One caveat: this may not work with stored procedures &#8211; SQL Server, in particular, will get nasty if you try to execute a stored procedure with Hibernate comments attached to it.</p>

<p>Happy Hibernating!</p>
</div>
  
  


        </article>
      
      
        <article class="post" role="article">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        
      </p>
    
    
      <h2 class="entry-title"><a href="/2008/05/01/your-digital-legacy/">Your Digital Legacy</a></h2>
    
    












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2008-05-01T00:00:00-04:00" pubdate data-updated="true">May 1<span>st</span>, 2008</time>
  </header>


  <div class="entry-content clearfix"><p align="center">
<img src="/assets/images/shey-monastery-flame-736542.jpg" alt="Shey Monastery Flame" border="0" />
</p>


<p>I&#8217;m a big fan of Nate Weiner&#8217;s <a href="http://www.ideashower.com/">Idea Shower</a>. He recently wrote a really good <a href="http://www.ideashower.com/blog/what-will-the-web-see-when-you-die/">blog post</a> entitled &#8220;What Will the Web See When You Die?&#8221; In it, he wrote about the death of a snowboarding colleague, and how the traditional media publications cobbled a rather terse biography of the man by copying some of his profile information from a company website. His post was a good read. <a href="http://www.ideashower.com/blog/what-will-the-web-see-when-you-die/">Go read it</a>. Check out his other stuff, too, he&#8217;s brilliant.</p>

<p>Anyway, the story reminded me of one of my former colleagues who committed suicide a few years ago (in fact, I left a comment about it on Nate&#8217;s blog&#8230; most of this post is just an expansion of that comment!). He died several years after we had drifted apart (he had moved out to the west coast, and I moved back up to Maine), so I didn&#8217;t find out about it until months after it happened.
After I found out, the first thing that I did was go to his web site. There he was, smiling at the camera for a blog entry about how his and his girlfriend&#8217;s guacamole dip recipe. I found it rather eerie that his web site stayed up for so long after his death. I found myself re-visiting it days later, perhaps I was half-expecting new content to magically appear. Eventually the site just disappeared into the ether.</p>

<p>At the time I wondered if I should keep a copy of it and host it as sort of a tribute to him, but in the end I decided it was better to let the site go with him; keeping it was like the parents you read about who lose a child and can’t bring themselves to redecorate their room. I doubt he would&#8217;ve wanted that.</p>

<p>In this age of caching pages and leaving parts of yourself scattered over the social web, it’s interesting to think that digital bits of your life will live on long after you die. Our lives are far shorter than the magnetic tapes and spinning disks that prop up the web. In fact, my friend&#8217;s pages are still in the <a href="http://www.archive.org/web/web.php">internet wayback machine</a>, so I didn&#8217;t even need to save them.</p>

<p><span style="font-style: italic;">Photo Credit: </span><a style="font-style: italic;" href="http://flickr.com/people/payalvora/">ReefRaff</a></p>
</div>
  
  


        </article>
      
      
        <article class="post" role="article">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        
      </p>
    
    
      <h2 class="entry-title"><a href="/2008/04/15/the-mobile-webs-death-has-been-greatly/">The Mobile Web&#8217;s Death Has Been Greatly Exaggerated</a></h2>
    
    












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2008-04-15T00:00:00-04:00" pubdate data-updated="true">Apr 15<span>th</span>, 2008</time>
  </header>


  <div class="entry-content clearfix"><p align="center">
<img src="/assets/images/193548748_a8b5293268-712677.jpg" alt="" border="0" />
</p>


<p><a href="http://www.russellbeattie.com/blog/the-end-of-mowser">A recent blog post</a> by Russell Beattie somberly announced the end of his company, <a href="http://www.mowser.com/">Mowser</a>. According to Mowser&#8217;s about page, Mowser &#8220;mobilizes the web by taking HTML pages normally viewed on a PC and adapts them so they work on a mobile phone.&#8221; In his post, Beattie says that &#8220;I don&#8217;t actually believe in the &#8220;Mobile Web&#8221; anymore,&#8221; and from that, some people have extrapolated that Beattie is proclaiming that the Mobile Web is Dead.</p>

<p><span style="font-weight: bold;">But Read What He&#8217;s Actually Saying</span><br/>
If you read further, and ignore the <a href="http://www.readwriteweb.com/archives/is_the_mobile_web_dead.php">provocative headlines</a>, and understand what Beattie is actually saying, he&#8217;s not claiming the Mobile Web is dead at all:</p>

<blockquote><p>&#8220;I think anyone currently developing sites using XHTML-MP markup, no Javascript, geared towards cellular connections and two inch screens are simply wasting their time [&hellip;]&#8220;</p></blockquote>

<p>This is hardly the death of the mobile web (shame on you, <a href="http://www.readwriteweb.com/">ReadWriteWeb</a>!). All that this means is that the rules of the game have changed.</p>

<p><span style="font-weight: bold;">What &#8220;The Mobile Web&#8221; Used to Be</span><br/>
What do people mean when they talk about the Mobile Web? I think the usual context of the question is &#8220;how can we get people to look at our content from their mobile device?&#8221; In the past, simply presenting one&#8217;s content on the mobile web was a challenge. Browser technology was abysmal. CSS and JavaScript were out of the question. &#8220;Adapted&#8221; sites were developed in the crippled WML markup, or other <a href="http://en.wikipedia.org/wiki/Imode">proprietary formats</a>, which made the browsing experience more reminiscent of using <a href="http://en.wikipedia.org/wiki/Gopher_%28protocol%29">Gopher</a> than a <a href="http://www.operamini.com/">real web browser</a>. Services like <a href="http://www.mowser.com/">Mowser</a> and <a href="http://www.skweezer.net/">Skweezer</a> were created to adapt the existing, vibrant content into low-fi versions for phones.</p>

<p><span style="font-weight: bold;">What &#8220;The Mobile Web&#8221; Is</span> <span style="font-weight: bold;">Today</span><br/>
What I took away from Russell Beattie&#8217;s post was that the need for tools like Mowser and Skweezer have been obviated by advances in mobile browser technology. Does this mean that the mobile web is dead? Of course not! And, as far as I can tell, Beattie wasn&#8217;t even claiming that to be the case. Instead, I think the definition of the mobile web is changing.</p>

<p>The internet is comprised of three types of pages (behold my amazing <a href="http://www.omnigroup.com/applications/omnigraffle/pro/">OmniGraffle</a> skills):</p>

<center>
<img src="/assets/images/mobile-web-715956.png" alt="Venn diagram of Desktop and Mobile sites" border="0" />
</center>


<p>There are sites that are intended for viewing on a stationary computer, and sites that are intended for viewing on a mobile device. There is also a huge overlap of pages that work well for both contexts. This is because the barrier of<span style="font-style: italic;"> how to present</span> data on a mobile device, which was initially a barrier, has been mostly overcome.</p>

<p>Examples of using sites in the &#8220;purple zone&#8221; on a mobile device might be
*   Wikipedia &#8211; looking up a bit of trivia when among friends at a coffee shop (got this one from Tichy on <a href="http://news.ycombinator.com/">News.YC</a>&#8230; thanks, Tichy!)
*   IMDB &#8211; looking up who the did the voice in the Pixar film that you just saw with your kids.
*   Google Maps &#8211; Wandering around in Chicago, and you want to know, what the heck is that building?</p>

<p>It&#8217;s perhaps the most difficult to define sites in the &#8220;red&#8221; PC-Only area. I can think of a few:
*   Items requiring intensive keyboard work, like <a href="http://writer.zoho.com/jsp/home.jsp?serviceurl=%2Findex.do">word processing</a> or <a href="http://www.blogger.com/">blogging</a>.
*   Anything involving heavy graphics, such as online games (and pornographic sites? Perhaps I&#8217;m just old-fashioned)
*   Number-crunching or mathematical modelling and simulations.</p>

<p><span style="font-weight: bold;">Where Does This Leave the Mobile Web?</span><br/>
So, what is left in the light blue section? It has to do with context. What does someone with a mobile device look at, that a person browsing from a PC or laptop does not? What makes a mobile device unique? Well, <span style="font-style: italic;">duh</span>, it&#8217;s mobility!</p>

<p>For years people have been prophecizing the coming of Location Based Services. I think that this area has lots of potential. Companies like <a href="https://loopt.com/loopt/sess/index.aspx">Loopt</a> have married social services with location awareness to create a compelling product that started out on Boost and Sprint, and it is supposedly coming to other carriers soon. Similarly, <a href="http://www.meetro.com/">Meetro</a> combines location and Instant Messaging. There are companies who produce audio tours which are location-aware. Fleet management services are exploring the mobile web for business opportunities. It&#8217;s not hard to imagine that the next killer app is waiting to be discovered in this space, making our iPhones indispensible. Mobile devices have now advanced to the point where it&#8217;s Location-Based Services turn to shine.</p>

<p><span style="font-weight: bold;">The New Mobile Web</span><br/>
The key is context. What do people need from the web when they&#8217;re using a mobile device? What do you think?</p>

<p>Graveyard Photo Credit: <a href="http://www.flickr.com/photos/qole/">Qole Pejorian</a></p>
</div>
  
  


        </article>
      
      
        <article class="post" role="article">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        
      </p>
    
    
      <h2 class="entry-title"><a href="/2008/03/31/pizza-shop-iii-jpa-event-listeners/">Pizza Shop III : JPA Event Listeners</a></h2>
    
    












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2008-03-31T00:00:00-04:00" pubdate data-updated="true">Mar 31<span>st</span>, 2008</time>
  </header>


  <div class="entry-content clearfix"><p>This comment was recently posted to one of my blog entries a while back:</p>

<blockquote><p><span class="PostFooter">Let us consider I am adding &#8216;CreatedBy&#8217; and &#8216;ModifiedBy&#8217; columns in all the tables to be used for audit purposes. Ideally these columns would be populated by the user id who has logged into the application. &#8211; @Madhan</span></p></blockquote>

<p align="center">
 <img src="/assets/images/1764153258_11bbbcb337-715955.jpg" alt="Candies with 'Yay Audits!' written on them" border="0" />
</p>


<p>So, let&#8217;s say your data model has some tables with a columns that indicate the last person who touched a record, like Madhan&#8217;s example above. In most applications, the end-users of the database client share a common login to the database, and have individual logins which are specific to the application&#8217;s domain (i.e., you don&#8217;t have a database login mapped to each end user; maintaining this scheme would be a nightmare). For that reason, triggers can&#8217;t be used as a solution, because database triggers don&#8217;t know anything about which application end-user is responsible for making a data change.</p>

<p>The last thing you want to do is litter your codebase with snippets of code that set the username on your persisted objects manually; not only is it unnecessary duplication, but you&#8217;ll probably also end up missing cases where you should be setting the username.</p>

<p><span style="font-weight: bold;">EventListeners to the Rescue</span><br/>
Fortunately, JPA supports the notion of &#8220;EventListeners.&#8221; An event listener intercepts many of the API calls that modify a persisted object&#8217;s lifecycle, and thus may be used to inject business logic that needs to be duplicated over many different objects. AOP aficionados might refer to this as a cross-cutting &#8220;aspect&#8221; of the domain layer.</p>

<p><span style="font-weight: bold;">Return to the Pizza Shop</span><br/>
Readers of my blog (all three of them, including me) might recall my venerable Pizza Shop example. Here are the earlier Pizza Shop posts if you&#8217;d like to catch up: <a href="http://mikedesjardins.us/blog/2008/01/new-jpa-tutorial-pizza-shop.html">Part 1</a> and <a href="http://mikedesjardins.us/blog/2008/03/pizza-shop-2-totaling-jpa-order-use.html">Part 2</a>. I&#8217;m going to drag the Pizza Shop out again to demonstrate how to create an &#8220;audited&#8221; table, which shows the last user who modified a record. As always, the source is available <a href="http://mikedesjardins.us/pizzashop-3.1.tar.gz">here</a>, and it&#8217;s been tested against MySQL, Postgres, and MS SQL Server, with Hibernate, OpenJPA, and TopLink.</p>

<p>This takes just five easy steps&#8230; four, really, &#8216;cuz the fourth step creates a mock object for testing, so it doesn&#8217;t really count!</p>

<p><span style="font-weight: bold;">Step One &#8211; New schema</span><br/>
Add a nullable column named username to the Order table&#8230; something like this should work if you have existing pizzashop schema for some reason:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="k">ORDER</span> <span class="k">ADD</span> <span class="n">username</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p><span style="font-weight: bold;">Step Two &#8211; Create an Interface and Implement It</span><br/>
This step isn&#8217;t strictly necessary, but it&#8217;s probably safe to assume that we&#8217;ll want to add this functionality to other tables someday. The interface just adds accessor methods for the username:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">AuditedObject</span> <span class="o">{</span>
</span><span class='line'>  <span class="kd">public</span> <span class="n">String</span> <span class="nf">getUsername</span><span class="o">();</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setUsername</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then, make the Order table implement AuditedObject. Add a member variable with a mapping to the username column to the Order table, and corresponding accessor methods:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Order</span> <span class="kd">implements</span> <span class="n">IdObject</span><span class="o">,</span> <span class="n">AuditedObject</span> <span class="o">{</span>
</span><span class='line'><span class="o">.</span>
</span><span class='line'><span class="o">.</span>
</span><span class='line'>  <span class="nd">@Basic</span> <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;username&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">String</span> <span class="n">username</span><span class="o">;</span>
</span><span class='line'><span class="o">.</span>
</span><span class='line'><span class="o">.</span>
</span><span class='line'>  <span class="kd">public</span> <span class="n">String</span> <span class="nf">getUsername</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">username</span><span class="o">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setUsername</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">this</span><span class="o">.</span><span class="na">username</span> <span class="o">=</span> <span class="n">username</span><span class="o">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">.</span>
</span><span class='line'><span class="o">.</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><span style="font-weight: bold;">Step Three &#8211; Add an EntityListener Annotation</span><br/>
This is the secret sauce. In the JPA Framework, EventListeners allow you to fire some trigger code when a lifecycle event occurs on a persisted object. You do this by associating your persisted class with an EventListener class. We&#8217;ll implement our EventListener class after we&#8217;ve added the following annotations:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Entity</span> <span class="nd">@Table</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;PIZZA_ORDER&quot;</span><span class="o">)</span>
</span><span class='line'><span class="nd">@EntityListeners</span><span class="o">(</span><span class="n">AuditedEntityListener</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Order</span> <span class="kd">implements</span> <span class="n">IdObject</span><span class="o">,</span> <span class="n">AuditedObject</span> <span class="o">{</span>
</span><span class='line'><span class="o">.</span>
</span><span class='line'><span class="o">.</span>
</span></code></pre></td></tr></table></div></figure>


<p><span style="font-weight: bold;">Step Four &#8211; Write a Mock Object for the Username for Testing</span><br/>
In the real world, you&#8217;d probably stuff the username into the servlet context object. For our simple tests, we&#8217;ll need to mock up an object to maintain a username for the duration of our tests. It can be something stupidly simple, like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MockContext</span> <span class="o">{</span>
</span><span class='line'>  <span class="kd">private</span> <span class="kd">static</span> <span class="n">String</span> <span class="n">username</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">getUsername</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">username</span><span class="o">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">setUsername</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">MockContext</span><span class="o">.</span><span class="na">username</span> <span class="o">=</span> <span class="n">username</span><span class="o">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We&#8217;ll set the username at the start of our tests, and read the username from our MockContext from the EventListener.</p>

<p><span style="font-weight: bold;">Step Five &#8211; Write the EntityListener class</span><br/>
JPA allows you to inercept method calls using seven annotations:
*   @PrePersist and @PostPersist are called before and after an object is persisted.
*   @PreUpdate and @PostUpdate are called before and after synchronization with the database. @PreRemove and @PostRemove are called before and after an object is removed from the persistent state.
*   @PostLoad is invoked immediately after an object is loaded from the database.</p>

<p>In our case, we&#8217;re going to populate the username instance variable when the object is persisted, so we will want to create an EntityListener class with the @PrePersist annotation. The method&#8217;s signature takes an Object parameter which is the object getting updated, and returns void. The class will look something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AuditedEntityListener</span> <span class="o">{</span>
</span><span class='line'>  <span class="nd">@PrePersist</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">updateUser</span><span class="o">(</span><span class="n">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="o">(</span><span class="n">o</span> <span class="k">instanceof</span> <span class="n">AuditedObject</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">String</span> <span class="n">username</span> <span class="o">=</span> <span class="n">MockContext</span><span class="o">.</span><span class="na">getUsername</span><span class="o">();</span>
</span><span class='line'>        <span class="o">((</span><span class="n">AuditedObject</span><span class="o">)</span><span class="n">o</span><span class="o">).</span><span class="na">setUsername</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><span style="font-style: italic;">Voila</span>! When you run the tests, the username fields are populated and persisted!</p>

<p>Audit M&amp;M&#8217;s Photo Courtesy <a href="http://josephhall.org">Joe Hall</a>.</p>
</div>
  
  


        </article>
      
      
        <article class="post" role="article">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        
      </p>
    
    
      <h2 class="entry-title"><a href="/2008/03/13/using-javamail-to-read-and-extract/">Using JavaMail to Read and Extract Attachments</a></h2>
    
    












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2008-03-13T00:00:00-04:00" pubdate data-updated="true">Mar 13<span>th</span>, 2008</time>
  </header>


  <div class="entry-content clearfix"><p>Recently I had to create a JavaMail-based e-mail client that polled an IMAP server for incoming e-mail messages. The client needed to read each message, find any attachments, and save those attachments to a directory on the application server. I had never had a need to do this with the JavaMail API before, so I did the first thing that many developers do when they&#8217;re venturing into unknown territory, and Google&#8217;d for an example. I found lots of examples of sending attachments, but not many of receiving them. The few examples that I did find of receiving mail with the JavaMail API were too simple. So I had to figure out how to do it by (gasp) reading the documentation. Fortunately, it wasn&#8217;t very difficult, but I thought I&#8217;d share it for the next programmer that turns to Google for a solution.</p>

<p>In my application, I used the <a href="http://www.opensymphony.com/quartz/">Quartz</a> library to periodically call a method named <span style="font-weight: bold;">receive</span>, which does the grunt work of pulling stuff off the server. This code is similar to other examples you might find out there Google&#8217;ing, and it&#8217;s pretty mundane stuff. The MailReceiveException is a catch-all Exception class that I wrote:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="n">Message</span><span class="o">[]</span> <span class="nf">receive</span><span class="o">(</span><span class="n">String</span> <span class="n">server</span><span class="o">,</span> <span class="n">String</span> <span class="n">user</span><span class="o">,</span>
</span><span class='line'>                         <span class="n">String</span> <span class="n">password</span><span class="o">,</span> <span class="n">String</span> <span class="n">directory</span><span class="o">)</span>
</span><span class='line'>                 <span class="kd">throws</span> <span class="n">MailReceiveException</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">Message</span><span class="o">[]</span> <span class="n">msgs</span><span class="o">;</span>
</span><span class='line'>  <span class="n">Store</span> <span class="n">store</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>  <span class="n">Folder</span> <span class="n">folder</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>  <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">store</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">getStore</span><span class="o">(</span><span class="s">&quot;imap&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="n">store</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="n">server</span><span class="o">,</span> <span class="n">user</span><span class="o">,</span> <span class="n">password</span><span class="o">);</span>
</span><span class='line'>    <span class="n">folder</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="na">getDefaultFolder</span><span class="o">();</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">folder</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">throw</span> <span class="k">new</span> <span class="nf">MailReceiveException</span><span class="o">(</span><span class="s">&quot;No default folder&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="n">folder</span> <span class="o">=</span> <span class="n">folder</span><span class="o">.</span><span class="na">getFolder</span><span class="o">(</span><span class="s">&quot;INBOX&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">folder</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">throw</span> <span class="k">new</span> <span class="nf">MailReceiveException</span><span class="o">(</span><span class="s">&quot;No IMAP INBOX&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="n">folder</span><span class="o">.</span><span class="na">open</span><span class="o">(</span><span class="n">Folder</span><span class="o">.</span><span class="na">READ_WRITE</span><span class="o">);</span>
</span><span class='line'>    <span class="n">msgs</span> <span class="o">=</span> <span class="n">folder</span><span class="o">.</span><span class="na">getMessages</span><span class="o">();</span>
</span><span class='line'>    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">msgs</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="o">++</span><span class="n">i</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">Message</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">msgs</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
</span><span class='line'>      <span class="c1">// don&#39;t fetch messages that we&#39;ve already processed</span>
</span><span class='line'>      <span class="k">if</span> <span class="o">(!</span><span class="n">msg</span><span class="o">.</span><span class="na">isSet</span><span class="o">(</span><span class="n">Flags</span><span class="o">.</span><span class="na">Flag</span><span class="o">.</span><span class="na">SEEN</span><span class="o">))</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">String</span> <span class="n">from</span> <span class="o">=</span> <span class="s">&quot;unknown&quot;</span><span class="o">;</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">getReplyTo</span><span class="o">().</span><span class="na">length</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>          <span class="n">from</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="na">getReplyTo</span><span class="o">()[].</span><span class="na">toString</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">getFrom</span><span class="o">().</span><span class="na">length</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>          <span class="n">from</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="na">getFrom</span><span class="o">()[].</span><span class="na">toString</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="n">String</span> <span class="n">subject</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="na">getSubject</span><span class="o">();</span>
</span><span class='line'>        <span class="n">String</span> <span class="n">filename</span> <span class="o">=</span> <span class="n">directory</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="n">from</span> <span class="o">+</span> <span class="s">&quot;: &quot;</span> <span class="o">+</span> <span class="n">subject</span><span class="o">;</span>
</span><span class='line'>        <span class="c1">// This is where the real work will get done.</span>
</span><span class='line'>        <span class="k">this</span><span class="o">.</span><span class="na">saveParts</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">getContent</span><span class="o">(),</span> <span class="n">filename</span><span class="o">);</span>
</span><span class='line'>        <span class="n">msg</span><span class="o">.</span><span class="na">setFlag</span><span class="o">(</span><span class="n">Flags</span><span class="o">.</span><span class="na">Flag</span><span class="o">.</span><span class="na">SEEN</span><span class="o">,</span><span class="kc">true</span><span class="o">);</span>
</span><span class='line'>      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>        <span class="c1">// Delete anything that is more than sixty days old.</span>
</span><span class='line'>        <span class="n">Date</span> <span class="n">receivedOn</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="na">getReceivedDate</span><span class="o">();</span>
</span><span class='line'>        <span class="n">GregorianCalendar</span> <span class="n">cal</span> <span class="o">=</span> <span class="k">new</span> <span class="n">GregorianCalendar</span><span class="o">();</span>
</span><span class='line'>        <span class="n">cal</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">GregorianCalendar</span><span class="o">.</span><span class="na">DATE</span><span class="o">,-</span><span class="mi">60</span><span class="o">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">receivedOn</span><span class="o">.</span><span class="na">before</span><span class="o">(</span><span class="n">cal</span><span class="o">.</span><span class="na">getTime</span><span class="o">()))</span> <span class="o">{</span>
</span><span class='line'>          <span class="n">msg</span><span class="o">.</span><span class="na">setFlag</span><span class="o">(</span><span class="n">Flags</span><span class="o">.</span><span class="na">Flag</span><span class="o">.</span><span class="na">DELETED</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Rats&#39; nest of catch blocks omitted... make sure you close</span>
</span><span class='line'>    <span class="c1">// the folder and the mail store in a finally block, as well</span>
</span><span class='line'>    <span class="c1">// as expunge any messages that have been marked for deletion.</span>
</span><span class='line'>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">msgs</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>There&#8217;s one small detail that I had to learn the hard way, and that is that the &#8220;Parts&#8221; within Multipart MIME messages can themselves contain other Parts. So you have a nifty opportunity to use some of that fancy recursion stuff that you learned about in your &#8220;Intro to Programming&#8221; course!</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">saveParts</span><span class="o">(</span><span class="n">Object</span> <span class="n">content</span><span class="o">,</span>
</span><span class='line'>                       <span class="n">String</span> <span class="n">filename</span><span class="o">)</span>
</span><span class='line'>             <span class="kd">throws</span> <span class="n">MailReceiveException</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">OutputStream</span> <span class="n">out</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>  <span class="n">InputStream</span> <span class="n">in</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>  <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">content</span> <span class="k">instanceof</span> <span class="n">Multipart</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">Multipart</span> <span class="n">multi</span> <span class="o">=</span> <span class="o">((</span><span class="n">Multipart</span><span class="o">)</span><span class="n">content</span><span class="o">);</span>
</span><span class='line'>      <span class="kt">int</span> <span class="n">parts</span> <span class="o">=</span> <span class="n">multi</span><span class="o">.</span><span class="na">getCount</span><span class="o">();</span>
</span><span class='line'>      <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span><span class="o">=;</span> <span class="n">j</span><span class="o">&lt;</span><span class="n">parts</span><span class="o">;</span> <span class="o">++</span><span class="n">j</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">MimeBodyPart</span> <span class="n">part</span> <span class="o">=</span> <span class="o">(</span><span class="n">MimeBodyPart</span><span class="o">)</span><span class="n">multi</span><span class="o">.</span><span class="na">getBodyPart</span><span class="o">(</span><span class="n">j</span><span class="o">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">part</span><span class="o">.</span><span class="na">getContent</span><span class="o">()</span> <span class="k">instanceof</span> <span class="n">Multipart</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>          <span class="c1">// part-within-a-part, do some recursion...</span>
</span><span class='line'>          <span class="k">this</span><span class="o">.</span><span class="na">saveParts</span><span class="o">(</span><span class="n">part</span><span class="o">.</span><span class="na">getContent</span><span class="o">(),</span> <span class="n">filename</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>          <span class="n">String</span> <span class="n">type</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="na">getContentType</span><span class="o">();</span>
</span><span class='line'>          <span class="n">String</span> <span class="n">extension</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="o">;</span>
</span><span class='line'>          <span class="k">if</span> <span class="o">(</span><span class="n">part</span><span class="o">.</span><span class="na">isMimeType</span><span class="o">(</span><span class="s">&quot;text/html&quot;</span><span class="o">))</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">extension</span> <span class="o">=</span> <span class="s">&quot;html&quot;</span><span class="o">;</span>
</span><span class='line'>          <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="o">(</span><span class="n">part</span><span class="o">.</span><span class="na">isMimeType</span><span class="o">(</span><span class="s">&quot;text/plain&quot;</span><span class="o">))</span> <span class="o">{</span>
</span><span class='line'>              <span class="n">extension</span> <span class="o">=</span> <span class="s">&quot;txt&quot;</span><span class="o">;</span>
</span><span class='line'>            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>              <span class="c1">// Try to make a reasonable guess about the</span>
</span><span class='line'>              <span class="c1">// extension from the MIME type.</span>
</span><span class='line'>              <span class="kt">int</span> <span class="n">end</span> <span class="o">=</span> <span class="n">type</span><span class="o">.</span><span class="na">indexOf</span><span class="o">(</span><span class="sc">&#39;;&#39;</span><span class="o">);</span>
</span><span class='line'>              <span class="k">if</span> <span class="o">(</span><span class="n">end</span> <span class="o">&lt;</span> <span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">end</span> <span class="o">=</span> <span class="n">type</span><span class="o">.</span><span class="na">length</span><span class="o">();</span>
</span><span class='line'>              <span class="o">}</span>
</span><span class='line'>              <span class="n">extension</span> <span class="o">=</span> <span class="n">type</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">type</span><span class="o">.</span><span class="na">indexOf</span><span class="o">(</span><span class="sc">&#39;/&#39;</span><span class="o">)+</span><span class="mi">1</span><span class="o">,</span><span class="n">end</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>            <span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span> <span class="o">+</span> <span class="s">&quot;.&quot;</span> <span class="o">+</span> <span class="n">extension</span><span class="o">;</span>
</span><span class='line'>            <span class="n">out</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileOutputStream</span><span class="o">(</span><span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">filename</span><span class="o">));</span>
</span><span class='line'>            <span class="n">in</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">();</span>
</span><span class='line'>            <span class="kt">int</span> <span class="n">k</span><span class="o">;</span>
</span><span class='line'>            <span class="k">while</span> <span class="o">((</span><span class="n">k</span> <span class="o">=</span> <span class="n">in</span><span class="o">.</span><span class="na">read</span><span class="o">())</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>              <span class="n">out</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">k</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>          <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">MessagingException</span> <span class="n">e1</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">&quot;Messaging Exception&quot;</span><span class="o">,</span> <span class="n">e1</span><span class="o">);</span>
</span><span class='line'>    <span class="k">throw</span> <span class="k">new</span> <span class="nf">MailReceiveException</span><span class="o">(</span><span class="s">&quot;Error fetching e-mail&quot;</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e2</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">&quot;Caught IOException reading e-mail.&quot;</span><span class="o">,</span> <span class="n">e2</span><span class="o">);</span>
</span><span class='line'>    <span class="k">throw</span> <span class="k">new</span> <span class="nf">MailReceiveException</span><span class="o">(</span><span class="s">&quot;Error fetching e-mail&quot;</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">in</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">in</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
</span><span class='line'>      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e6</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">&quot;Unable to close input stream&quot;</span><span class="o">);</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">out</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">out</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
</span><span class='line'>        <span class="n">out</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
</span><span class='line'>      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e7</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">&quot;Unable to close output stream.&quot;</span><span class="o">);</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>All of this work was done using JavaMail 1.3. I believe newer versions of the API have a <span style="font-weight: bold;">savePart</span> method, so you don&#8217;t need to write out the parts to a FileOutputStream byte-by-byte as I have above.</p>
</div>
  
  


        </article>
      
      
        <article class="post" role="article">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        
      </p>
    
    
      <h2 class="entry-title"><a href="/2008/03/04/pizza-shop-2-totaling-the-jpa-order-use/">Pizza Shop 2: Totaling the JPA Order, Use P6Spy to Prevent Stupidity</a></h2>
    
    












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2008-03-04T00:00:00-05:00" pubdate data-updated="true">Mar 4<span>th</span>, 2008</time>
  </header>


  <div class="entry-content clearfix"><p>I&#8217;m digging up the original Pizza Shop project to illustrate another Hibernate gotcha (it&#8217;s probably applicable to other ORM libraries as well&#8230; admittedly, I haven&#8217;t tested it). If you didn&#8217;t read the original Pizza Shop post, you can find it <a href="http://blog.mikedesjardins.us/2008/01/new-jpa-tutorial-pizza-shop.html">here</a>. To review, here is an ERD for the system:</p>

<center>
<img alt="" src="/assets/images/pizza-erd-737227.jpg" border="0" />
</center>


<p>Today I&#8217;d like to show how <i>not</i> to total up the cost of the customer order. First, we are going to add <a href="http://www.p6spy.com/">P6Spy</a> to the project. P6Spy is an excellent &#8220;JDBC wrapper&#8221; tool that sits between your application code and your actual JDBC driver. It intercepts your application&#8217;s JDBC requests and logs the results. It&#8217;s an invaluable tool for optimizing the voodoo out of an ORM tool, and the great thing is that it&#8217;s simple to setup:</p>

<p>1.) Change your application&#8217;s JDBC driver from whatever it currently is (e.g., org.postgresql.Driver), to the P6Spy JDBC driver, com.p6spy.engine.spy.P6SpyDriver.<br/>
2.) Modify the spy.properties file by editing the line that starts with &#8220;realdriver=&#8221;, changing the value to your actual JDBC driver.<br/>
3.) Put spy.properties on your classpath.</p>

<p>That&#8217;s it! Now that we have that out of the way, let&#8217;s see just how badly we can screw up a simple method in our Model class. The method we are going to add will total up the price of an order. If you look at the ERD above, you can infer that the total cost of an order is the sum of the base price for each pizza, depending on its size, plus the price of each pizza&#8217;s individual toppings.</p>

<p>So for our example order, let&#8217;s say we have the following:<br/>
1 Small Pizza with Pepperoni and Mushroom<br/>
1 Medium Pizza with Sausage and Onions<br/>
1 Large Pizza with Extra Cheese</p>

<p>You&#8217;ll recall that we created a Model class which provides a method for retrieving a List of Pizza objects that are associated with an order ID. The temptation is to create a method which looks something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="n">BigDecimal</span> <span class="nf">getOrderPriceWrong</span><span class="o">(</span><span class="n">Integer</span> <span class="n">orderId</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">BigDecimal</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BigDecimal</span><span class="o">(</span><span class="mf">0.0</span><span class="o">);</span>
</span><span class='line'>  <span class="n">Order</span> <span class="n">order</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">getOrder</span><span class="o">(</span><span class="n">orderId</span><span class="o">);</span>
</span><span class='line'>  <span class="k">for</span> <span class="o">(</span><span class="n">Pizza</span> <span class="n">pizza</span> <span class="o">:</span> <span class="n">order</span><span class="o">.</span><span class="na">getPizzas</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">result</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">pizza</span><span class="o">.</span><span class="na">getSize</span><span class="o">().</span><span class="na">getBasePrice</span><span class="o">());</span>
</span><span class='line'>    <span class="k">for</span> <span class="o">(</span><span class="n">Topping</span> <span class="n">topping</span> <span class="o">:</span> <span class="n">pizza</span><span class="o">.</span><span class="na">getToppings</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">result</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">topping</span><span class="o">.</span><span class="na">getPrice</span><span class="o">());</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Because Hibernate does lazy-fetching, it&#8217;s not going to attempt to calculate the total cost with as few queries as possible. Instead, Hibernate&#8217;s general philosophy is to defer any queries until it knows that it absolutely needs to do them, substituting empty proxy objects for populated ones until required. Usually this is an optimization, but in this case, Hibernate will do the following queries:</p>

<p>1.) Query to obtain an order object.<br/>
2.) One Query for each Pizza, joined to the Size, to obtain the base price.<br/>
3.) One Query per Topping, to obtain the topping price.</p>

<p>In all, we get nine individual SQL queries to compute the total price of our single fictional order. The proof is in the P6Spy&#8217;s output, spy.log, truncated below:</p>

<pre><code>select order0_.pizza_order_id as pizza1_2_, order0_.version ...
select pizzas0_.pizza_order_id as pizza4_2_, pizzas0_.pizza_id ...
select pizzas0_.pizza_order_id as pizza4_2_, pizzas0_.pizza_id ...
select pizzas0_.pizza_order_id as pizza4_2_, pizzas0_.pizza_id ...
select toppings0_.pizza_id as pizza1_1_, toppings0_.topping_id ...
select toppings0_.pizza_id as pizza1_1_, toppings0_.topping_id ...
select toppings0_.pizza_id as pizza1_1_, toppings0_.topping_id ...
select toppings0_.pizza_id as pizza1_1_, toppings0_.topping_id ...
select toppings0_.pizza_id as pizza1_1_, toppings0_.topping_id ...
</code></pre>

<p>If your application is totaling up the price of Pizza orders all day, this can really add up! An alternative approach is to use two named queries to compute the total base price, and total topping price, for an order. For example, we might add the following annotation to the Pizza class:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@NamedQueries</span><span class="o">(</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'><span class="nd">@NamedQuery</span><span class="o">(</span>
</span><span class='line'> <span class="n">name</span><span class="o">=</span><span class="s">&quot;basePrice&quot;</span><span class="o">,</span>
</span><span class='line'> <span class="n">query</span><span class="o">=</span><span class="s">&quot;select SUM(p.size.basePrice) &quot;</span> <span class="o">+</span>
</span><span class='line'>       <span class="s">&quot;  from Pizza p &quot;</span> <span class="o">+</span>
</span><span class='line'>       <span class="s">&quot; where p.order.id = :orderId&quot;</span><span class="o">),</span>
</span><span class='line'><span class="nd">@NamedQuery</span><span class="o">(</span>
</span><span class='line'> <span class="n">name</span><span class="o">=</span><span class="s">&quot;toppingPrice&quot;</span><span class="o">,</span>
</span><span class='line'> <span class="n">query</span><span class="o">=</span><span class="s">&quot;select SUM(topping.price) &quot;</span> <span class="o">+</span>
</span><span class='line'>       <span class="s">&quot;  from Pizza p join p.toppings as topping &quot;</span> <span class="o">+</span>
</span><span class='line'>       <span class="s">&quot; where p.order.id = :orderId&quot;</span><span class="o">)</span>
</span><span class='line'><span class="o">})</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then, you could add the following methods to the OrderDao:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="n">BigDecimal</span> <span class="nf">nullGuard</span><span class="o">(</span><span class="n">Query</span> <span class="n">query</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">BigDecimal</span> <span class="n">result</span> <span class="o">=</span> <span class="o">(</span><span class="n">BigDecimal</span><span class="o">)</span><span class="n">query</span><span class="o">.</span><span class="na">getSingleResult</span><span class="o">();</span>
</span><span class='line'>  <span class="k">return</span> <span class="o">(</span><span class="n">result</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="k">new</span> <span class="n">BigDecimal</span><span class="o">()</span> <span class="o">:</span> <span class="n">result</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="n">BigDecimal</span> <span class="nf">getOrderPrice</span><span class="o">(</span><span class="n">Integer</span> <span class="n">orderId</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">Query</span> <span class="n">query1</span> <span class="o">=</span> <span class="n">getEntityManager</span><span class="o">().</span><span class="na">createNamedQuery</span><span class="o">(</span><span class="s">&quot;basePrice&quot;</span><span class="o">);</span>
</span><span class='line'>  <span class="n">query1</span><span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="s">&quot;orderId&quot;</span><span class="o">,</span><span class="n">orderId</span><span class="o">);</span>
</span><span class='line'>  <span class="n">Query</span> <span class="n">query2</span> <span class="o">=</span> <span class="n">getEntityManager</span><span class="o">().</span><span class="na">createNamedQuery</span><span class="o">(</span><span class="s">&quot;toppingPrice&quot;</span><span class="o">);</span>
</span><span class='line'>  <span class="n">query2</span><span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="s">&quot;orderId&quot;</span><span class="o">,</span> <span class="n">orderId</span><span class="o">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="nf">nullGuard</span><span class="o">(</span><span class="n">query1</span><span class="o">).</span><span class="na">add</span><span class="o">(</span><span class="n">nullGuard</span><span class="o">(</span><span class="n">query2</span><span class="o">));</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>&#8230;and call into the DAO from the Model class, thusly:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="n">BigDecimal</span> <span class="nf">getOrderPriceRight</span><span class="o">(</span><span class="n">Integer</span> <span class="n">orderId</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">orderDao</span><span class="o">.</span><span class="na">getOrderPrice</span><span class="o">(</span><span class="n">orderId</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>When we run the P6Spy test now, we see a meager two queries where we used to have nine:</p>

<pre><code>select SUM(size1_.pizza_size_base_price) as col_0_0_ from PIZZA ...
select SUM(topping2_.topping_price) as col_0_0_ from PIZZA ...
</code></pre>

<p>It pays to periodically use a tool like P6Spy on your application, to look for easy wins like this one!</p>

<p>I&#8217;ve included a complete working eclipse project that demonstrates this&#8230; it&#8217;s actually a tweaked version of the earlier Pizza Shop project. You can get it <a href="http://www.mikedesjardins.us/pizzashop-2.0.tar.gz">here</a>.</p>
</div>
  
  


        </article>
      
      
        <article class="post" role="article">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        
      </p>
    
    
      <h2 class="entry-title"><a href="/2008/02/18/enumerated-types-with-jpa-and-your-sock/">Enumerated Types With JPA, and Your Sock Drawer</a></h2>
    
    












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2008-02-18T00:00:00-05:00" pubdate data-updated="true">Feb 18<span>th</span>, 2008</time>
  </header>


  <div class="entry-content clearfix"><center>
<img src="/assets/images/sockdrawer-773596.jpg" alt="" border="0" />
</center>


<p>One feature of JPA that didn&#8217;t exist in plain-vanilla Hibernate is support for Enumerated types. I haven&#8217;t seen a lot of examples of this in practice or on the internet, so in this post I&#8217;ll show one example of how to use JDK 5 enumerations with JPA.</p>

<p>For our example, we are going to create an inventory system for our sock drawer. It is comprised of only two tables. The first table, called SOCK, contains one row per sock in our drawer. The columns of the table are:</p>

<ul>
<li>sock_id &#8211; an auto-incrementing identity column.</li>
<li>sock_description &#8211; a varchar column for a free-form text description of the sock.</li>
<li>sock_pattern_id &#8211; a reference to a row in the SOCK_PATTERN table.</li>
</ul>


<p>As you may have guessed, the SOCK_PATTERN table looks like this:
*   sock_pattern_id &#8211; an integer primary key. It&#8217;s not auto-incrementing, because we will want to have control over the contents of the field.
*   sock_pattern_description &#8211; a varchar column for a free-form text description of the pattern.</p>

<p>We need to &#8220;prime&#8221; our SOCK_PATTERN table with the valid patterns and create a foreign key relationship between the two tables:</p>

<pre><code>INSERT INTO SOCK_PATTERN (sock_pattern_id,sock_pattern_description) VALUES (,'SOLID');
INSERT INTO SOCK_PATTERN (sock_pattern_id,sock_pattern_description) VALUES (1,'STRIPES');
INSERT INTO SOCK_PATTERN (sock_pattern_id,sock_pattern_description) VALUES (2,'POLKA_DOT');
INSERT INTO SOCK_PATTERN (sock_pattern_id,sock_pattern_description) VALUES (3,'ARGYLE');
</code></pre>

<p>Note that we populated sock_pattern_id starting with zero; this is important because the Enumeration below is zero-indexed.</p>

<p>Next, let&#8217;s create the classes:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">enum</span> <span class="n">SockPattern</span> <span class="o">{</span>
</span><span class='line'> <span class="n">SOLID</span><span class="o">,</span> <span class="n">STRIPES</span><span class="o">,</span> <span class="n">POLKA_DOT</span><span class="o">,</span> <span class="n">ARGYLE</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@Entity</span> <span class="nd">@Table</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;SOCK&quot;</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Sock</span> <span class="o">{</span>
</span><span class='line'> <span class="nd">@Id</span> <span class="nd">@GeneratedValue</span><span class="o">(</span><span class="n">strategy</span><span class="o">=</span><span class="n">GenerationType</span><span class="o">.</span><span class="na">IDENTITY</span><span class="o">)</span>
</span><span class='line'> <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;sock_id&quot;</span><span class="o">)</span>
</span><span class='line'> <span class="kd">private</span> <span class="n">Integer</span> <span class="n">id</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'> <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;sock_description&quot;</span><span class="o">)</span>
</span><span class='line'> <span class="kd">private</span> <span class="n">String</span> <span class="n">description</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'> <span class="nd">@Enumerated</span> <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;sock_pattern_id&quot;</span><span class="o">)</span>
</span><span class='line'> <span class="kd">private</span> <span class="n">SockPattern</span> <span class="n">pattern</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'> <span class="kd">public</span> <span class="n">Integer</span> <span class="nf">getId</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">id</span><span class="o">;</span> <span class="o">}</span>
</span><span class='line'> <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setId</span><span class="o">(</span><span class="n">Integer</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span> <span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span> <span class="o">}</span>
</span><span class='line'>
</span><span class='line'> <span class="kd">public</span> <span class="n">String</span> <span class="nf">getDescription</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">description</span><span class="o">;</span> <span class="o">}</span>
</span><span class='line'> <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setDescription</span><span class="o">(</span><span class="n">String</span> <span class="n">description</span><span class="o">)</span> <span class="o">{</span> <span class="k">this</span><span class="o">.</span><span class="na">description</span> <span class="o">=</span> <span class="n">description</span><span class="o">;</span> <span class="o">}</span>
</span><span class='line'>
</span><span class='line'> <span class="kd">public</span> <span class="n">SockPattern</span> <span class="nf">getPattern</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">pattern</span><span class="o">;</span> <span class="o">}</span>
</span><span class='line'> <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setPattern</span><span class="o">(</span><span class="n">SockPattern</span> <span class="n">pattern</span><span class="o">)</span> <span class="o">{</span> <span class="k">this</span><span class="o">.</span><span class="na">pattern</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">;</span> <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now, to use our wonderful contraption, you&#8217;d do something like the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Demo</span> <span class="o">{</span>
</span><span class='line'> <span class="kd">private</span> <span class="kd">static</span> <span class="n">EntityManagerFactory</span> <span class="n">emf</span><span class="o">;</span>
</span><span class='line'> <span class="kd">static</span> <span class="o">{</span>
</span><span class='line'>     <span class="n">Demo</span><span class="o">.</span><span class="na">emf</span> <span class="o">=</span> <span class="n">Persistence</span><span class="o">.</span><span class="na">createEntityManagerFactory</span><span class="o">(</span><span class="s">&quot;sockdrawer&quot;</span><span class="o">);</span>
</span><span class='line'> <span class="o">}</span>
</span><span class='line'>
</span><span class='line'> <span class="nd">@Test</span>
</span><span class='line'> <span class="kd">public</span> <span class="kt">void</span> <span class="nf">socksOne</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>     <span class="n">Sock</span> <span class="n">sock</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Sock</span><span class="o">();</span>
</span><span class='line'>     <span class="n">sock</span><span class="o">.</span><span class="na">setDescription</span><span class="o">(</span><span class="s">&quot;My favorite sock.&quot;</span><span class="o">);</span>
</span><span class='line'>     <span class="n">sock</span><span class="o">.</span><span class="na">setPattern</span><span class="o">(</span><span class="n">SockPattern</span><span class="o">.</span><span class="na">ARGYLE</span><span class="o">);</span>
</span><span class='line'>     <span class="n">EntityManager</span> <span class="n">em</span> <span class="o">=</span> <span class="n">Demo</span><span class="o">.</span><span class="na">emf</span><span class="o">.</span><span class="na">createEntityManager</span><span class="o">();</span>
</span><span class='line'>     <span class="n">em</span><span class="o">.</span><span class="na">getTransaction</span><span class="o">().</span><span class="na">begin</span><span class="o">();</span>
</span><span class='line'>     <span class="n">em</span><span class="o">.</span><span class="na">persist</span><span class="o">(</span><span class="n">sock</span><span class="o">);</span>
</span><span class='line'>     <span class="n">em</span><span class="o">.</span><span class="na">getTransaction</span><span class="o">().</span><span class="na">commit</span><span class="o">();</span>
</span><span class='line'>     <span class="n">em</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
</span><span class='line'> <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>There are some obvious pitfalls to this approach. The object/relational mapping is very brittle; for this code to work, the IDs in the database always need to match the values that the ORM tool gets from the enumeration. Changing these values at a later date could cause some surprising results, and you can&#8217;t insert new rows without updating the Enumeration and recompiling. It does obviate the need to map the SOCK_PATTERN table, and you won&#8217;t need to worry about the details of cascading the persistent state of related Sock and SockPattern objects.</p>

<p>It&#8217;s just a new tool in the JPA toolbox.</p>

<p>(The code in this blog post was tested w/ Postgres and Toplink)</p>
</div>
  
  


        </article>
      
      
        <article class="post" role="article">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        
      </p>
    
    
      <h2 class="entry-title"><a href="/2008/01/31/new-jpa-tutorial-pizza-shop/">A Delicious and Simple JPA Mapping Tutorial: The Pizza Shop</a></h2>
    
    












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2008-01-31T00:00:00-05:00" pubdate data-updated="true">Jan 31<span>st</span>, 2008</time>
  </header>


  <div class="entry-content clearfix"><center>
<img src="/assets/images/pizzasign-715207.jpg" alt="" border="0" />
</center>


<p>So, another JPA tutorial. What makes this one different? Well, for one thing, this one comes with a working, downloadable project that works with Eclipse, NetBeans, and IntelliJ IDEA 7. It&#8217;s packaged with Hibernate, Toplink, and OpenJPA. And it&#8217;s been tested with MySQL, PostgreSQL, MS SQL Server, and Sybase. In other words, it works with 36 different IDE/JPA Provider/Database combinations!</p>

<p>Another thing that makes this tutorial different is the subject matter: Pizza! Who doesn&#8217;t love pizza? Except lactose intolerant people. And people who can&#8217;t eat gluten. But <span style="font-style: italic;">other than them</span>, who doesn&#8217;t love pizza? So we&#8217;re going to create a simple database model for a pizza shop&#8217;s point-of-sale system.</p>

<p><span style="font-weight: bold;font-size:130%;" >The Schema</span><br/>
Unsurprisingly, the starting point for any ORM task is usually the database schema (there are people who start with the Objects and work &#8220;backward&#8221; to the schema, but I haven&#8217;t worked with any of them yet). In our example, we have a pristine, consistent, completely normalized schema. In other words, it&#8217;s probably nothing like you&#8217;ll ever be lucky enough to see in the real world! Here&#8217;s our simple little ERD: <img src="/assets/images/pizza-erd-737223.jpg" alt="" border="0" />From this ERD, we can infer the following: 1.) An order is comprised of zero or more pizzas. 2.) A pizza is associated with one size. 3.) A pizza may be associated with a string of text containing &#8220;special instructions.&#8221; 4.) A pizza may have zero or more toppings. You probably also notice that each table has a column called version. This will be used for an <a href="http://en.wikipedia.org/wiki/Optimistic_concurrency_control">optimistic locking strategy</a>.</p>

<p>The first question is, &#8220;Where should we start?&#8221; There&#8217;s no right answer for this, but I find that it&#8217;s easiest to start working with the entities with the fewest dependencies. For example, you can&#8217;t have an order without a pizza, and you can&#8217;t have a pizza without a size, so maybe it makes sense to start with the size. But before that, we&#8217;ll want an ID interface.</p>

<p><span style="font-size:130%;"><span style="font-weight: bold;">An ID Interface</span></span><br/>
First things first. You&#8217;ll notice that, in our schema, every table has an integer ID. It&#8217;s often a good idea to have all of your objects implement the same interface for accessing the ID, because it makes it easier to create Generic DAOs (more about that in a future post). For now, let&#8217;s make a really simple interface like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">IdObject</span> <span class="o">{</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setId</span><span class="o">(</span><span class="n">Integer</span> <span class="n">id</span><span class="o">);</span>
</span><span class='line'>  <span class="kd">public</span> <span class="n">Integer</span> <span class="nf">getId</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><span style="font-weight: bold;font-size:130%;" >Many-to-One Unidirectional Relationships</span><br/>
Now that we&#8217;ve gotten that out of the way, let&#8217;s create the Size class. It&#8217;s a simple POJO littered with annotations, like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Entity</span>
</span><span class='line'><span class="nd">@Table</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;PIZZA_SIZE&quot;</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Size</span> <span class="kd">implements</span> <span class="n">IdObject</span> <span class="o">{</span>
</span><span class='line'>  <span class="nd">@Id</span>
</span><span class='line'>  <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;pizza_size_id&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">Integer</span> <span class="n">id</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;pizza_size_description&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">String</span> <span class="n">description</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;pizza_size_base_price&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">BigDecimal</span> <span class="n">basePrice</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Version</span> <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;version&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">Integer</span> <span class="n">version</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">public</span> <span class="n">Integer</span> <span class="nf">getId</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">id</span><span class="o">;</span> <span class="o">}</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setId</span><span class="o">(</span><span class="n">Integer</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span> <span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span> <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">public</span> <span class="n">String</span> <span class="nf">getDescription</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">description</span><span class="o">;</span> <span class="o">}</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setDescription</span><span class="o">(</span><span class="n">String</span> <span class="n">description</span><span class="o">)</span> <span class="o">{</span> <span class="k">this</span><span class="o">.</span><span class="na">description</span> <span class="o">=</span> <span class="n">description</span><span class="o">;</span> <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">public</span> <span class="n">BigDecimal</span> <span class="nf">getBasePrice</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">basePrice</span><span class="o">;</span> <span class="o">}</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setBasePrice</span><span class="o">(</span><span class="n">BigDecimal</span> <span class="n">basePrice</span><span class="o">)</span> <span class="o">{</span> <span class="k">this</span><span class="o">.</span><span class="na">basePrice</span> <span class="o">=</span> <span class="n">basePrice</span><span class="o">;</span> <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">public</span> <span class="n">Integer</span> <span class="nf">getVersion</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">version</span><span class="o">;</span> <span class="o">}</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setVersion</span><span class="o">(</span><span class="n">Integer</span> <span class="n">version</span><span class="o">)</span> <span class="o">{</span> <span class="k">this</span><span class="o">.</span><span class="na">version</span> <span class="o">=</span> <span class="n">version</span><span class="o">;</span> <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here are some notes on the annotations that were used in the above class: <span style="font-weight: bold;"><br />@Entity</span> tells the JPA provider that this is a managed object.<br/>
<span style="font-weight: bold;">@Table</span> specifies the table name. The JPA provider will attempt to default the table name to a sane value based on the class name, but I like to be explicit. I&#8217;m funny that way. Perhaps it&#8217;s <a href="http://en.wikipedia.org/wiki/Obsessive-compulsive_disorder">OCD</a>. Or a <a href="http://en.wikipedia.org/wiki/Dick_cheney">power-trip</a>.<br/>
<span style="font-weight: bold;">@Column</span> indicates the name of the column, and can include other attributes about the column (you&#8217;ll see a few additional attributes later on). Again, JPA can try to default this to sane values for you, but I like to be explicit.<br/>
<span style="font-weight: bold;">@Version</span> indicates that a particular column is used for indicating when a row is updated. This column can then be used in an <a href="http://en.wikipedia.org/wiki/Optimistic_concurrency_control">optimistic locking</a> scheme.</p>

<p>Next, let&#8217;s do the Pizza object to show how we map a Pizza to a Size.</p>

<center>
<img src="/assets/images/iStock_000004523455XSmall-738216.jpg" alt="" border="0" />
</center>


<p>One thing I that always tripped me up when I started out with ORM<br/>
tools was the difference between &#8220;One-to-Many&#8221; and &#8220;Many-to-One.&#8221; I never knew, if I call a relationship many-to-one in my metadata, is <span style="font-style: italic;">this</span> object the one that there are many of, or is it the other way around? The answer is that &#8220;this&#8221; object always comes first. <span>Many</span>ToOne means that &#8220;there are many of <span style="font-style: italic;">this</span> object to one of <span style="font-style: italic;">those</span> objects.&#8221; The &#8220;Many&#8221; side is often the side that has the foreign key.</p>

<p>In our case, there will be many Pizzas that are the same size. So when we make our Pizza object, we will want to use the <span style="font-weight: bold;">@ManyToOne</span> annotation. Here&#8217;s what the Pizza object looks like so far. I&#8217;ve omitted the getters and setters to save space:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Entity</span>
</span><span class='line'><span class="nd">@Table</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;PIZZA&quot;</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Pizza</span> <span class="kd">implements</span> <span class="n">IdObject</span> <span class="o">{</span>
</span><span class='line'>  <span class="nd">@Id</span>
</span><span class='line'>  <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;pizza_id&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">Integer</span> <span class="n">id</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@ManyToOne</span><span class="o">(</span><span class="n">cascade</span><span class="o">={</span><span class="n">CascadeType</span><span class="o">.</span><span class="na">ALL</span><span class="o">})</span>
</span><span class='line'>  <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;pizza_size_id&quot;</span><span class="o">,</span><span class="n">nullable</span><span class="o">=</span><span class="kc">false</span><span class="o">)</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">Size</span> <span class="n">size</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Version</span> <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;version&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">Integer</span> <span class="n">version</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// (Accessor methods omitted)</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note that, when we made our Size object, we did not include a reference to the Pizza. That was an intentional design decision. In this application, it&#8217;s unlikely that we will want to instantiate a Size object, and get a collection containing all of the Pizzas of that size, so we don&#8217;t bother with mapping it. This is called <span style="font-style: italic;">unidirectional association</span>.</p>

<p>The <span style="font-weight: bold;">@ManyToOne</span> annotation specifies a cascade attribute. There are several different settings for this attribute, which you can read more about <a href="http://www.oracle.com/technology/products/ias/toplink/jpa/resources/toplink-jpa-annotations.html#ManyToOne">here</a>. I tend to cascade the persistent state to all related objects because it reduces the amount of redundant API calls. By default, JPA does <span style="font-style: italic;">not</span> cascade pers istence to related objects. I&#8217;ll cover the cascade attribute in future posts, but for now, we&#8217;ll go with my personal preference, because I&#8217;m writing the article!</p>

<p>The <span style="font-weight: bold;">@JoinColumn</span> annotation indicates the column name that defines the linkage between the Pizza and the Size. You&#8217;ll also note that we&#8217;ve included some additional attributes on our <span style="font-weight: bold;">@Column</span> and <span style="font-weight: bold;">@JoinColumn</span> annotations. The unique and nullable attributes are particularly useful if you use tools to generate schema DDL from your mappings.</p>

<p><span style="font-size:130%;"><span style="font-weight: bold;">One-to-Many bidirectional relationships</span></span></p>

<center>
<img src="/assets/images/iStock_000004945600XSmall-743564.jpg" alt="" border="0" />
</center>


<p>Both the SpecialInstruction and the Order objects are examples of One-to-Many bidirectional relationships. In the case of SpecialInstruction, it is likely that we will care about which Pizza an instruction is associated with, and likewise for the Order. A bidirectional one-to-many relationship implies that one object has a <span style="font-style: italic;">collection</span> of other o bjects. For example, an Order has a collection of Pizzas. First, lets add an order attribute to our Pizza object:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Entity</span>
</span><span class='line'><span class="nd">@Table</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;PIZZA&quot;</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Pizza</span> <span class="kd">implements</span> <span class="n">IdObject</span> <span class="o">{</span>
</span><span class='line'><span class="o">.</span>
</span><span class='line'><span class="o">.</span>
</span><span class='line'>  <span class="nd">@ManyToOne</span><span class="o">(</span><span class="n">cascade</span><span class="o">={</span><span class="n">CascadeType</span><span class="o">.</span><span class="na">ALL</span><span class="o">})</span>
</span><span class='line'>  <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;pizza_order_id&quot;</span><span class="o">,</span><span class="n">nullable</span><span class="o">=</span><span class="kc">false</span><span class="o">)</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">Order</span> <span class="n">order</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">public</span> <span class="n">Order</span> <span class="nf">getOrder</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">order</span><span class="o">;</span> <span class="o">}</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setOrder</span><span class="o">(</span><span class="n">Order</span> <span class="n">order</span><span class="o">)</span> <span class="o">{</span> <span class="k">this</span><span class="o">.</span><span class="na">order</span> <span class="o">=</span> <span class="n">order</span><span class="o">;</span> <span class="o">}</span>
</span><span class='line'><span class="o">.</span>
</span><span class='line'><span class="o">.</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next, let&#8217;s create an Order object to contain our collection of Pizzas, like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Entity</span>
</span><span class='line'><span class="nd">@Table</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;PIZZA_ORDER&quot;</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Order</span> <span class="kd">implements</span> <span class="n">IdObject</span> <span class="o">{</span>
</span><span class='line'>  <span class="nd">@Id</span>
</span><span class='line'>  <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;pizza_order_id&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">Integer</span> <span class="n">id</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@OneToMany</span><span class="o">(</span><span class="n">cascade</span><span class="o">={</span><span class="n">CascadeType</span><span class="o">.</span><span class="na">ALL</span><span class="o">},</span><span class="n">mappedBy</span><span class="o">=</span><span class="s">&quot;order&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">Set</span> <span class="n">pizzas</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashSet</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Version</span> <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;version&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">Integer</span> <span class="n">version</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// (version and id accessors omitted)</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">public</span> <span class="n">Set</span> <span class="nf">getPizzas</span><span class="o">()</span> <span class="o">{</span>  <span class="k">return</span> <span class="n">pizzas</span><span class="o">;</span> <span class="o">}</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setPizzas</span><span class="o">(</span><span class="n">Set</span> <span class="n">pizzas</span><span class="o">)</span> <span class="o">{</span> <span class="k">this</span><span class="o">.</span><span class="na">pizzas</span> <span class="o">=</span> <span class="n">pizzas</span><span class="o">;</span> <span class="o">}</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addPizza</span><span class="o">(</span><span class="n">Pizza</span> <span class="n">pizza</span><span class="o">)</span> <span class="o">{</span>  <span class="n">pizza</span><span class="o">.</span><span class="na">setOrder</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>  <span class="k">this</span><span class="o">.</span><span class="na">pizzas</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">pizza</span><span class="o">);</span> <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>There are a couple of things you worth noting about this mapping:<br/>
1.) The <span style="font-weight: bold;">@OneToMany</span> annotation uses the <span style="font-style: italic;">mappedBy</span> attribute to indicate which member of the related object defines the linkage between the two tables. In this case, we are saying that the Pizza object contains a member named order, which defines the linkage between the two objects.<br/>
2.) I&#8217;ve created a utility method called <span style="font-weight: bold;">addPizza</span>. This simplifies setting both sides of the bidirectional relationship by setting the Order object on the Pizza <span style="font-style: italic;">and</span> adding the Pizza to the Order&#8217;s collection. Users of this class will only need to make one method call to do both.</p>

<p><span style="font-size:130%;"><span style="font-weight: bold;">Many-to-Ma</span></span><span style="font-size:130%;"><span style="font-weight: bold;">ny relationships via a Join Table</span></span></p>

<center>
<img src="/assets/images/cohdra100_1404-732719.JPG" alt="" border="0" />
</center>


<p>The last thing we&#8217;ll cover is how to map Join Tables. In our ERD, you can see that Toppings are modeled in the database with a TOPPING table that contains all of the valid toppings, a PIZZA table that contains all of the valid Pizzas, and a PIZZA_TOPPING table in the middle that maps all of the valid Pizzas to all of the valid Toppings. You <span style="font-style: italic;">could</span> create an object called PizzaTopping that corresponds to the PIZZA_TOPPING table. Then you could have a One-to-Many relationship from the Pizza to the PizzaTopping, and a One-to-One from each PizzaTopping to a Topping. That would be very cumbersome to work with! Fortunately, there&#8217;s a better way.</p>

<p>Logically, a Pizza has a collection of Toppings. In our Java code, we really shouldn&#8217;t care about the fact that there is a PIZZA_TOPPING join table in the middle. First, let&#8217;s create a simple Topping class:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Entity</span>
</span><span class='line'><span class="nd">@Table</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;TOPPING&quot;</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Topping</span> <span class="kd">implements</span> <span class="n">IdObject</span> <span class="o">{</span>
</span><span class='line'>  <span class="nd">@Id</span>
</span><span class='line'>  <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;topping_id&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">Integer</span> <span class="n">id</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;topping_description&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">String</span> <span class="n">description</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;topping_price&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">BigDecimal</span> <span class="n">price</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Version</span> <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;version&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">Integer</span> <span class="n">version</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// (Accessors omitted)</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is how the association would be mapped in the Pizza class:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Entity</span>
</span><span class='line'><span class="nd">@Table</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;PIZZA&quot;</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Pizza</span> <span class="kd">implements</span> <span class="n">IdObject</span> <span class="o">{</span>
</span><span class='line'><span class="o">.</span>
</span><span class='line'><span class="o">.</span>
</span><span class='line'>  <span class="nd">@ManyToMany</span><span class="o">(</span><span class="n">cascade</span><span class="o">={</span><span class="n">CascadeType</span><span class="o">.</span><span class="na">ALL</span><span class="o">})</span>
</span><span class='line'>  <span class="nd">@JoinTable</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;PIZZA_TOPPING&quot;</span><span class="o">,</span>
</span><span class='line'>             <span class="n">joinColumns</span><span class="o">=</span><span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;pizza_id&quot;</span><span class="o">),</span>
</span><span class='line'>             <span class="n">inverseJoinColumns</span><span class="o">=</span><span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;topping_id&quot;</span><span class="o">))</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">Set</span> <span class="n">toppings</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashSet</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">public</span> <span class="n">Set</span> <span class="nf">getToppings</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">toppings</span><span class="o">;</span> <span class="o">}</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setToppings</span><span class="o">(</span><span class="n">Set</span> <span class="n">toppings</span><span class="o">)</span> <span class="o">{</span> <span class="k">this</span><span class="o">.</span><span class="na">toppings</span> <span class="o">=</span> <span class="n">toppings</span><span class="o">;</span> <span class="o">}</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addTopping</span><span class="o">(</span><span class="n">Topping</span> <span class="n">topping</span><span class="o">)</span> <span class="o">{</span> <span class="k">this</span><span class="o">.</span><span class="na">toppings</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">topping</span><span class="o">);</span> <span class="o">}</span>
</span><span class='line'><span class="o">.</span>
</span><span class='line'><span class="o">.</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The @JoinTable annotation defines three key attributes:<br/>
<span style="font-weight: bold;">name</span>: Identifies the name of the join table.<br/>
<span style="font-weight: bold;">joinColumns</span>: This attribute identifies the column name in the join table that points to <span style="font-style: italic;">this</span> object.<br/>
<span style="font-weight: bold;">inverseJoinColumns</span>: This attribute defines the column name in the join table that points to <span style="font-style: italic;">the other</span> objects.</p>

<p>From your Java code, the semantics for dealing with toppings on a pizza are just like any other set, much like you&#8217;d work with a One-to-many object.</p>

<p><span style="font-size:130%;"><span style="font-weight: bold;">Conclusion</span></span><br/>
Since the introduction of annotations, object/relational mapping is one of the easiest aspects of working with JPA over other frameworks. You can see this whole project in action on your IDE of choice by downloading it <a href="http://www.mediafire.com/?2jgrzkizfy9">here</a> (or from <a href="http://mikedesjardins.us/blog/pizzashop-1.1.tar.gz">here</a> if that doesn&#8217;t work for some reason). It should be a pretty reasonable starting point if you want a reference project to start playing with JPA. I hope to revisit the Pizza Shop project to cover other JPA topics in future posts.</p>
</div>
  
  


        </article>
      
      
        <article class="post" role="article">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        
      </p>
    
    
      <h2 class="entry-title"><a href="/2008/01/23/what-i-learned-from-contributing-to/">What I Learned From Contributing to an Open Source Project</a></h2>
    
    












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2008-01-23T00:00:00-05:00" pubdate data-updated="true">Jan 23<span>rd</span>, 2008</time>
  </header>


  <div class="entry-content clearfix"><center>
<img src="/assets/images/opensource_logo-772137.gif" alt="" border="0" />
</center>


<p>A while ago, I had the opportunity to contribute to the <a href="http://wiki.awn-project.org/">Avant Window Navigator</a> open source project. My participation in the project has waned lately, but I&#8217;ve had a little time to reflect on the time that I spent working on it. In no particular order, here were some of the things I took away from the project. Note that this is just based on a single project, and that my experience might have been quite different had I participated in other projects:</p>

<p><span style="font-weight: bold;">Learn to detach yourself from from your code. </span> Once your stuff is checked into a public repository, anything can happen. Generally, most people will respect what they see as &#8220;your turf,&#8221; but that isn&#8217;t always the case. People will suggest improvements, implement them, and share them with the world before you even get a chance to review them. Overall, it&#8217;s a good thing and part of the ecology of an open-source project. At your typical office-programmer job, people usually end up becoming specialists in specific areas and the demarkation of responsibilities are quite clear, sometimes at the expense of progress. The boundaries are a lot looser in the open source community.</p>

<p><span style="font-weight: bold;">Interpersonal Relationships are Weird</span>. When you&#8217;re in an office, you know that Fred is a little odd, and gets touchy when people criticize his font selection, because your co-worker warns you when you&#8217;re at the coffee machine. Anyone who lives and dies by their e-mail knows that emotions don&#8217;t get conveyed adequately in text, and the same is true with online forums and IRC channels. Some people lose their inhibitions when they don&#8217;t understand that they&#8217;re communicating with other people, and turn into jerks. Fortunately, there aren&#8217;t very many of these people.</p>

<p><span style="font-weight: bold;">There&#8217;s a wide range in quality.</span> There&#8217;s no entrance requirement, so there&#8217;s a pretty wide variety in code quality. There are some incredible, amazing, talented people out there who are coding for their love of the craft. There are also people who make some sub-par stuff.</p>

<p><span style="font-weight: bold;">Apprehension about bugs.</span> When I started, I was really worried about what would happen when I released software that was buggy. In a commercial environment, there are often layers of people between the programmer and the end-user, so bug reports come to you filtered and sanitized. In the open source world, people will report bugs openly, directly to you, on forums, for all the world to see. That made me nervous as hell. It turned out to be not so bad. The users knew that they were using bleeding edge stuff, and they expected a degree of instability and seemed to accept it quite well. They were helpful and sympathetic when reporting problems. I think it cuts both ways; when users report their software defects to someone far removed from the programmer, they&#8217;re less sympathetic and more irate than if they&#8217;re communicating directly with a person who can help them. Users are people, just like programmers, and they usually realize that the programmers are doing this for free and are quite polite.</p>

<p><span style="font-weight: bold;">Uptake on Localization was less enthusiastic than I thought it&#8217;d be.</span> My weather applet was among the first to support multiple languages. Because there were so many contributers from outside the U.S. working on AWN, I thought people would jump at the opportunity to translate my applet to their native language. In the end, there were only three people who volunteered.</p>

<p><span style="font-weight: bold;">I felt old. </span> Most of the people contributing to the project were in college or in their mid-twenties. I&#8217;m in my mid-thirties, and after working for 10 hours, coming home, feeding the kids and getting them ready for the next day, it&#8217;s 8:00 and I don&#8217;t feel much like getting out the laptop and coding. I managed to sneak in a few cycles at work, but I always felt a little guilty about it. While the other contributers were complaining about their upcoming finals, I had to deal with the upcoming PTA meeting.</p>

<p><span style="font-weight: bold;">You can learn a lot.</span> I got into this project to &#8220;scratch an itch.&#8221; I was using Linux at work, I needed a dock, because I&#8217;m a Mac guy and I like docks. AWN was a Dock for Linux, but it was missing a clock. So I learned Python to create one. Now I know some Python, and I have a clock on my dock. I&#8217;m a happy man.</p>
</div>
  
  


        </article>
      
      
        <article class="post" role="article">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        
      </p>
    
    
      <h2 class="entry-title"><a href="/2008/01/21/glassfish-to-tomcat-w-jdbc-connection/">Glassfish to Tomcat W/ JDBC Connection Pooling</a></h2>
    
    












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2008-01-21T00:00:00-05:00" pubdate data-updated="true">Jan 21<span>st</span>, 2008</time>
  </header>


  <div class="entry-content clearfix"><p>Here&#8217;s your don&#8217;t-waste-hours-on-something-silly-that-I-did tip for the day.</p>

<p>I recently had the opportunity to change an existing in-house web application from running under Tomcat 5.5, to Glassfish v2. The application uses JDBC connection pooling in the application server, and uses JNDI to find the pool. The only stumbling block I encountered was that, immediately after deploying the application, Hibernate would always complain that it couldn&#8217;t find the connection:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>org.hibernate.HibernateException: Could not find datasource
</span><span class='line'>at org.hibernate.connection.DatasourceConnectionProvider.configure(DatasourceConnectionProvider.java:56)
</span><span class='line'>at org.hibernate.connection.ConnectionProviderFactory.newConnectionProvider(ConnectionProviderFactory.java:124)
</span><span class='line'>at 
</span><span class='line'>.
</span><span class='line'>.
</span><span class='line'>(yadda yadda)
</span><span class='line'>.
</span><span class='line'>Caused by: javax.naming.NameNotFoundException: No object bound to name java:/comp/env/jdbc/MyDB
</span><span class='line'>.
</span><span class='line'>.</span></code></pre></td></tr></table></div></figure>


<p>As it turns out, the datasource that I was using in hibernate.cfg.xml was perfectly fine for Tomcat, but not for Glassfish. I had put the fully qualified JNDI file in my config file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;connection.datasource&quot;</span><span class="nt">&gt;</span>java:/comp/env/jdbc/ApptrackDB<span class="nt">&lt;/property&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Glassfish doesn&#8217;t like that. Once I changed it to:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;connection.datasource&quot;</span><span class="nt">&gt;</span>jdbc/ApptrackDB<span class="nt">&lt;/property&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Everything worked swimmingly.</p>
</div>
  
  


        </article>
      
    </div>

    <ul class="pager">
      
        <li class="previous"><a href="/blog/page/5/">&larr;&nbsp;Older</a></li>
      
      <li><a href="/blog/archives">Blog Archives</a></li>
      
        <li class="next"><a href="/blog/page/3/">Newer&nbsp;&rarr;</a></li>
      
    </ul>
  </div>

  
    <aside class="sidebar col-md-3" role="complementary">
      
        
      
    </aside>
  
</div>

        </div>
      </div>
    </div>
    <footer role="contentinfo"><div class="container">
    <p class="text-muted credits">
  Copyright &copy; 2019 - Mike Desjardins<br>
  <small>
      <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>,
      <span class="credit">customized with <a href="https://github.com/kAworu/octostrap3">octostrap3</a></span>.
  </small>
</p>

</div>
</footer>
    <script src="/assets/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="/javascripts/modernizr-2.0.js"></script>


<script type="text/javascript">
      var disqus_shortname = 'mikedesjardins';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>











  </body>
</html>
