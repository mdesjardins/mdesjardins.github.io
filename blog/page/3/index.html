<!DOCTYPE html lang="en">
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Mike Desjardins</title>
  <meta name="author" content="Mike Desjardins">

  
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://mdesjardins.github.io/blog/page/3">
  <link href="/favicon.ico" type="image/x-icon" rel="icon">
  <link href="/favicon.ico" type="image/x-icon" rel="shortcut icon">
  <link href="/atom.xml" rel="alternate" title="Mike Desjardins" type="application/atom+xml">

  <link href='https://fonts.googleapis.com/css?family=Oxygen:400,700,300' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Fenix' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Alegreya+SC:400,700' rel='stylesheet' type='text/css'>

  <link href="/assets/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" type="text/css">
<link href="/assets/bootstrap/dist/css/bootstrap-theme.min.css" rel="stylesheet" type="text/css">
<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">


  <script src="/javascripts/libs/jquery/jquery-2.0.3.min.js"></script>
  

</head>

  <body   >
    <div id="wrap">
      <div class="about-me">
        <div class="pull-right">
          <div class="well">
            <br/>
            <a href="http://about.me/mikedesjardins">about me</a>
            <br/>
            <a href="/resume">resume</a>
          </div>
        </div>
      </div>
      <header role="banner">
        <hgroup>
  <div class="title col-centered">
    <h1><a href="/">Mike Desjardins</a></h1>
  </div>
  <div class="subtitle col-centered">    
    <img class="mike" src="/images/mike.png" width="40" height="40" title="Mike" alt="images">
    <img class="of" src="/images/of-the.png" width="15" height="15" title="of" alt="images">
    <img class="garden" src="/images/gardens.png" width="67" height="67" title="The Gardens" alt="images">
  </div>
</hgroup>


      </header>
      <div id="main" class="container">
        <div id="content">
          <div class="row">
  <div class="page-content col-md-8 col-md-offset-2">
    <div class="blog-index">
      
      
      
        <article class="post" role="article">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        
      </p>
    
    
      <h2 class="entry-title"><a href="/2008/10/09/clearing-hibernate-second-level-caches/">Clearing Hibernate Second-Level Caches</a></h2>
    
    












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2008-10-09T00:00:00-04:00" pubdate data-updated="true">Oct 9<span>th</span>, 2008</time>
  </header>


  <div class="entry-content clearfix"><p>Recently, I wanted to be able to clear out all of the Hibernate caches via JBoss&#8217;s JMX console. I could have taken the easy way out; we&#8217;re using EHCache, so it could have been as simple as calling <span style="font-style: italic;">CacheManager.clearAll()</span>. However, that would have tied me to a specific cache provider. We&#8217;re still evaluating switching to other cache providers. Ideally, my solution would not be dependent on a specific cache implementation.</p>

<p>Hibernate&#8217;s API does provide a simple way to clear specific caches, but does not provide any method for clearing out all of them. Writing your own is fairly straightforward. First, you obtain all of the entity and collection metadata from the session factory. Next you iterate over the entities, and if the object is cached, you clear out all of the caches associated with the persisted class or collection. Here&#8217;s the code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>  <span class="nd">@PersistenceContext</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">EntityManager</span> <span class="n">em</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">clearHibernateCache</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">Session</span> <span class="n">s</span> <span class="o">=</span> <span class="o">(</span><span class="n">Session</span><span class="o">)</span><span class="n">em</span><span class="o">.</span><span class="na">getDelegate</span><span class="o">();</span>
</span><span class='line'>    <span class="n">SessionFactory</span> <span class="n">sf</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">getSessionFactory</span><span class="o">();</span>
</span><span class='line'>    <span class="n">Map</span><span class="o">&lt;</span><span class="n">string</span><span class="o">,</span><span class="n">EntityPersister</span><span class="o">&gt;</span> <span class="n">classMetadata</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="na">getAllClassMetadata</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">for</span> <span class="o">(</span><span class="n">EntityPersister</span> <span class="n">ep</span> <span class="o">:</span> <span class="n">classMetadata</span><span class="o">.</span><span class="na">values</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="o">(</span><span class="n">ep</span><span class="o">.</span><span class="na">hasCache</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">sf</span><span class="o">.</span><span class="na">evictEntity</span><span class="o">(</span><span class="n">ep</span><span class="o">.</span><span class="na">getCache</span><span class="o">().</span><span class="na">getRegionName</span><span class="o">());</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Map</span><span class="o">&lt;</span><span class="n">string</span><span class="o">,</span><span class="n">AbstractCollectionPersister</span><span class="o">&gt;</span> <span class="n">collMetadata</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="na">getAllCollectionMetadata</span><span class="o">();</span>
</span><span class='line'>    <span class="k">for</span> <span class="o">(</span><span class="n">AbstractCollectionPersister</span> <span class="n">acp</span> <span class="o">:</span> <span class="n">collMetadata</span><span class="o">.</span><span class="na">values</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="o">(</span><span class="n">acp</span><span class="o">.</span><span class="na">hasCache</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">sf</span><span class="o">.</span><span class="na">evictCollection</span><span class="o">(</span><span class="n">acp</span><span class="o">.</span><span class="na">getCache</span><span class="o">().</span><span class="na">getRegionName</span><span class="o">());</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="k">return</span><span class="o">;</span>
</span><span class='line'>  <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now, if we decide to switch to a different cache provider, this code will not need to be re-written. Hopefully we won&#8217;t ever change to a different JPA implementaion. :)</p>
</div>
  
  


        </article>
      
      
        <article class="post" role="article">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        
      </p>
    
    
      <h2 class="entry-title"><a href="/2008/09/29/eight-rules-of-conference-call/">Eight Rules of Conference Call Etiquette</a></h2>
    
    












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2008-09-29T00:00:00-04:00" pubdate data-updated="true">Sep 29<span>th</span>, 2008</time>
  </header>


  <div class="entry-content clearfix"><p>At my past few jobs, I&#8217;ve had to spend a lot of time on conference calls with developers and project managers. While I don&#8217;t profess to be a &#8220;conference call expert&#8221; (or, for that matter, an etiquette expert), I think there are some general ground rules for conference calls, and I&#8217;m going to deviate a bit from my usual Hibernate/JEE topics to itemize the ones that I think are important.</p>

<p>At my current job, I&#8217;m actually pretty lucky. Almost all of us work remotely, so we&#8217;re pretty accustomed to how to behave in the ubiquitous con-call. At a previous engagement, I wasn&#8217;t so lucky &#8211; I&#8217;ll omit their names to protect the guilty.</p>

<p>So here&#8217;s an arbitrary list from me, a random guy on the internet of questionable credentials, of what you should and shouldn&#8217;t do on a conference call. Some of these probably seem really obvious, but I&#8217;m listing even the obvious ones because some people still break them:</p>

<p><span style="font-weight: bold;">1.) Use the Mute Button, especially on a speakerphone.</span> The most important reason for using Mute is to prevent echo-y feedback, particularly on speaker phones. If you aren&#8217;t talking, please put your speaker phone on mute for the sake of everyone else listening. Note that following this rule will invariably lead to the embarrassing situation where you start talking and don&#8217;t realize that you&#8217;ve left your phone on mute. Don&#8217;t worry, we&#8217;ve all done it and we&#8217;ll all forgive you!<br/>
<span style="font-weight: bold;">2.) Introduce yourself when you enter the conference.</span> Some conference systems will force you to state your name when you log in, and then the robo-operator will announce you when you join. I actually find this to be quite jarring, especially when robo-operator interrupts what everyone is saying. Better systems will play a quiet tone when people enter or leave the call. Some, like one that a client had at my previous job, will do nothing at all. This would allow people to lurk on the line unbeknownst to the participants, which is <span style="font-style: italic;">terribly</span> rude. Likewise, if you enter a conference room while a conference call is already underway, announce yourself at the next free moment. Ideally, the moderator of the conference will also take a moment to introduce everybody at the beginning of the call if there is a chance that everyone doesn&#8217;t know each other. This is a <span style="font-style: italic;">great idea</span>.<br/>
<span style="font-weight: bold;">3.) Close the Door.</span> It&#8217;s best to go to a closed room to join a conference call to eliminate background noise. If you can go to such a place, do it. Don&#8217;t join a conference call from, e.g., a street cafe or airport gate. In doing so you risk a passing ambulance, street parade, or TSA threats to destroy unattended luggage interrupting the call.<br/>
<span style="font-weight: bold;">4.) Don&#8217;t use a mobile phone if you can help it.</span> Occasionally you can get away with using a mobile for a con-call in a pinch. But if it&#8217;s a super-important meeting where you are trying to make an impression or do something complicated, nothing will be more frustrating than a garbled, broken up, or dropped call. Try to use a land-line if you can.<br/>
<span style="font-weight: bold;">5.) Don&#8217;t eat on the phone.</span> I guess this is just a personal pet peeve of mine. I can&#8217;t even listen to NPR if the announcer&#8217;s voice is all moist and saliva-sounding. This is more important if you&#8217;re wearing a headset.<br/>
<span style="font-weight: bold;">6.) Have an agenda that everyone receives beforehand.</span> This goes for all meetings, but it&#8217;s just as critical for a conference call. This helps you set expectations and stay on-topic during the call.<br/>
<span style="font-weight: bold;">7.) Get some screen-sharing software.</span> Better yet, get some screen sharing software and test it out before the meeting. With it, you can use something as simple as Notepad or TextMate as a virtual whiteboard. For some reason, we never did this at my previous jobs. We&#8217;ve done it at my current job and it works great.<br/>
<span style="font-weight: bold;">8.) Pick a good time for all participants. </span> This is particularly important if you&#8217;re working in different time zones. Generally you can depend on developers being available between 10am and 4pm in their respective time zones &#8211; you can argue that programmers need to grow up and work regular business hours like everyone else. But until the voodoo of deadline creation becomes a perfected science, software people will need to occasionally work late into the night or early in the morning to meet schedules. Or (like anyone else) we may have daycare responsibilities and have to leave a little early. So we stay flexible. This means that if you&#8217;re working on, e.g., both coasts of the United States, your best bet is between 1pm and 3pm, eastern time. If you&#8217;re working in the U.S. and the far east, you&#8217;re usually stuck with getting the U.S. participants to work early, and the others late in their workday. Similarly between Europe and the U.S., the U.S. participants will probably need to be available late in the day, and the Europeans earlier.</p>

<p>What do you think? Have I missed any conference call ground rules?</p>

<p><span style="font-style: italic;">Photo Credit: </span><a style="font-style: italic;" href="http://flickr.com/people/spcummings/">Stephen Cummings</a></p>
</div>
  
  


        </article>
      
      
        <article class="post" role="article">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        
      </p>
    
    
      <h2 class="entry-title"><a href="/2008/09/22/hibernate-criteria-subqueries-exists/">Hibernate Criteria Subqueries: Exists</a></h2>
    
    












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2008-09-22T00:00:00-04:00" pubdate data-updated="true">Sep 22<span>nd</span>, 2008</time>
  </header>


  <div class="entry-content clearfix"><center>
<img src="/assets/images/national-pizza-shop-718008.jpg" border="0" alt="" />
</center>


<p>While working on a recent project, I came into a situation where I needed to do an &#8220;exists&#8221; query, using a Criteria-style query. The online documentation for this feature is a little sparse, so I thought I&#8217;d share what I did.</p>

<p><span style="font-weight: bold;">The Pizza-shop Data Model (Again)</span></p>

<p>  I keep reusing a data model for a Pizza shop in my posts, and this post will be no different. This data model first appeared in my <a href="/2008/01/31/new-jpa-tutorial-pizza-shop/">JPA mapping tutorial</a>. Here&#8217;s an ERD of the model again:</p>

<p><img src="/assets/images/pizza-erd-737223.jpg" border="0" alt="Pizza shop data model ERD" /></p>

<h3>Find me Orders with Small Pizzas!</h3>


<p>Given this model, what if we needed to find each order that contained a small pizza? Suppose your database had the following data:</p>

<table class="table">
  <thead>
    <tr>
      <th>Order Number</th>
      <th>Contents</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1</td>
      <td>One small, One Large</td>
    </tr>
    <tr>
      <td>2</td>
      <td>Two Smalls, One Large</td>
    </tr>
    <tr>
      <td>3</td>
      <td>Two Large</td>
    </tr>
  </tbody>
</table>


<p>As with <a href="http://mikedesjardins.net/blog/2008/01/new-jpa-tutorial-pizza-shop.html">my earlier posting</a>, the object model has a PizzaOrder class that contains a Set of Pizza objects which correspond to each customer order. Your first inclination might be to do a criteria-within-a-criteria, like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">Criteria</span> <span class="n">criteria</span> <span class="o">=</span> <span class="n">Criteria</span><span class="o">.</span><span class="na">forClass</span><span class="o">(</span><span class="n">PizzaOrder</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'><span class="n">criteria</span><span class="o">.</span><span class="na">createCriteria</span><span class="o">(</span><span class="s">&quot;pizza&quot;</span><span class="o">).</span><span class="na">add</span><span class="o">(</span><span class="s">&quot;pizza_size_id&quot;</span><span class="o">,</span><span class="mi">1</span><span class="o">);</span>
</span><span class='line'><span class="n">List</span>
</span><span class='line'> <span class="n">ordersWithOneSmallPizza</span> <span class="o">=</span> <span class="n">criteria</span><span class="o">.</span><span class="na">list</span><span class="o">();</span>
</span></code></pre></td></tr></table></div></figure>


<p>You&#8217;d be in for a bit of a surprise, though. While you might expect only two Pizza orders to be returned (namely, orders #1 and #2), you&#8217;ll actually have three orders in the result set; because order #2 has two small pizzas in it, order #2 will appear twice in your results!</p>

<p>The reason why this happens is pretty simple, and it becomes clear if you enable Hibernate&#8217;s SQL output feature. To locate all of the pizza orders which contain a small pizza, Hibernate needs to do an inner join to the PIZZA table. This is true regardless of whether you&#8217;ve mapped the Pizza objects to be fetched lazily; the join is required because of your query criteria, not because of your mappings. <span style="font-style: italic;">Note: it&#8217;d be really nice if Hibernate were clever enough to identify from the result set that it had duplicate PIZZA_ORDER records, and build the Set of Pizza objects accordingly, but I suspect that this would be a very difficult thing to do, so I&#8217;m not holding my breath.</span></p>

<p><span style="font-weight: bold;">The Right Way to Do It</span><br/>
What you&#8217;re really trying to do is to obtain all Pizza Orders where an associated small pizza exists. In other words, the SQL query that you&#8217;re trying to emulate is</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span> <span class="o">*</span>
</span><span class='line'>  <span class="k">FROM</span> <span class="n">PIZZA_ORDER</span>
</span><span class='line'> <span class="k">WHERE</span> <span class="k">EXISTS</span> <span class="p">(</span><span class="k">SELECT</span> <span class="mi">1</span>
</span><span class='line'>                 <span class="k">FROM</span> <span class="n">PIZZA</span>
</span><span class='line'>                <span class="k">WHERE</span> <span class="n">PIZZA</span><span class="p">.</span><span class="n">pizza_size_id</span> <span class="o">=</span> <span class="mi">1</span>
</span><span class='line'>                  <span class="k">AND</span> <span class="n">PIZZA</span><span class="p">.</span><span class="n">pizza_order_id</span> <span class="o">=</span> <span class="n">PIZZA_ORDER</span><span class="p">.</span><span class="n">pizza_order_id</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>The way that you do that is by using an &#8220;exists&#8221; Subquery, like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">Criteria</span> <span class="n">criteria</span> <span class="o">=</span> <span class="n">Criteria</span><span class="o">.</span><span class="na">forClass</span><span class="o">(</span><span class="n">PizzaOrder</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="s">&quot;pizzaOrder&quot;</span><span class="o">);</span>
</span><span class='line'><span class="n">DetachedCriteria</span> <span class="n">sizeCriteria</span> <span class="o">=</span> <span class="n">DetachedCriteria</span><span class="o">.</span><span class="na">forClass</span><span class="o">(</span><span class="n">Pizza</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="s">&quot;pizza&quot;</span><span class="o">);</span>
</span><span class='line'><span class="n">sizeCriteria</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&quot;pizza_size_id&quot;</span><span class="o">,</span><span class="mi">1</span><span class="o">);</span>
</span><span class='line'><span class="n">sizeCriteria</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">Property</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">&quot;pizza.pizza_order_id&quot;</span><span class="o">).</span><span class="na">eqProperty</span><span class="o">(</span><span class="s">&quot;pizzaOrder.pizza_order_id&quot;</span><span class="o">));</span>
</span><span class='line'><span class="n">criteria</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">Subqueries</span><span class="o">.</span><span class="na">exists</span><span class="o">(</span><span class="n">sizeCriteria</span><span class="o">.</span><span class="na">setProjection</span><span class="o">(</span><span class="n">Projections</span><span class="o">.</span><span class="na">property</span><span class="o">(</span><span class="s">&quot;pizza.id&quot;</span><span class="o">))));</span>
</span><span class='line'><span class="n">List</span><span class="o">&lt;</span><span class="n">pizzaOrder</span><span class="o">&gt;</span> <span class="n">ordersWithOneSmallPizza</span> <span class="o">=</span> <span class="n">criteria</span><span class="o">.</span><span class="na">list</span><span class="o">();</span>
</span></code></pre></td></tr></table></div></figure>


<p>And <span style="font-style: italic;">voila</span>, the result will contain two PizzaOrders!<br/>
<span style="font-style: italic;">Photo Credit: </span><a href="http://flickr.com/people/squeakymarmot/"><span style="font-style: italic;">Squeaky Marmot</span></a></p>
</div>
  
  


        </article>
      
      
        <article class="post" role="article">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        
      </p>
    
    
      <h2 class="entry-title"><a href="/2008/08/05/hibernate-tools-tips-for-reverse/">Hibernate Tools: Tips for Reverse Engineering at the Command Line</a></h2>
    
    












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2008-08-05T00:00:00-04:00" pubdate data-updated="true">Aug 5<span>th</span>, 2008</time>
  </header>


  <div class="entry-content clearfix"><p>
<img src="/assets/images/tools-geishaboy500-716103.jpg" alt="Tools"/>
</p>


<p>One of the ancillary projects of the Hibernate framework is the <a href="http://www.hibernate.org/255.html">Hibernate Tools</a> toolset. Using Hibernate Tools, you can automatically generate your mapping files (or, if you prefer, JPA annotations), POJOs, and DDL from your database schema.</p>

<p>I&#8217;ve been enamored with the &#8220;Convention over Configuration&#8221; web frameworks lately (e.g., Grails, Django), and wondered how hard it&#8217;d be to reproduce some of their magic ORM functionality using Hibernate Tools. I&#8217;ve concluded that I&#8217;ve still got a <font style="font-weight: bold;">long</font> ways to go, but that I might have some worthwhile tips to share in the meantime.</p>

<p>My progress has been impeded a bit because the documentation for Hibernate Tools is pretty weak. Hibernate Tools was really generated with Eclipse users in mind. A large portion of the documentation is devoted to explaining how to use the IDE. I&#8217;m not using Eclipse, and I intend to use the tools at the command-line, and command-line use really isn&#8217;t targeted.</p>

<p><font style="font-weight: bold;">0.) Get the tools and dependencies.</font><br/>
I&#8217;m still in the dark ages &#8211; I use ant instead of maven for builds, and need to track down jar dependencies the old fashioned way. In addition to the usual Hibernate jars, you&#8217;ll also need <a href="http://www.hibernate.org/30.html">hibernate-tools</a>, <a href="http://freemarker.sourceforge.net/">freemarker</a>, and <a href="http://jtidy.sourceforge.net/download.html">jtidy</a>.</p>

<p><font style="font-weight: bold;"><br /> 1.) Setup an Ant task</font><br/>
This is pretty straightforward, and it is explained fairly well in the documentation. First, define yourself a Hibernate Tools task. Mine looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'> <span class="nt">&lt;taskdef</span> <span class="na">name=</span><span class="s">&quot;hibernatetool&quot;</span> <span class="na">classname=</span><span class="s">&quot;org.hibernate.tool.ant.HibernateToolTask&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nt">&lt;classpath&gt;</span>
</span><span class='line'>    <span class="nt">&lt;fileset</span> <span class="na">refid=</span><span class="s">&quot;hibernate.libs&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;fileset</span> <span class="na">refid=</span><span class="s">&quot;hibernatetools.libs&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;fileset</span> <span class="na">refid=</span><span class="s">&quot;apps.libs&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;fileset</span> <span class="na">refid=</span><span class="s">&quot;compile.libs&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;pathelement</span> <span class="na">path=</span><span class="s">&quot;${build}&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;pathelement</span> <span class="na">path=</span><span class="s">&quot;${basedir}&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/classpath&gt;</span>
</span><span class='line'><span class="nt">&lt;/taskdef&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next, create a task that uses our new definition. We&#8217;re going to be creating the mapping files and POJOs in this example. It will look something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;target</span> <span class="na">name=</span><span class="s">&quot;gen_hibernate&quot;</span> <span class="na">depends=</span><span class="s">&quot;compile&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nt">&lt;delete</span> <span class="na">dir=</span><span class="s">&quot;${genhbm}&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>  <span class="nt">&lt;mkdir</span> <span class="na">dir=</span><span class="s">&quot;${genhbm}&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>  <span class="nt">&lt;hibernatetool&gt;</span>
</span><span class='line'>    <span class="nt">&lt;jdbcconfiguration</span>
</span><span class='line'>        <span class="na">configurationfile=</span><span class="s">&quot;${src}/hibernate-connection.cfg.xml&quot;</span>
</span><span class='line'>        <span class="na">revengfile=</span><span class="s">&quot;hibernate.reveng.xml&quot;</span>
</span><span class='line'>        <span class="na">packagename=</span><span class="s">&quot;us.mikedesjardins.data&quot;</span>
</span><span class='line'>        <span class="na">detectmanytomany=</span><span class="s">&quot;true&quot;</span>
</span><span class='line'>        <span class="na">detectoptimisticlock=</span><span class="s">&quot;true&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;hbm2hbmxml</span> <span class="na">destdir=</span><span class="s">&quot;${genhbm}&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;hbm2java</span> <span class="na">destdir=</span><span class="s">&quot;${genhbm}&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="nt">&lt;property</span> <span class="na">key=</span><span class="s">&quot;jdk5&quot;</span> <span class="na">value=</span><span class="s">&quot;true&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>      <span class="nt">&lt;property</span> <span class="na">key=</span><span class="s">&quot;ejb3&quot;</span> <span class="na">value=</span><span class="s">&quot;false&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/hbm2java&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/hibernatetool&gt;</span>
</span><span class='line'><span class="nt">&lt;/target&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>You&#8217;ll note that I&#8217;ve created a hibernate configuration file above which only contains connection information. This is because I ran into problems when I tried to use a hibernate configuration with cache configuration elements in it. You&#8217;ll also note a reference to a file called hibernate.reveng.xml. This file controls various aspects of the reverse engineering process. Mine is very simple &#8211; I&#8217;m working with MS SQL Server, and I don&#8217;t want it to include any of the system tables which begin with the prefix sys:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;hibernate-reverse-engineering&gt;</span>
</span><span class='line'>  <span class="c">&lt;!-- Eliminate system tables  --&gt;</span>
</span><span class='line'>  <span class="nt">&lt;table-filter</span> <span class="na">name=</span><span class="s">&quot;sys.*&quot;</span> <span class="na">exclude=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
</span><span class='line'><span class="nt">&lt;/hibernate-reverse-engineering&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>That should be all that you need to do to get started. When you run this ant target, your domain object POJOs and Mappings should end up in the ${genhbm} directory.</p>

<p><font style="font-weight: bold;">2.) First Problem &#8211; Table Names</font><br/>
Let&#8217;s say you&#8217;re in a company that prefixes most of it&#8217;s tables with something silly, like &#8220;tb_&#8221;. In that case, Hibernate tools will happily create all kinds of POJOs for you named TbAccount, TbAddress, etc. This is probably not what you want. Fortunately, Hibernate tools let you provide your own &#8220;Reverse Engineering Strategy&#8221; class to deal with situations just like this.</p>

<p>First, update your build target in Ant to include a reference to your strategy class as an attribute of the jdbcconfiguration element:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;target</span> <span class="na">name=</span><span class="s">&quot;gen_hibernate&quot;</span> <span class="na">depends=</span><span class="s">&quot;compile&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nt">&lt;delete</span> <span class="na">dir=</span><span class="s">&quot;${genhbm}&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>  <span class="nt">&lt;mkdir</span> <span class="na">dir=</span><span class="s">&quot;${genhbm}&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>  <span class="nt">&lt;hibernatetool&gt;</span>
</span><span class='line'>    <span class="nt">&lt;jdbcconfiguration</span>
</span><span class='line'>        <span class="na">configurationfile=</span><span class="s">&quot;${src}/hibernate-connection.cfg.xml&quot;</span>
</span><span class='line'>        <span class="na">revengfile=</span><span class="s">&quot;hibernate.reveng.xml&quot;</span>
</span><span class='line'>        <span class="na">packagename=</span><span class="s">&quot;us.mikedesjardins.data&quot;</span>
</span><span class='line'>        <span class="na">detectmanytomany=</span><span class="s">&quot;true&quot;</span>
</span><span class='line'>        <span class="na">detectoptimisticlock=</span><span class="s">&quot;true&quot;</span>
</span><span class='line'>        <span class="na">reversestrategy=</span><span class="s">&quot;us.mikedesjardins.hibernate.CustomReverseEngineeringStrategy&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;hbm2hbmxml</span> <span class="na">destdir=</span><span class="s">&quot;${genhbm}&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;hbm2java</span> <span class="na">destdir=</span><span class="s">&quot;${genhbm}&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="nt">&lt;property</span> <span class="na">key=</span><span class="s">&quot;jdk5&quot;</span> <span class="na">value=</span><span class="s">&quot;true&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>      <span class="nt">&lt;property</span> <span class="na">key=</span><span class="s">&quot;ejb3&quot;</span> <span class="na">value=</span><span class="s">&quot;false&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/hbm2java&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/hibernatetool&gt;</span>
</span><span class='line'><span class="nt">&lt;/target&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next, we&#8217;ll need to create the strategy class. The documentation recommends that you extend the <font style="font-weight: bold;">DelegatingReverseEngineeringStrategy</font> class to do this, like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">us</span><span class="o">.</span><span class="na">mikedesjardins</span><span class="o">.</span><span class="na">hibernate</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.hibernate.cfg.reveng.DelegatingReverseEngineeringStrategy</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.hibernate.cfg.reveng.ReverseEngineeringStrategy</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomReverseEngineeringStrategy</span> <span class="kd">extends</span> <span class="n">DelegatingReverseEngineeringStrategy</span> <span class="o">{</span>
</span><span class='line'>  <span class="kd">public</span> <span class="nf">CustomReverseEngineeringStrategy</span><span class="o">(</span><span class="n">ReverseEngineeringStrategy</span> <span class="n">delegate</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">super</span><span class="o">(</span><span class="n">delegate</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Unfortunately, I was unable to find any JavaDoc documentation for the Hibernate Tools classes, so I had to do a bit of trial-and-error. It turns out there is a method called tableToClassName that can be overridden. This class accepts a TableIdentifier as its input parameter, and returns the class name in a String. Thus, to remove the tb_ from the class, we could do something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="n">String</span> <span class="nf">tableToClassName</span><span class="o">(</span><span class="n">TableIdentifier</span> <span class="n">tableIdentifier</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">String</span> <span class="n">packageName</span> <span class="o">=</span> <span class="s">&quot;us.mikedesjardins.data&quot;</span><span class="o">;</span>
</span><span class='line'>  <span class="n">String</span> <span class="n">className</span> <span class="o">=</span> <span class="kd">super</span><span class="o">.</span><span class="na">tableToClassName</span><span class="o">(</span><span class="n">tableIdentifier</span><span class="o">);</span>
</span><span class='line'>  <span class="k">if</span> <span class="o">(</span><span class="n">className</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">&quot;Tb&quot;</span><span class="o">))</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">className</span> <span class="o">=</span> <span class="n">className</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">className</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Compile your CustomReverseEngineeringStrategy class, make sure it&#8217;s on the hibernatetools task definition&#8217;s classpath, and re-run the task. Voila! The Tb&#8217;s are gone!</p>

<p>There&#8217;s a similar method for column names named <font style="font-weight: bold;">columnToPropertyName</font> that handles naming your persisted class&#8217;s member variables. In my current project, the primary key columns are named the same as the table name, with &#8220;_id&#8221; appended to the end. However, in the object model, we like to just name the primary key property &#8220;id&#8221; to simplify the creation of generic DAOs. I use the columnToPropertyName method for this.</p>

<p><font style="font-weight: bold;">2.) Next Problem &#8211; The Generated POJOs need tweaking.</font><br/>
Perhaps the code that Hibernate generates is not to your liking. Maybe you work with standards-compliance-nazis who want a copyright header at the top of each class file. Or maybe all of your persisted objects implement the same interface for use with generic DAOs.</p>

<p>Under the covers, Hibernate uses <a href="http://freemarker.sourceforge.net/">freemarker</a> to generate POJOs and mapping files. The templates that it uses can be edited to your liking, but doing it is not very straightforward.</p>

<p>First, unzip the hibernate tools jar into a temporary directory. Once unzipped, you&#8217;ll find a directory named pojo. This directory contains all of the templates used for POJO generation. Copy that directory into your build area and name it something like hib_templates.</p>

<p>The hbm2java task is actually just an alias for another hibernate tools target called hbmtemplate. With hbmtemplate, you can configure the location of the source templates. So we&#8217;ll remove the hbm2java task from the gen_hibernate target, and replace it with an equivalent hbmtemplate task:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;target</span> <span class="na">name=</span><span class="s">&quot;gen_hibernate&quot;</span> <span class="na">depends=</span><span class="s">&quot;compile&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nt">&lt;delete</span> <span class="na">dir=</span><span class="s">&quot;${genhbm}&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>  <span class="nt">&lt;mkdir</span> <span class="na">dir=</span><span class="s">&quot;${genhbm}&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>  <span class="nt">&lt;hibernatetool&gt;</span>
</span><span class='line'>    <span class="nt">&lt;jdbcconfiguration</span>
</span><span class='line'>        <span class="na">configurationfile=</span><span class="s">&quot;${src}/hibernate-connection.cfg.xml&quot;</span>
</span><span class='line'>        <span class="na">revengfile=</span><span class="s">&quot;hibernate.reveng.xml&quot;</span>
</span><span class='line'>        <span class="na">packagename=</span><span class="s">&quot;us.mikedesjardins.data&quot;</span>
</span><span class='line'>        <span class="na">detectmanytomany=</span><span class="s">&quot;true&quot;</span>
</span><span class='line'>        <span class="na">detectoptimisticlock=</span><span class="s">&quot;true&quot;</span>
</span><span class='line'>        <span class="na">reversestrategy=</span><span class="s">&quot;us.mikedesjardins.hibernate.CustomReverseEngineeringStrategy&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>     <span class="nt">&lt;hbm2hbmxml</span> <span class="na">destdir=</span><span class="s">&quot;${genhbm}&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>     <span class="nt">&lt;hbmtemplate</span> <span class="na">templateprefix=</span><span class="s">&quot;pojo/&quot;</span>
</span><span class='line'>              <span class="na">destdir=</span><span class="s">&quot;${genhbm}&quot;</span>
</span><span class='line'>              <span class="na">template=</span><span class="s">&quot;hib_templates/Pojo.ftl&quot;</span>
</span><span class='line'>              <span class="na">filepattern=</span><span class="s">&quot;{package-name}/{class-name}.java&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>       <span class="nt">&lt;property</span> <span class="na">key=</span><span class="s">&quot;jdk5&quot;</span> <span class="na">value=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>       <span class="nt">&lt;property</span> <span class="na">key=</span><span class="s">&quot;ejb3&quot;</span> <span class="na">value=</span><span class="s">&quot;false&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/hbmtemplate&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/hibernatetool&gt;</span>
</span><span class='line'><span class="nt">&lt;/target&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now that we&#8217;ve told hibernate tools where our template lives, we can edit it to our liking. For example, if we want to add a copyright notice to the top of each generated POJO, we could do so thusly:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'>//
</span><span class='line'>// Copyright 2008 Big Amalgamated Mega Global Software Corp.  All Rights Reserved.
</span><span class='line'>//
</span><span class='line'>${pojo.getPackageDeclaration()}
</span><span class='line'>// Generated ${date} by Hibernate Tools ${version}
</span><span class='line'>
</span><span class='line'><span class="err">&lt;</span>#assign classbody&gt;
</span><span class='line'><span class="err">&lt;</span>#include &quot;PojoTypeDeclaration.ftl&quot;/&gt;; {
</span><span class='line'>.
</span><span class='line'>.
</span><span class='line'>.
</span><span class='line'>(etc)
</span></code></pre></td></tr></table></div></figure>


<p>Now that we&#8217;ve done this, we can create more templates that, e.g., generate empty DAO classes, automatically create derived classes, etc.</p>

<p>Hope that helps!</p>

<p><font style="font-style: italic;">Photo Credit: </font><a style="font-style: italic;" href="http://flickr.com/people/geishaboy500/">geishaboy500</a></p>
</div>
  
  


        </article>
      
      
        <article class="post" role="article">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        
      </p>
    
    
      <h2 class="entry-title"><a href="/2008/07/12/twenty-minutes-with-hibernate-search-a-cheesy-example/">Twenty Minutes With Hibernate Search; a Cheesy Example</a></h2>
    
    












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2008-07-12T00:00:00-04:00" pubdate data-updated="true">Jul 12<span>th</span>, 2008</time>
  </header>


  <div class="entry-content clearfix"><center><img src="/assets/images/cheese-blog-719057.jpg" alt="" border="0" /></center>


<p>In a <a href="http://mikedesjardins.net/blog/2008/06/who-is-running-that-horrible-hibernate.html">recent post</a>, I showed a trick for determining which users in a system are running a long-running query. One commenter suggested that using a full-text search system made a lot of sense in those situations, and I wholeheartedly agree. So I decided to devote a new post to <a href="http://www.hibernate.org/410.html">Hibernate Search</a>!</p>

<p>In this example, I provide a live, <a href="http://mikedesjardins.us/cheese/search">online interactive search</a> of an online cheese database, and you can download the example (more on that at the end of the post).</p>

<p><span style="font-weight: bold;">Step One &#8211; The Test Data</span><br/>
I spent the most time on this project was creating test data for the example program. I headed over to <a href="http://freebase.com/">Freebase</a> to see what was available for data sets. Among lots of other things, they have a free database of <a href="http://www.freebase.com/view/food/cheese">cheese</a>. First, I downloaded the data in TSV format, dumped it into a raw table, and massaged it into a relational, normalized schema. I ended up with this when I was done:</p>

<center>
  <img src="/assets/images/cheese-search-erd-785035.jpg" alt="" border="0" />
</center>


<p>So, a CHEESE can have only one ORIGIN (a country or region where the cheese is made), is made from one-to-many types of MILK, and may have zero-to-many TEXTURES associated with it.</p>

<p><span style="font-weight: bold;">Step Two &#8211; Build the Domain Model</span><br/>
The domain model for this system is very simple. Each Cheese class has an Origin, and a set of Milk and Textures:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Entity</span> <span class="nd">@Table</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;MILK&quot;</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Milk</span> <span class="o">{</span>
</span><span class='line'>  <span class="nd">@Id</span> <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;milk_id&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">Integer</span> <span class="n">id</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Basic</span> <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;name&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Version</span> <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;version&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">Integer</span> <span class="n">version</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Accessors omitted</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Entity</span> <span class="nd">@Table</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;ORIGIN&quot;</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Origin</span> <span class="o">{</span>
</span><span class='line'>  <span class="nd">@Id</span> <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;origin_id&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">Integer</span> <span class="n">id</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Basic</span> <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;name&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Version</span> <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;version&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">Integer</span> <span class="n">version</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Accessors omitted</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Entity</span> <span class="nd">@Table</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;TEXTURE&quot;</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Texture</span> <span class="o">{</span>
</span><span class='line'>  <span class="nd">@Id</span> <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;texture_id&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">Integer</span> <span class="n">id</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Basic</span> <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;description&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">String</span> <span class="n">description</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Version</span> <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;version&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">Integer</span> <span class="n">version</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Accessors omitted</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Entity</span> <span class="nd">@Table</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;CHEESE&quot;</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Cheese</span> <span class="o">{</span>
</span><span class='line'>  <span class="nd">@Id</span> <span class="nd">@GeneratedValue</span><span class="o">(</span><span class="n">strategy</span><span class="o">=</span><span class="n">GenerationType</span><span class="o">.</span><span class="na">IDENTITY</span><span class="o">)</span>
</span><span class='line'>  <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;cheese_id&quot;</span><span class="o">,</span><span class="n">nullable</span><span class="o">=</span><span class="kc">false</span><span class="o">,</span><span class="n">unique</span><span class="o">=</span><span class="kc">true</span><span class="o">)</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">Integer</span> <span class="n">id</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Basic</span> <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;name&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@ManyToOne</span><span class="o">(</span><span class="n">cascade</span><span class="o">={</span><span class="n">CascadeType</span><span class="o">.</span><span class="na">ALL</span><span class="o">})</span>
</span><span class='line'>  <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;origin_id&quot;</span><span class="o">,</span><span class="n">nullable</span><span class="o">=</span><span class="kc">false</span><span class="o">)</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">Origin</span> <span class="n">origin</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@ManyToMany</span><span class="o">(</span><span class="n">cascade</span><span class="o">={</span><span class="n">CascadeType</span><span class="o">.</span><span class="na">PERSIST</span><span class="o">,</span><span class="n">CascadeType</span><span class="o">.</span><span class="na">MERGE</span><span class="o">})</span>
</span><span class='line'>  <span class="nd">@JoinTable</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;CHEESE_MILK_MAP&quot;</span><span class="o">,</span>
</span><span class='line'>             <span class="n">joinColumns</span><span class="o">=</span><span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;cheese_id&quot;</span><span class="o">),</span>
</span><span class='line'>             <span class="n">inverseJoinColumns</span><span class="o">=</span><span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;milk_id&quot;</span><span class="o">))</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">milk</span><span class="o">&gt;</span> <span class="n">milks</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashSet</span><span class="o">&lt;</span><span class="n">milk</span><span class="o">&gt;();</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@ManyToMany</span><span class="o">(</span><span class="n">cascade</span><span class="o">={</span><span class="n">CascadeType</span><span class="o">.</span><span class="na">PERSIST</span><span class="o">,</span><span class="n">CascadeType</span><span class="o">.</span><span class="na">MERGE</span><span class="o">})</span>
</span><span class='line'>  <span class="nd">@JoinTable</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;CHEESE_TEXTURE_MAP&quot;</span><span class="o">,</span>
</span><span class='line'>             <span class="n">joinColumns</span><span class="o">=</span><span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;cheese_id&quot;</span><span class="o">),</span>
</span><span class='line'>             <span class="n">inverseJoinColumns</span><span class="o">=</span><span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;texture_id&quot;</span><span class="o">))</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">texture</span><span class="o">&gt;</span> <span class="n">textures</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashSet</span><span class="o">&lt;</span><span class="n">texture</span><span class="o">&gt;();</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Version</span> <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;version&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">Integer</span> <span class="n">version</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Accessors omitted</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><span style="font-weight: bold;">Step Three &#8211; Add Search Annotations and Configure Lucene</span><br/>
Behind the scenes, Hibernate Search uses the <a href="http://lucene.apache.org/">Apache Lucene</a> search engine to do its indexing. In short, it maintains a mapping of object IDs to search terms in an external file, and updates the file when objects are added, updated, or deleted. To start using Hibernate Search, you&#8217;ll need to configure the location of these index files, as well as a search directory provider (we&#8217;ll just use the default). This is done in your Hibernate properties file, or (if you use JPA, like me), in persistence.xml:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;hibernate.search.default.directory_provider&quot;</span> <span class="na">value=</span><span class="s">&quot;org.hibernate.search.store.FSDirectoryProvider&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'><span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;hibernate.search.default.indexBase&quot;</span> <span class="na">value=</span><span class="s">&quot;/var/lucene/cheese-indexes&quot;</span> <span class="nt">/&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next, you need to indicate to Lucene which classes need to be indexed. You also need to indicate which data fields 1.) contain the document ID, and 2.) contain relevant search text. In our example, we only need to index the Cheese objects. We want to allow users to search on cheese name, milk name, origin, and texture.</p>

<p>First, we indicate that we want to index the Cheese objects by applying the <span style="font-weight: bold;">@Indexed</span> annotation to the class, and we elect to use the Id field to identify the Cheese objects to Lucene by applying a <span style="font-weight: bold;">@DocumentId</span> annotation to it. Next, we indicate that the cheese name contains searchable text by adding the <span style="font-weight: bold;">@Field(index=Index.TOKENIZED, store=Store.NO)</span> annotation to it. The annotation parameters are informing Hibernate Search to use Lucene&#8217;s default tokenizer to summarize the text, and not to store a copy of the document content.</p>

<p>We also want to allow users to search on Origin, Milk Name, and Texture. This text is not contained within the Cheese object, instead they&#8217;re in related object. So we need to add the <span style="font-weight: bold;">@IndexEmbedded</span> annotation to the member variables in the Cheese class that refer to the objects which contain the searchable text, and we also need to add the <span style="font-weight: bold;">@Field(index=Index.TOKENIZED, store=Store.NO)</span> annotation to the Milk, Origin, and Texture classes to indicate which fields are searchable.</p>

<p>When you&#8217;re done, the modified domain classes will look like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Entity</span> <span class="nd">@Table</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;MILK&quot;</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Milk</span> <span class="o">{</span>
</span><span class='line'>  <span class="nd">@Id</span> <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;milk_id&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">Integer</span> <span class="n">id</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Field</span><span class="o">(</span><span class="n">index</span><span class="o">=</span><span class="n">Index</span><span class="o">.</span><span class="na">TOKENIZED</span><span class="o">)</span>
</span><span class='line'>  <span class="nd">@Basic</span> <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;name&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Version</span> <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;version&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">Integer</span> <span class="n">version</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Accessors omitted</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Entity</span> <span class="nd">@Table</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;ORIGIN&quot;</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Origin</span> <span class="o">{</span>
</span><span class='line'>  <span class="nd">@Id</span> <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;origin_id&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">Integer</span> <span class="n">id</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Field</span><span class="o">(</span><span class="n">index</span><span class="o">=</span><span class="n">Index</span><span class="o">.</span><span class="na">TOKENIZED</span><span class="o">)</span>
</span><span class='line'>  <span class="nd">@Basic</span> <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;name&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Version</span> <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;version&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">Integer</span> <span class="n">version</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Accessors omitted</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Entity</span> <span class="nd">@Table</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;TEXTURE&quot;</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Texture</span> <span class="o">{</span>
</span><span class='line'>  <span class="nd">@Id</span> <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;texture_id&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">Integer</span> <span class="n">id</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Field</span><span class="o">(</span><span class="n">index</span><span class="o">=</span><span class="n">Index</span><span class="o">.</span><span class="na">TOKENIZED</span><span class="o">)</span>
</span><span class='line'>  <span class="nd">@Basic</span> <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;description&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">String</span> <span class="n">description</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Version</span> <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;version&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">Integer</span> <span class="n">version</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Accessors omitted</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Indexed</span>
</span><span class='line'><span class="nd">@Entity</span> <span class="nd">@Table</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;CHEESE&quot;</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Cheese</span> <span class="o">{</span>
</span><span class='line'>  <span class="nd">@DocumentId</span>
</span><span class='line'>  <span class="nd">@Id</span> <span class="nd">@GeneratedValue</span><span class="o">(</span><span class="n">strategy</span><span class="o">=</span><span class="n">GenerationType</span><span class="o">.</span><span class="na">IDENTITY</span><span class="o">)</span>
</span><span class='line'>  <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;cheese_id&quot;</span><span class="o">,</span><span class="n">nullable</span><span class="o">=</span><span class="kc">false</span><span class="o">,</span><span class="n">unique</span><span class="o">=</span><span class="kc">true</span><span class="o">)</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">Integer</span> <span class="n">id</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Basic</span> <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;name&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="nd">@Field</span><span class="o">(</span><span class="n">index</span><span class="o">=</span><span class="n">Index</span><span class="o">.</span><span class="na">TOKENIZED</span><span class="o">,</span> <span class="n">store</span><span class="o">=</span><span class="n">Store</span><span class="o">.</span><span class="na">NO</span><span class="o">)</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@IndexedEmbedded</span>
</span><span class='line'>  <span class="nd">@ManyToOne</span><span class="o">(</span><span class="n">cascade</span><span class="o">={</span><span class="n">CascadeType</span><span class="o">.</span><span class="na">ALL</span><span class="o">})</span>
</span><span class='line'>  <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;origin_id&quot;</span><span class="o">,</span><span class="n">nullable</span><span class="o">=</span><span class="kc">false</span><span class="o">)</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">Origin</span> <span class="n">origin</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@IndexedEmbedded</span>
</span><span class='line'>  <span class="nd">@ManyToMany</span><span class="o">(</span><span class="n">cascade</span><span class="o">={</span><span class="n">CascadeType</span><span class="o">.</span><span class="na">PERSIST</span><span class="o">,</span><span class="n">CascadeType</span><span class="o">.</span><span class="na">MERGE</span><span class="o">})</span>
</span><span class='line'>  <span class="nd">@JoinTable</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;CHEESE_MILK_MAP&quot;</span><span class="o">,</span>
</span><span class='line'>             <span class="n">joinColumns</span><span class="o">=</span><span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;cheese_id&quot;</span><span class="o">),</span>
</span><span class='line'>             <span class="n">inverseJoinColumns</span><span class="o">=</span><span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;milk_id&quot;</span><span class="o">))</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">milk</span><span class="o">&gt;</span> <span class="n">milks</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashSet</span><span class="o">&lt;</span><span class="n">milk</span><span class="o">&gt;();</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@IndexedEmbedded</span>
</span><span class='line'>  <span class="nd">@ManyToMany</span><span class="o">(</span><span class="n">cascade</span><span class="o">={</span><span class="n">CascadeType</span><span class="o">.</span><span class="na">PERSIST</span><span class="o">,</span><span class="n">CascadeType</span><span class="o">.</span><span class="na">MERGE</span><span class="o">})</span>
</span><span class='line'>  <span class="nd">@JoinTable</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;CHEESE_TEXTURE_MAP&quot;</span><span class="o">,</span>
</span><span class='line'>             <span class="n">joinColumns</span><span class="o">=</span><span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;cheese_id&quot;</span><span class="o">),</span>
</span><span class='line'>             <span class="n">inverseJoinColumns</span><span class="o">=</span><span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;texture_id&quot;</span><span class="o">))</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">texture</span><span class="o">&gt;</span> <span class="n">textures</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashSet</span><span class="o">&lt;</span><span class="n">texture</span><span class="o">&gt;();</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Version</span> <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;version&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">Integer</span> <span class="n">version</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Accessors omitted</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><span style="font-weight: bold;">Step Four &#8211; The Servlets</span><br/>
In this example, I didn&#8217;t want to rely on any web frameworks or even on JSPs, so I wrote a good old-fashioned servlet to exercise the search function. No sane person would ever do it this way. There are actually two servlets in the example &#8211; one for application initialization and one for the page itself.</p>

<p>The initialization servlet does the work of indexing all of the database data the first time through. For our small data set, this takes less than a minute. For larger data sets, it wouldn&#8217;t make sense to re-index everything every time you start the application. The initialization code iterates over all of the Cheese objects ant tells the FullTextEntityManger to index it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">Dao</span><span class="o">&lt;</span><span class="n">cheese</span><span class="o">&gt;</span> <span class="n">dao</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CheeseDao</span><span class="o">();</span>
</span><span class='line'>  <span class="n">EntityManager</span> <span class="n">em</span> <span class="o">=</span> <span class="n">dao</span><span class="o">.</span><span class="na">getEntityManager</span><span class="o">();</span>
</span><span class='line'>  <span class="n">FullTextEntityManager</span> <span class="n">fullTextEntityManager</span> <span class="o">=</span> <span class="n">Search</span><span class="o">.</span><span class="na">createFullTextEntityManager</span><span class="o">(</span><span class="n">em</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">List</span><span class="o">&lt;</span><span class="n">cheese</span><span class="o">&gt;</span> <span class="n">cheeses</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="s">&quot;select c from Cheese as c&quot;</span><span class="o">).</span><span class="na">getResultList</span><span class="o">();</span>
</span><span class='line'>  <span class="k">for</span> <span class="o">(</span><span class="n">Cheese</span> <span class="n">cheese</span> <span class="o">:</span> <span class="n">cheeses</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">fullTextEntityManager</span><span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="n">cheese</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The main page servlet has some code in the doPost method to perform the search based on the contents of the text form field. That code looks like this (I&#8217;ve shortened it up a bit here by removing some error checking and HTML output):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">doPost</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span>
</span><span class='line'>                   <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ServletException</span><span class="o">,</span> <span class="n">IOException</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">response</span><span class="o">.</span><span class="na">setContentType</span><span class="o">(</span><span class="s">&quot;text/html&quot;</span><span class="o">);</span>
</span><span class='line'>  <span class="n">PrintWriter</span> <span class="n">out</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="na">getWriter</span><span class="o">();</span>
</span><span class='line'>  <span class="n">emitHeader</span><span class="o">(</span><span class="n">out</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">String</span> <span class="n">searchTerm</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">&quot;searchterm&quot;</span><span class="o">);</span>
</span><span class='line'>  <span class="n">EntityManager</span> <span class="n">em</span> <span class="o">=</span> <span class="n">dao</span><span class="o">.</span><span class="na">getEntityManager</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">FullTextEntityManager</span> <span class="n">fullTextEntityManager</span> <span class="o">=</span>
</span><span class='line'>    <span class="n">org</span><span class="o">.</span><span class="na">hibernate</span><span class="o">.</span><span class="na">search</span><span class="o">.</span><span class="na">jpa</span><span class="o">.</span><span class="na">Search</span><span class="o">.</span><span class="na">createFullTextEntityManager</span><span class="o">(</span><span class="n">em</span><span class="o">);</span>
</span><span class='line'>  <span class="n">MultiFieldQueryParser</span> <span class="n">parser</span> <span class="o">=</span>
</span><span class='line'>    <span class="k">new</span> <span class="nf">MultiFieldQueryParser</span><span class="o">(</span> <span class="k">new</span> <span class="n">String</span><span class="o">[]{</span><span class="s">&quot;name&quot;</span><span class="o">,</span>
</span><span class='line'>                                            <span class="s">&quot;origin.name&quot;</span><span class="o">,</span>
</span><span class='line'>                                            <span class="s">&quot;milks.name&quot;</span><span class="o">,</span>
</span><span class='line'>                                            <span class="s">&quot;textures.description&quot;</span><span class="o">},</span>
</span><span class='line'>                               <span class="k">new</span> <span class="nf">StandardAnalyzer</span><span class="o">());</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">lucene</span><span class="o">.</span><span class="na">search</span><span class="o">.</span><span class="na">Query</span> <span class="n">query</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">searchTerm</span><span class="o">);</span>
</span><span class='line'>    <span class="n">javax</span><span class="o">.</span><span class="na">persistence</span><span class="o">.</span><span class="na">Query</span> <span class="n">hibQuery</span> <span class="o">=</span>
</span><span class='line'>      <span class="n">fullTextEntityManager</span><span class="o">.</span><span class="na">createFullTextQuery</span><span class="o">(</span><span class="n">query</span><span class="o">,</span><span class="n">Cheese</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'>    <span class="n">List</span><span class="o">&lt;</span><span class="n">cheese</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">hibQuery</span><span class="o">.</span><span class="na">getResultList</span><span class="o">();</span>
</span><span class='line'>    <span class="n">emitTable</span><span class="o">(</span><span class="n">out</span><span class="o">,</span><span class="n">result</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">ParseException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">&quot;Got a parse exception&quot;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
</span><span class='line'>    <span class="k">throw</span> <span class="k">new</span> <span class="nf">ServletException</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  <span class="n">emitFooter</span><span class="o">(</span><span class="n">out</span><span class="o">);</span>
</span><span class='line'>  <span class="n">out</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>That&#8217;s all there is to it! As you can see, setting up Hibernate Search is very simple. Most of the effort for this project was spent creating the data and making the servlets work.</p>

<p><span style="font-weight: bold;">Enjoy the Finished Product</span><br/>
To see this less-than-world-changing application in action, visit it <a href="http://mikedesjardins.us/cheese/search">here</a>. You can also <a href="http://mikedesjardins.us/cheese-search-1.0.tar.gz">download the whole eclipse project</a> and try it out for yourself. It comes with SQL dumps suitable for MySQL and PostgreSQL, and it has been tested with both environments under Tomcat 5.5.</p>

<p><span style="font-style: italic;">Photo Credit: </span><a href="http://www.flickr.com/people/cuse/"><span style="font-style: italic;font-size:100%;" ><span class="RealName"><span class="fn n"><span class="given-name">Chris</span> <span class="family-name">Buecheler</span></span></span></span></a></p>
</div>
  
  


        </article>
      
      
        <article class="post" role="article">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        
      </p>
    
    
      <h2 class="entry-title"><a href="/2008/06/23/use-hibernates-custom-loaders-to-fake/">Use Hibernate&#8217;s Custom Loaders to Fake an Aggregation View</a></h2>
    
    












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2008-06-23T00:00:00-04:00" pubdate data-updated="true">Jun 23<span>rd</span>, 2008</time>
  </header>


  <div class="entry-content clearfix"><p><span style="font-weight: bold;">Your Problem</span><br/>
You have a data model with table that contains data you want to aggregate. For instance (returning to my venerable Pizza Shop example), let&#8217;s say you have a PRODUCT table that enumerates the items your pizza shops sells, and a LOCATION table that contains all of your retail locations:</p>

<center>
<img src="/assets/images/blog-location-product-791813.png" alt="" border="0" />
</center>


<p>We also have a table that contains the sum of all of the previous days&#8217; sales, broken down by PRODUCT and LOCATION:</p>

<center>
<img src="/assets/images/blog-yesterday-sales-786525.png" alt="" border="0" />
</center>


<p>This is all well and good, but we&#8217;ve been asked to create an Executive Dashboard for the President of the pizza chain, and she would like to see daily sales by product. She is not interested in a breakdown by location.</p>

<p><span style="font-weight: bold;">We could tally it up client side&#8230;</span><br/>
What if we just loaded the entire table into the client, and iterated over the per-product results, and present that? Unfortunately, ORM libraries are pretty stupid in situations like these, and will generate all kinds of expensive reads to the database when you try to solve the problem this way. If you want to learn more about lazy loading, and why you shouldn&#8217;t iterate over a collection, check out my earlier post <a href="http://mikedesjardins.net/blog/2008/03/pizza-shop-2-totaling-jpa-order-use.html">here</a>.</p>

<p><span style="font-weight: bold;">We could just create a view in the Database&#8230;</span><br/>
We <span>could</span><span style="font-weight: bold;"> </span>just create a view, and aggregate the data there. Then we can easily create a Hibernate mapping to that view. The query for the view is simple:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">CREATE</span> <span class="k">VIEW</span> <span class="n">sales_by_product_view</span> <span class="k">AS</span>
</span><span class='line'><span class="k">SELECT</span> <span class="n">product_id</span><span class="p">,</span> <span class="k">SUM</span><span class="p">(</span><span class="n">total_sales</span><span class="p">)</span> <span class="k">AS</span> <span class="n">total_sales</span>
</span><span class='line'>  <span class="k">FROM</span> <span class="n">YESTERDAY_SALES</span>
</span><span class='line'> <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">product_id</span>
</span></code></pre></td></tr></table></div></figure>


<p>However, we are working with a tyrannical DBA. She is not keen on proliferating views throughout our otherwise pristine schema every time the President has decided that the company needs a new widget for the executive dashboard application.</p>

<p><span style="font-weight: bold;">&#8230;or we could fake it with a custom loader</span><br/>
Instead, let&#8217;s create a Hibernate mapping that generates the same results as the view. First, let&#8217;s create a simple POJO to contain the results:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">us</span><span class="o">.</span><span class="na">mikedesjardins</span><span class="o">;</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SalesByProduct</span> <span class="o">{</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">Integer</span> <span class="n">id</span><span class="o">;</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">Integer</span> <span class="n">productId</span><span class="o">;</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">BigDecimal</span> <span class="n">sales</span><span class="o">;</span>
</span><span class='line'><span class="c1">// accessors omitted</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The corresponding mapping file would look like this. I re-used the product_id for the ID in this example. Note the loader element:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;hibernate-mapping</span> <span class="na">package=</span><span class="s">&quot;us.mikedesjardins&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nt">&lt;class</span> <span class="na">name=</span><span class="s">&quot;SalesByProduct&quot;</span>
</span><span class='line'>          <span class="na">dynamic-insert=</span><span class="s">&quot;false&quot;</span>
</span><span class='line'>          <span class="na">dynamic-update=</span><span class="s">&quot;false&quot;</span>
</span><span class='line'>          <span class="na">mutable=</span><span class="s">&quot;false&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;id</span> <span class="na">name=</span><span class="s">&quot;id&quot;</span> <span class="na">type=</span><span class="s">&quot;int&quot;</span> <span class="na">unsaved-value=</span><span class="s">&quot;null&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="nt">&lt;column</span> <span class="na">name=</span><span class="s">&quot;__id&quot;</span> <span class="na">sql-type=</span><span class="s">&quot;int identity&quot;</span> <span class="na">not-null=</span><span class="s">&quot;true&quot;</span> <span class="na">unique=</span><span class="s">&quot;true&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/id&gt;</span>
</span><span class='line'>    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;productId&quot;</span> <span class="na">type=</span><span class="s">&quot;int&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="nt">&lt;column</span> <span class="na">name=</span><span class="s">&quot;__product_id&quot;</span> <span class="na">not-null=</span><span class="s">&quot;false&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/property&gt;</span>
</span><span class='line'>    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;sales&quot;</span> <span class="na">type=</span><span class="s">&quot;java.math.BigDecimal&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="nt">&lt;column</span> <span class="na">name=</span><span class="s">&quot;__total_sales&quot;</span> <span class="na">not-null=</span><span class="s">&quot;false&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/property&gt;</span>
</span><span class='line'>    <span class="nt">&lt;loader</span> <span class="na">query-ref=</span><span class="s">&quot;salesByProductQuery&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/class&gt;</span>
</span><span class='line'>  <span class="nt">&lt;sql-query</span> <span class="na">name=</span><span class="s">&quot;salesByProductQuery&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;return</span> <span class="na">class=</span><span class="s">&quot;SalesByProduct&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>    <span class="cp">&lt;![CDATA[</span>
</span><span class='line'><span class="cp">    select product_id as __id</span>
</span><span class='line'><span class="cp">         , product_id as __product_id</span>
</span><span class='line'><span class="cp">         , sum(total_sales) as __total_sales</span>
</span><span class='line'><span class="cp">      from YESTERDAY_SALES</span>
</span><span class='line'><span class="cp">     where product_id = :product_id</span>
</span><span class='line'><span class="cp">    group by product_id</span>
</span><span class='line'><span class="cp">   ]]&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/sql-query&gt;</span>
</span><span class='line'><span class="nt">&lt;/hibernate-mapping&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note that you need to put a positional argument in the query, or Hibernate will get nasty about parsing it. Hope that helps!</p>
</div>
  
  


        </article>
      
      
        <article class="post" role="article">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        
      </p>
    
    
      <h2 class="entry-title"><a href="/2008/06/16/why-you-should-not-not-use-orm/">Why You Should Not Not Use ORM</a></h2>
    
    












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2008-06-16T00:00:00-04:00" pubdate data-updated="true">Jun 16<span>th</span>, 2008</time>
  </header>


  <div class="entry-content clearfix"><p>
<img style="margin: 0pt 0pt 10px 10px; float: right; cursor: pointer;" src="/assets/images/2522766037_44d8e2e709-731749.jpg" alt="" border="0" />
</p>


<p>Yesterday I read a blog post by Kenneth Downs entitled &#8220;<a href="http://database-programmer.blogspot.com/2008/06/why-i-do-not-use-orm.html">Why I Do Not Use ORM</a>&#8221; on his <a href="http://database-programmer.blogspot.com/">The Database Programmer</a> blog. It wasn&#8217;t the first blog post with gripes about Object Relational Mapping, and it certainly won&#8217;t be the last. For me, this particular article highlighted a few misconceptions about why and how ORM should be used, and I thought I might chime in with my own perspective.</p>

<p><span style="font-weight: bold;">ORM is not a way to avoid SQL</span><br/>
The first thing that stood out for me was this quote:</p>

<blockquote><p>&#8220;The language SQL is the most widely supported, implemented, and used way to connect to databases. But since most of us have long lists of complaints about the language, we end up writing abstraction layers that make it easier for us to avoid coding SQL directly.&#8221;</p></blockquote>

<p>To his credit, the author wasn&#8217;t actually addressing ORM in this paragraph. However, anyone writing business logic which interacts with a database, who is unable to write some basic SQL, is like a bull in a china shop; nothing good will come of it regardless of the tools and abstraction layers employed.</p>

<p><span style="font-weight: bold;">The Simple Example</span><br/>
The next example in the post shows how one would write a row to a database in only four lines of PHP code &#8211; it looks something like this (I removed the comments):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="nv">$row</span> <span class="o">=</span> <span class="nx">getPostStartingWith</span><span class="p">(</span><span class="s2">&quot;inp_&quot;</span><span class="p">);</span>
</span><span class='line'><span class="nv">$table_id</span> <span class="o">=</span> <span class="nx">myGetPostVarFunction</span><span class="p">(</span><span class="s1">&#39;table_id&#39;</span><span class="p">);</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">SQLX_Insert</span><span class="p">(</span><span class="nv">$table_id</span><span class="p">,</span><span class="nv">$row</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'> <span class="nx">myFrameworkErrorReporting</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>I don&#8217;t know PHP, but I think the code is reading every field in a posted form that starts with inp_, generates an insert statement straight from the ID&#8217;s on the form fields, and writes an insert statement with the results.</p>

<p>Perhaps it&#8217;s unfair to criticize this code because &#8220;it&#8217;s just a simple example,&#8221; but if this code is being held up as an example of how short and simple non-ORM code can be, one does have to wonder
*   When the database schema changes, does the HTML need to be updated so that the form fields match the database schema?
*   Where are the transactions? What if I need to insert into several tables and roll back the transaction if one fails?
*   Does the handy SQLX_insert method prevent SQL injection attacks?</p>

<p>He goes on to say that this task is made even easier by <a href="http://database-programmer.blogspot.com/2008/06/using-data-dictionary.html">using a data dictionary</a> to generate the SQL. After reading the &#8220;Using a Data Dictionary&#8221; article, one has to wonder whether or not the author realizes that it is a very crude form of ORM.</p>

<p><span style="font-weight: bold;">What about Business Logic?</span><br/>
Kenneth Downs tries to head-off any arguments about business logic before they come up, knowing that ORM evangelists will argue that the domain objects can encapsulate essential business logic for the application. His response?</p>

<blockquote><p>&#8220;The SQLX_Insert() routine can call out to functions (fast) or objects (much slower) that massage data before and after the insert operation. I will be demonstrating some of these techniques in future essays, but of course the best permforming and safest method is to use triggers.&#8221;</p></blockquote>

<p>For me, this sounds alarm bells. Triggers slow down transactions. Triggers are in your database, which is often your system&#8217;s biggest bottleneck. Triggers silently do things behind your back without telling you. Triggers change databases from vast, efficient places to store relational data, into a lumbering behemoth interpreting procedural code inside big iron.</p>

<p>Conversely, business logic that can be easily distributed across many smaller web servers scales horizontally. The domain layer is a fantastic place to embed simple data massaging &#8211; sadly, I often see a pile of persistent entities with getters and setters that don&#8217;t do anything.</p>

<p><span style="font-weight: bold;">Counter Example: The Disaster Scenario</span><br/>
Lastly, Ken (can I call him that? What is the ettiquite for this sort of thing, anyway?) shows an example of a piece of code that is likely to cause hundreds of unneeded reads to the database in an untuned ORM-based system. I don&#8217;t dispute this; in fact, I <a href="http://mikedesjardins.net/blog/2008/03/pizza-shop-2-totaling-jpa-order-use.html">posted</a> about an almost identical nightmare scenario myself a while ago.</p>

<p>For this, I go back to my &#8220;bull in a china shop&#8221; analogy. Programmers can write horrible code in any language, with any tool. Layers of abstraction are a double-edged sword, because you need to understand what they are doing for you. But it&#8217;s not the tool&#8217;s fault; it&#8217;s the person misusing it.</p>

<p><span style="font-weight: bold;">Computer Science&#8217;s Vietnam</span><br/>
In 2004, Ted Neward famously called ORM <a href="http://blogs.tedneward.com/2006/06/26/The+Vietnam+Of+Computer+Science.aspx">Computer Science&#8217;s Vietnam</a>. Encouraged by early successes, we got sucked into the quagmire. There are plenty of reasons to be frustrated with ORM, but I&#8217;m not sure I agree with Ken&#8217;s. I try to hit the 80/20 rule with ORM, and use it where it makes sense. When I get into a convoluted transaction or need to do a large batch of operations, I&#8217;m not afraid to dive into SQL and do the work in a stored procedure. I think it&#8217;s a good mix. How about you?</p>

<p><span style="font-style: italic;">Photo Credit: </span><a style="font-style: italic;" href="http://www.flickr.com/people/meesterdickey/">Ryan Dickey</a></p>
</div>
  
  


        </article>
      
      
        <article class="post" role="article">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        
      </p>
    
    
      <h2 class="entry-title"><a href="/2008/06/10/use-hibernate-validators-to-find-nasty/">Use Hibernate Validators to Find Nasty DataTruncation Exceptions</a></h2>
    
    












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2008-06-10T00:00:00-04:00" pubdate data-updated="true">Jun 10<span>th</span>, 2008</time>
  </header>


  <div class="entry-content clearfix"><p>If you develop Hibernate applications against either Sybase or MS SQL Server databases, you may have had the pleasure of seeing this little gem:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>09:13:22,155 WARN [] org.hibernate.util.JDBCExceptionReporter  SQL Error: 0, SQLState: 22001
</span><span class='line'>09:13:22,155 ERROR [] org.hibernate.util.JDBCExceptionReporter  Data truncation
</span><span class='line'>09:13:22,155 WARN [] org.hibernate.util.JDBCExceptionReporter  SQL Error: 8152, SQLState: 22001
</span><span class='line'>09:13:22,155 ERROR [] org.hibernate.util.JDBCExceptionReporter  String or binary data would be truncated.
</span><span class='line'>09:13:22,159 ERROR [] org.hibernate.event.def.AbstractFlushingEventListener  Could not synchronize database state with session
</span><span class='line'>.
</span><span class='line'>.
</span><span class='line'>.
</span><span class='line'>Caused by: java.sql.DataTruncation: Data truncation</span></code></pre></td></tr></table></div></figure>


<p>The most maddening thing about these errors is that the database won&#8217;t tell you <span style="font-style: italic;">which</span> column is being
truncated. A likely scenario is that you&#8217;ve developed a Web or Swing UI that permits the user to enter a value for a String field which is
ultimately persisted to a database column, and the UI is not restricting the maximum length of the user&#8217;s input to the size of that the column
supports. The question is, which field is the offender?</p>

<p><span style="font-weight: bold;">Hibernate Validators to the Rescue!</span><br/>
Situations like this are why it&#8217;s a pretty good idea to validate your data at the domain layer of your project, and not rely on your database
and presentation layer to do all of the validation. Fortunately, Hibernate makes this pretty painless with validator annotations. Just import the
org.hibernate.validator.Length annotation, and add the @Length annotation in your entity class, e.g.:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;description&quot;</span><span class="o">,</span><span class="n">length</span><span class="o">=</span><span class="mi">20</span><span class="o">)</span>
</span><span class='line'><span class="nd">@Length</span><span class="o">(</span><span class="n">max</span><span class="o">=</span><span class="mi">20</span><span class="o">)</span>
</span><span class='line'><span class="kd">private</span> <span class="n">String</span> <span class="n">description</span><span class="o">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note that putting the length attribute in the @Column annotation <span style="font-style: italic;">is not enough</span>. That attribute is used
for generating DDL, but will not cause any validation to take place.</p>

<p>Now that our new Annotation is in place, we get the <span style="font-style: italic;">slightly</span> more useful stack-trace below:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">org</span><span class="o">.</span><span class="na">hibernate</span><span class="o">.</span><span class="na">validator</span><span class="o">.</span><span class="na">InvalidStateException</span><span class="o">:</span> <span class="n">validation</span> <span class="n">failed</span> <span class="k">for</span><span class="o">:</span> <span class="n">us</span><span class="o">.</span><span class="na">mikedesjardins</span><span class="o">.</span><span class="na">data</span><span class="o">.</span><span class="na">persist</span><span class="o">.</span><span class="na">MyClass</span>
</span><span class='line'><span class="n">at</span> <span class="n">org</span><span class="o">.</span><span class="na">hibernate</span><span class="o">.</span><span class="na">validator</span><span class="o">.</span><span class="na">event</span><span class="o">.</span><span class="na">ValidateEventListener</span><span class="o">.</span><span class="na">validate</span><span class="o">(</span><span class="n">ValidateEventListener</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">148</span><span class="o">)</span>
</span><span class='line'><span class="n">at</span> <span class="n">org</span><span class="o">.</span><span class="na">hibernate</span><span class="o">.</span><span class="na">validator</span><span class="o">.</span><span class="na">event</span><span class="o">.</span><span class="na">ValidateEventListener</span><span class="o">.</span><span class="na">onPreInsert</span><span class="o">(</span><span class="n">ValidateEventListener</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">172</span><span class="o">)</span>
</span><span class='line'><span class="n">at</span> <span class="n">org</span><span class="o">.</span><span class="na">hibernate</span><span class="o">.</span><span class="na">action</span><span class="o">.</span><span class="na">EntityIdentityInsertAction</span><span class="o">.</span><span class="na">preInsert</span><span class="o">(</span><span class="n">EntityIdentityInsertAction</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">119</span><span class="o">)</span>
</span><span class='line'><span class="o">.</span>
</span><span class='line'><span class="o">.</span>
</span><span class='line'><span class="o">.</span>
</span></code></pre></td></tr></table></div></figure>


<p>Of course, you should catch these exceptions and do something less hostile with them. For now, we&#8217;ll just log the details and re-throw so
you can get the general gist of what you can do. Here&#8217;s a generic insert method in a DAO base class:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">insert</span><span class="o">(</span><span class="n">T</span> <span class="n">valueObject</span><span class="o">,</span> <span class="n">Class</span><span class="o">...</span> <span class="n">clazz</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'> <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>   <span class="n">Session</span> <span class="n">s</span> <span class="o">=</span> <span class="n">getSession</span><span class="o">();</span>
</span><span class='line'>   <span class="n">s</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">valueObject</span><span class="o">);</span>
</span><span class='line'>   <span class="n">s</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
</span><span class='line'>   <span class="n">s</span><span class="o">.</span><span class="na">refresh</span><span class="o">(</span><span class="n">valueObject</span><span class="o">);</span>
</span><span class='line'> <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InvalidStateException</span> <span class="n">v</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>   <span class="n">setToRollback</span><span class="o">();</span>
</span><span class='line'>   <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">&quot;insert(), failed validation &quot;</span> <span class="o">+</span> <span class="n">valueObject</span><span class="o">.</span><span class="na">toString</span><span class="o">(),</span> <span class="n">v</span><span class="o">);</span>
</span><span class='line'>   <span class="n">InvalidValue</span><span class="o">[]</span> <span class="n">invalid</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="na">getInvalidValues</span><span class="o">();</span>
</span><span class='line'>   <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">invalid</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="o">++</span><span class="n">i</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>     <span class="n">InvalidValue</span> <span class="n">bad</span> <span class="o">=</span> <span class="n">invalid</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
</span><span class='line'>     <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">&quot;insert(), &quot;</span> <span class="o">+</span> <span class="n">bad</span><span class="o">.</span><span class="na">getPropertyPath</span><span class="o">()</span>
</span><span class='line'>     <span class="o">+</span> <span class="s">&quot;:&quot;</span> <span class="o">+</span> <span class="n">bad</span><span class="o">.</span><span class="na">getPropertyName</span><span class="o">()</span>
</span><span class='line'>     <span class="o">+</span> <span class="s">&quot;:&quot;</span> <span class="o">+</span> <span class="n">bad</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
</span><span class='line'>   <span class="o">}</span>
</span><span class='line'>   <span class="k">throw</span> <span class="n">v</span><span class="o">;</span>
</span><span class='line'> <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see, the InvalidStateException contains an array of InvalidValue objects which describe the nature of the validation
error. You can either log this information, or even present it to the user.</p>

<p>Hope that helps! Do you use Hibernate&#8217;s validator annotations for something nifty? Let us know in the comments!</p>
</div>
  
  


        </article>
      
      
        <article class="post" role="article">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        
      </p>
    
    
      <h2 class="entry-title"><a href="/2008/06/06/the-hibernate-song/">The Hibernate Song</a></h2>
    
    












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2008-06-06T00:00:00-04:00" pubdate data-updated="true">Jun 6<span>th</span>, 2008</time>
  </header>


  <div class="entry-content clearfix"><center>
<img src="/assets/images/spiderman-704633.png" alt="" border="0" />
</center>


<p>(to the tune of <span style="font-style: italic;">The Spiderman Theme Song</span> from the original cartoon series)</p>

<p>Hibernate, Hibernate<br/>
O/R Mapping sure is great<br/>
Gavin King, and H-Q-L<br/>
Make my life a living hell<br/>
Look out! Here comes Hibernate!</p>

<p>Mapping Files in Hibernate<br/>
Wish my team would annotate<br/>
Are its queries optimized?<br/>
Who knows &#8211; it&#8217;s always a surprise<br/>
Hey there, there goes Hibernate!</p>

<p>Don&#8217;t fetch data now<br/>
Lazy load, &#8216;cuz you might guess<br/>
I don&#8217;t need it now<br/>
Hibernate, you do know best!</p>

<p>Hibernate, Hibernate<br/>
Friendly neighborhood Hibernate<br/>
Grab the jars, and climb aboard<br/>
OO models are your reward<br/>
To it&#8230;<br/>
Relational DBs are old-school<br/>
When you need a complex tool<br/>
You need the Hibernate!</p>
</div>
  
  


        </article>
      
      
        <article class="post" role="article">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        
      </p>
    
    
      <h2 class="entry-title"><a href="/2008/06/05/alltel-verizon-wireless-requiem-for-a/">Alltel / Verizon Wireless &#8211; Requiem for the A-Side</a></h2>
    
    












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2008-06-05T00:00:00-04:00" pubdate data-updated="true">Jun 5<span>th</span>, 2008</time>
  </header>


  <div class="entry-content clearfix"><center>
<img src="/assets/images/cell-phone-suit-733531.jpg" alt="" border="0" />
</center>


<p>So I guess it&#8217;s official: <a href="http://www.engadget.com/2008/06/05/verizon-alltel-merger-would-form-largest-carrier-in-the-us-by-f/">Verizon Wireless is acquiring rival Alltel Wireless for $28 billion</a>. I had another topic in mind for my next post, but I decided to write about this market consolidation instead.</p>

<p>In a former life, I designed and did programming for billing systems for &#8220;tier three&#8221; (i.e., small, regional) wireless carriers. In many ways, it&#8217;s saddening to see what the mobile carrier landscape has become in the United States. One of the things that made it fun to work in the industry was the funky, inspired little companies that were created by scrappy hometown entrepreneurs. It took a certain amount of chutzpah and ingenuity to take on the behemoth teleco&#8217;s, even if it was a small rural corner of East Podunk, U.S.A.</p>

<p>Lots of people worked for the &#8220;Cellular Ones&#8221; of the world. I met some folks who got pretty wealthy by building medium-sized businesses by taking on the incumbent wireline carrier in their neck of the woods. These people hailed from small towns like Beckley, West Virginia, or Fort Morgan, Colorado, or Traverse City, Michigan. A lot of the employees were self-trained and didn&#8217;t have years of experience as Billing Directors or Network Engineers; sometimes it was so-and-so&#8217;s brother-in-law who was appointed to be the &#8220;Switch Tech&#8221; because he was good with electronic stuff.</p>

<p>I believe that these homegrown businesses are good for America. The people who operate them care about their communities because they see their neighbors every day. They hire local people to staff their call centers instead of outsourcing to distant continents. Their leaders do business with their local friends. These businesses help give their part of the world its own personality.</p>

<p>At one time, I thought that MVNO&#8217;s might fill this void &#8211; I had hoped that they could supplement the market with their own quirky personalities. But so far, MVNO&#8217;s have failed to gain much traction in the U.S.</p>

<p>I realize that some good things will come from consolidation. Bigger companies can often roll out better technology more quickly. It&#8217;s harder for, e.g., a small time operation in Decatur, Illinois to roll out 3G data services, than it is for a Goliath like AT&amp;T or Verizon Wireless. But I still mourn the loss of the tier-3&#8242;s; for me, they exemplified the American entrepreneurial spirit.</p>

<p><span style="font-style: italic;">Photo Credit: </span><a style="font-style: italic;" href="http://www.flickr.com/people/kb35/">KB35</a></p>
</div>
  
  


        </article>
      
    </div>

    <ul class="pager">
      
        <li class="previous"><a href="/blog/page/4/">&larr;&nbsp;Older</a></li>
      
      <li><a href="/blog/archives">Blog Archives</a></li>
      
        <li class="next"><a href="/blog/page/2/">Newer&nbsp;&rarr;</a></li>
      
    </ul>
  </div>

  
    <aside class="sidebar col-md-3" role="complementary">
      
        
      
    </aside>
  
</div>

        </div>
      </div>
    </div>
    <footer role="contentinfo"><div class="container">
    <p class="text-muted credits">
  Copyright &copy; 2020 - Mike Desjardins<br>
  <small>
      <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>,
      <span class="credit">customized with <a href="https://github.com/kAworu/octostrap3">octostrap3</a></span>.
  </small>
</p>

</div>
</footer>
    <script src="/assets/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="/javascripts/modernizr-2.0.js"></script>


<script type="text/javascript">
      var disqus_shortname = 'mikedesjardins';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>











  </body>
</html>
