
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>How I debugged a JRuby Stack Overflow - My Octopress Blog</title>
  <meta name="author" content="Your Name">

  
  <meta name="description" content="A little over a year ago, I inherited someone else&#8217;s JRuby on Rails project. My initial role on the team was the &#8220;token Java guy,&#8221; &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://mdesjardins.github.io/2011/03/18/how-i-debugged-a-jruby-stack-overflow">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="My Octopress Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">My Octopress Blog</a></h1>
  
    <h2>A blogging framework for hackers.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:mdesjardins.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">How I Debugged a JRuby Stack Overflow</h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-03-18T00:00:00-04:00" pubdate data-updated="true">Mar 18<span>th</span>, 2011</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>A little over a year ago, I inherited someone else&#8217;s JRuby on Rails project. My initial role on the team was the &#8220;token Java guy,&#8221; and knew almost zero about Ruby. I&#8217;ve since grown to love JRuby, but that&#8217;s a story for another time.</p>

<p>Over the course of the project, I&#8217;ve upgraded my JRuby version, upgraded gems, upgraded Java, and who knows what else. One day, I went to do a migration, and they just plain didn&#8217;t work anymore. I discovered that most migration-related stuff didn&#8217;t work, including tasks like db:test:load. And by &#8220;didn&#8217;t work anymore,&#8221; I mean this:</p>

<pre>Meep:~/_work/sonymusic/src/checkout&gt; rake db:test:load</pre>




<pre>(in /Users/mdesjardins/_work/sonymusic/src/checkout)</pre>




<pre>Invalid access of stack red zone 0x100401b20 rip=0x10a6ceb6e</pre>




<pre>Bus error</pre>


<p>My initial reaction to this is what I expect most people&#8217;s reaction would be: &#8220;what in holy hell is this?&#8221;  It&#8217;s basically a blown stack &#8211; the stack has &#8220;edges&#8221; called red zones to which you should never write, because it means you&#8217;re getting too close to going off the end, and the OS is trying to prevent you from being stupid.</p>

<p>Google was little help &#8211; <a href="http://stackoverflow.com/questions/1501770/invalid-access-of-stack-red-zone-from-java-vm" target="_blank">most people speculated</a> that similar errors were problems w/ OSX&#8217;s JVM implementation.</p>

<p>So I flailed for a while. I tried backing up to version 1.5 of Apple&#8217;s JVM (which itself is <a href="http://hints.macworld.com/article.php?story=20100123192950640" target="_blank">nontrivial</a>, and was made more complicated by the fact that json-jruby requires Java 6, but I digress). When that failed, I tried rolling back random gems and versions of JRuby. I tried <a href="http://stackoverflow.com/questions/2207233/how-to-enable-full-coredumps-on-os-x" target="_blank">enabling core files</a> and reading stacks in gdb, but that ended up being useless. I tried increasing the stack to a whopping 2 Gig (normal is 2M) by passing -J-Xss2048M, but it still crashed.</p>

<p>When I passed -J-d32 on JRuby&#8217;s command line, I got a nice &#8220;Stack Limit Exceeded&#8221; error instead of the nasty crash &#8211; so that was a start. Everything pointed to an infinite recursion problem, but where?</p>

<p>I was getting desperate. As it turns out, before I became a retread Ruby programmer, I worked in Java enterprise stuff. This is the kind of stuff you do at banks and insurance companies, in hellish beige cubicles, where you hang posters with diagrams of middleware and service busses and ORMs.</p>

<p>In beige cubicle hell, I learned about a few tools to monitor active JVMs (this comes in handy when you&#8217;re monitoring god-awful beasts like &#8220;enterprise application servers.&#8221;) I figured it was worth a shot to try out <strong>jstack. </strong>jstack comes with the JVM. It shows you a stack dump of all the threads running in a JVM. If you&#8217;re using it on a local JVM, all you need to do is pass it the PID of the process you&#8217;d like to observe w/ the -l (for local?) command line switch.</p>

<p>The trick was going to be catching it just before it blew up.  After a few tries, I caught this:</p>

<div style="border: solid #555 1px; font-family: monospace; overflow: auto; padding: 10px;">
  &#8220;main&#8221; prio=5 tid=102801000 nid=0&#215;100601000 runnable [10047d000]   java.lang.Thread.State: RUNNABLE at com.mysql.jdbc.util.ReadAheadInputStream.readFromUnderlyingStreamIfNecessary(ReadAheadInputStream.java:123) at com.mysql.jdbc.util.ReadAheadInputStream.read(ReadAheadInputStream.java:188) - locked <7fd39d7c8> (a com.mysql.jdbc.util.ReadAheadInputStream) at com.mysql.jdbc.MysqlIO.readFully(MysqlIO.java:2329) at com.mysql.jdbc.MysqlIO.reuseAndReadPacket(MysqlIO.java:2774) at com.mysql.jdbc.MysqlIO.reuseAndReadPacket(MysqlIO.java:2763) at com.mysql.jdbc.MysqlIO.checkErrorPacket(MysqlIO.java:3299) at com.mysql.jdbc.MysqlIO.sendCommand(MysqlIO.java:1837) at com.mysql.jdbc.MysqlIO.sqlQueryDirect(MysqlIO.java:1961) at com.mysql.jdbc.ConnectionImpl.execSQL(ConnectionImpl.java:2537) - locked <7fd3992c0> (a java.lang.Object) at com.mysql.jdbc.ConnectionImpl.execSQL(ConnectionImpl.java:2466) at com.mysql.jdbc.StatementImpl.executeQuery(StatementImpl.java:1383) - locked <7fd3992c0> (a java.lang.Object) at com.mysql.jdbc.DatabaseMetaData$9.forEach(DatabaseMetaData.java:4815) at com.mysql.jdbc.IterateBlock.doForAll(IterateBlock.java:50) at com.mysql.jdbc.DatabaseMetaData.getTables(DatabaseMetaData.java:4793) at arjdbc.jdbc.RubyJdbcConnection$16.call(RubyJdbcConnection.java:1015) at arjdbc.jdbc.RubyJdbcConnection.withConnectionAndRetry(RubyJdbcConnection.java:1191) at arjdbc.jdbc.RubyJdbcConnection.tables(RubyJdbcConnection.java:576) at arjdbc.jdbc.RubyJdbcConnection.tables(RubyJdbcConnection.java:552) at arjdbc.jdbc.RubyJdbcConnection$i$tables.call(RubyJdbcConnection$i$tables.gen:65535) at org.jruby.runtime.callsite.CachingCallSite.call(CachingCallSite.java:103) at rubyjit.tables_AA8BB5A33C226C4FACC724EF93DE8D1DF04792EB.__file__(/Users/mdesjardins/.rvm/gems/jruby-1.6.0@rails238/gems/activerecord-jdbc-adapter-1.1.1/lib/arjdbc/jdbc/adapter.rb:234) at rubyjit.tables_AA8BB5A33C226C4FACC724EF93DE8D1DF04792EB.__file__(/Users/mdesjardins/.rvm/gems/jruby-1.6.0@rails238/gems/activerecord-jdbc-adapter-1.1.1/lib/arjdbc/jdbc/adapter.rb) at org.jruby.ast.executable.AbstractScript.__file__(AbstractScript.java:37) at org.jruby.internal.runtime.methods.JittedMethod.call(JittedMethod.java:127) at org.jruby.runtime.callsite.CachingCallSite.call(CachingCallSite.java:103) at rubyjit.auto_create_table_E1FB7FE0CE1D294ABA67860B81492049B1D6AE7F.__file__(/Users/mdesjardins/_work/sonymusic/src/checkout/vendor/plugins/auto_migrations/lib/auto_migrations.rb:70) at rubyjit.auto_create_table_E1FB7FE0CE1D294ABA67860B81492049B1D6AE7F.__file__(/Users/mdesjardins/_work/sonymusic/src/checkout/vendor/plugins/auto_migrations/lib/auto_migrations.rb) at org.jruby.internal.runtime.methods.JittedMethod.call(JittedMethod.java:87) at org.jruby.runtime.callsite.CachingCallSite.callBlock(CachingCallSite.java:78) at org.jruby.runtime.callsite.CachingCallSite.call(CachingCallSite.java:84) at rubyjit.method_missing_with_auto_migration_CA4124448766A2D0B44A8F3F5A4A9EC9908F2D02.__file__(/Users/mdesjardins/_work/sonymusic/src/checkout/vendor/plugins/auto_migrations/lib/auto_migrations.rb:55) at rubyjit.method_missing_with_auto_migration_CA4124448766A2D0B44A8F3F5A4A9EC9908F2D02.__file__(/Users/mdesjardins/_work/sonymusic/src/checkout/vendor/plugins/auto_migrations/lib/auto_migrations.rb) at org.jruby.internal.runtime.methods.JittedMethod.call(JittedMethod.java:87) at org.jruby.internal.runtime.methods.DefaultMethod.call(DefaultMethod.java:148) at org.jruby.internal.runtime.methods.AliasMethod.call(AliasMethod.java:101) at org.jruby.internal.runtime.methods.AliasMethod.call(AliasMethod.java:101) at org.jruby.runtime.callsite.CachingCallSite.callBlock(CachingCallSite.java:78) at org.jruby.runtime.callsite.CachingCallSite.call(CachingCallSite.java:84) at rubyjit.auto_create_table_E1FB7FE0CE1D294ABA67860B81492049B1D6AE7F.__file__(/Users/mdesjardins/_work/sonymusic/src/checkout/vendor/plugins/auto_migrations/lib/auto_migrations.rb:71) at rubyjit.auto_create_table_E1FB7FE0CE1D294ABA67860B81492049B1D6AE7F.__file__(/Users/mdesjardins/_work/sonymusic/src/checkout/vendor/plugins/auto_migrations/lib/auto_migrations.rb) at org.jruby.internal.runtime.methods.JittedMethod.call(JittedMethod.java:87) at org.jruby.runtime.callsite.CachingCallSite.callBlock(CachingCallSite.java:78) at org.jruby.runtime.callsite.CachingCallSite.call(CachingCallSite.java:84) at rubyjit.method_missing_with_auto_migration_CA4124448766A2D0B44A8F3F5A4A9EC9908F2D02.__file__(/Users/mdesjardins/_work/sonymusic/src/checkout/vendor/plugins/auto_migrations/lib/auto_migrations.rb:55) at rubyjit.method_missing_with_auto_migration_CA4124448766A2D0B44A8F3F5A4A9EC9908F2D02.__file__(/Users/mdesjardins/_work/sonymusic/src/checkout/vendor/plugins/auto_migrations/lib/auto_migrations.rb) at org.jruby.internal.runtime.methods.JittedMethod.call(JittedMethod.java:87) at org.jruby.internal.runtime.methods.DefaultMethod.call(DefaultMethod.java:148) at org.jruby.internal.runtime.methods.AliasMethod.call(AliasMethod.java:101) at org.jruby.internal.runtime.methods.AliasMethod.call(AliasMethod.java:101) at org.jruby.runtime.callsite.CachingCallSite.callBlock(CachingCallSite.java:78) at org.jruby.runtime.callsite.CachingCallSite.call(CachingCallSite.java:84) at rubyjit.auto_create_table_E1FB7FE0CE1D294ABA67860B81492049B1D6AE7F.__file__(/Users/mdesjardins/_work/sonymusic/src/checkout/vendor/plugins/auto_migrations/lib/auto_migrations.rb:71) at rubyjit.auto_create_table_E1FB7FE0CE1D294ABA67860B81492049B1D6AE7F.__file__(/Users/mdesjardins/_work/sonymusic/src/checkout/vendor/plugins/auto_migrations/lib/auto_migrations.rb) at org.jruby.internal.runtime.methods.JittedMethod.call(JittedMethod.java:87) at org.jruby.runtime.callsite.CachingCallSite.callBlock(CachingCallSite.java:78) at org.jruby.runtime.callsite.CachingCallSite.call(CachingCallSite.java:84) at rubyjit.method_missing_with_auto_migration_CA4124448766A2D0B44A8F3F5A4A9EC9908F2D02.__file__(/Users/mdesjardins/_work/sonymusic/src/checkout/vendor/plugins/auto_migrations/lib/auto_migrations.rb:55) at rubyjit.method_missing_with_auto_migration_CA4124448766A2D0B44A8F3F5A4A9EC9908F2D02.__file__(/Users/mdesjardins/_work/sonymusic/src/checkout/vendor/plugins/auto_migrations/lib/auto_migrations.rb) at org.jruby.internal.runtime.methods.JittedMethod.call(JittedMethod.java:87) at org.jruby.internal.runtime.methods.DefaultMethod.call(DefaultMethod.java:148) at org.jruby.internal.runtime.methods.AliasMethod.call(AliasMethod.java:101) at org.jruby.internal.runtime.methods.AliasMethod.call(AliasMethod.java:101) at org.jruby.runtime.callsite.CachingCallSite.callBlock(CachingCallSite.java:78) at org.jruby.runtime.callsite.CachingCallSite.call(CachingCallSite.java:84) at rubyjit.auto_create_table_E1FB7FE0CE1D294ABA67860B81492049B1D6AE7F.__file__(/Users/mdesjardins/_work/sonymusic/src/checkout/vendor/plugins/auto_migrations/lib/auto_migrations.rb:71) at rubyjit.auto_create_table_E1FB7FE0CE1D294ABA67860B81492049B1D6AE7F.__file__(/Users/mdesjardins/_work/sonymusic/src/checkout/vendor/plugins/auto_migrations/lib/auto_migrations.rb) at org.jruby.internal.runtime.methods.JittedMethod.call(JittedMethod.java:87) at org.jruby.runtime.callsite.CachingCallSite.callBlock(CachingCallSite.java:78) at org.jruby.runtime.callsite.CachingCallSite.call(CachingCallSite.java:84)
</div>


<p>etc. etc. etc. ad infinitum. This was the &#8220;Aha!&#8221; moment. It turned out the problem was in my vendor/auto_migration plugin. What does this plugin do? I honestly have no idea &#8211; from the README, it looks like it&#8217;s a tool that applies schema deltas based on schema.rb instead of using migrations the intended way (hmm&#8230; that seems&#8230; misguided). As I said at the start of this post, I inherited this project. I wasn&#8217;t even using this thing anymore.</p>

<p>I deleted the plugin, and <em>voila</em>! My stack trace woes disappeared.</p>

<p><strong>TL;DR: Use jstack if you&#8217;re stuck w/ a blown stack on JRuby. It works like a champ.</strong></p>

<p>&nbsp;</p>

<p>&nbsp;</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">admin</span></span>

      








  


<time datetime="2011-03-18T00:00:00-04:00" pubdate data-updated="true">Mar 18<span>th</span>, 2011</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/blog/'>blog</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://mdesjardins.github.io/2011/03/18/how-i-debugged-a-jruby-stack-overflow/" data-via="" data-counturl="http://mdesjardins.github.io/2011/03/18/how-i-debugged-a-jruby-stack-overflow/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/2011/01/23/skicast-pro-now-with-widgets/" title="Previous Post: Skicast Pro&#8230; now with widgets!">&laquo; Skicast Pro&#8230; now with widgets!</a>
      
      
        <a class="basic-alignment right" href="/2011/06/28/android-development-the-basics/" title="Next Post: Android Development : The Basics">Android Development : The Basics &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2011/08/23/amazon-ses-ses-verify-email-address-pl-failing-on-osx/">Amazon SES, ses-verify-email-address.pl Failing on OSX</a>
      </li>
    
      <li class="post">
        <a href="/2011/06/28/android-development-the-basics/">Android Development : The Basics</a>
      </li>
    
      <li class="post">
        <a href="/2011/03/18/how-i-debugged-a-jruby-stack-overflow/">How I Debugged a JRuby Stack Overflow</a>
      </li>
    
      <li class="post">
        <a href="/2011/01/23/skicast-pro-now-with-widgets/">Skicast Pro&#8230; Now With Widgets!</a>
      </li>
    
      <li class="post">
        <a href="/2010/10/25/skicast-1-0-released/">Skicast Android Application Released</a>
      </li>
    
  </ul>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Your Name -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
