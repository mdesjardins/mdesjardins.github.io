<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Use Hibernate Validators to find Nasty DataTruncation exceptions - Mike Desjardins</title>
  <meta name="author" content="Mike Desjardins">

  
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://mdesjardins.github.io/2008/06/10/use-hibernate-validators-to-find-nasty">
  <link href="/favicon.png" type="image/png" rel="icon">
  <link href="/atom.xml" rel="alternate" title="Mike Desjardins" type="application/atom+xml">

  <link href="/assets/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" type="text/css">
<link href="/assets/bootstrap/dist/css/bootstrap-theme.min.css" rel="stylesheet" type="text/css">
<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">


  <script src="/javascripts/libs/jquery/jquery-2.0.3.min.js"></script>
  

</head>

  <body   >
    <div id="wrap">
      <header role="banner">
        <nav class="navbar navbar-default" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Mike Desjardins</a>
        </div>

        <div class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
                <li class="active">
                    <a href="/">Blog</a>
                </li>
                <li >
                    <a href="/blog/archives">Archives</a>
                </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a class="subscribe-rss" href="/atom.xml" title="subscribe via RSS">
                        <span class="visible-xs">RSS</span>
                        <img class="hidden-xs" src="/images/rss.png" alt="RSS">
                    </a>
                </li>
                
            </ul>
            
                <form class="search navbar-form navbar-right" action="http://google.com/search" method="GET">
                    <input type="hidden" name="q" value="site:mdesjardins.github.io">
                    <div class="form-group">
                        <input class="form-control" type="text" name="q" placeholder="Search">
                    </div>
                </form>
            
        </div>
    </div>
</nav>


      </header>
      <div id="main" class="container">
        <div id="content">
          <div class="row">
  <div class="page-content col-md-9">
    <article class="hentry" role="article">
      
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2008-06-10T00:00:00-04:00" pubdate data-updated="true">Jun 10<span>th</span>, 2008</time>
        
      </p>
    
    
    <h1 class="entry-title">
        Use Hibernate Validators to Find Nasty DataTruncation Exceptions
        
    </h1>
    
  </header>


<div class="entry-content clearfix"><p>If you develop Hibernate applications against either Sybase or MS SQL Server databases, you may have had the pleasure of seeing this little gem:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>09:13:22,155 WARN [] org.hibernate.util.JDBCExceptionReporter – SQL Error: 0, SQLState: 22001
</span><span class='line'>09:13:22,155 ERROR [] org.hibernate.util.JDBCExceptionReporter – Data truncation
</span><span class='line'>09:13:22,155 WARN [] org.hibernate.util.JDBCExceptionReporter – SQL Error: 8152, SQLState: 22001
</span><span class='line'>09:13:22,155 ERROR [] org.hibernate.util.JDBCExceptionReporter – String or binary data would be truncated.
</span><span class='line'>09:13:22,159 ERROR [] org.hibernate.event.def.AbstractFlushingEventListener – Could not synchronize database state with session
</span><span class='line'>.
</span><span class='line'>.
</span><span class='line'>.
</span><span class='line'>Caused by: java.sql.DataTruncation: Data truncation</span></code></pre></td></tr></table></div></figure>


<p>The most maddening thing about these errors is that the database won&#8217;t tell you <span style="font-style: italic;">which</span> column is being
truncated. A likely scenario is that you&#8217;ve developed a Web or Swing UI that permits the user to enter a value for a String field which is
ultimately persisted to a database column, and the UI is not restricting the maximum length of the user&#8217;s input to the size of that the column
supports. The question is, which field is the offender?</p>

<p><span style="font-weight: bold;">Hibernate Validators to the Rescue!</span><br/>
Situations like this are why it&#8217;s a pretty good idea to validate your data at the domain layer of your project, and not rely on your database
and presentation layer to do all of the validation. Fortunately, Hibernate makes this pretty painless with validator annotations. Just import the
org.hibernate.validator.Length annotation, and add the @Length annotation in your entity class, e.g.:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;description&quot;</span><span class="o">,</span><span class="n">length</span><span class="o">=</span><span class="mi">20</span><span class="o">)</span>
</span><span class='line'><span class="nd">@Length</span><span class="o">(</span><span class="n">max</span><span class="o">=</span><span class="mi">20</span><span class="o">)</span>
</span><span class='line'><span class="kd">private</span> <span class="n">String</span> <span class="n">description</span><span class="o">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note that putting the length attribute in the @Column annotation <span style="font-style: italic;">is not enough</span>. That attribute is used
for generating DDL, but will not cause any validation to take place.</p>

<p>Now that our new Annotation is in place, we get the <span style="font-style: italic;">slightly</span> more useful stack-trace below:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">org</span><span class="o">.</span><span class="na">hibernate</span><span class="o">.</span><span class="na">validator</span><span class="o">.</span><span class="na">InvalidStateException</span><span class="o">:</span> <span class="n">validation</span> <span class="n">failed</span> <span class="k">for</span><span class="o">:</span> <span class="n">us</span><span class="o">.</span><span class="na">mikedesjardins</span><span class="o">.</span><span class="na">data</span><span class="o">.</span><span class="na">persist</span><span class="o">.</span><span class="na">MyClass</span>
</span><span class='line'><span class="n">at</span> <span class="n">org</span><span class="o">.</span><span class="na">hibernate</span><span class="o">.</span><span class="na">validator</span><span class="o">.</span><span class="na">event</span><span class="o">.</span><span class="na">ValidateEventListener</span><span class="o">.</span><span class="na">validate</span><span class="o">(</span><span class="n">ValidateEventListener</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">148</span><span class="o">)</span>
</span><span class='line'><span class="n">at</span> <span class="n">org</span><span class="o">.</span><span class="na">hibernate</span><span class="o">.</span><span class="na">validator</span><span class="o">.</span><span class="na">event</span><span class="o">.</span><span class="na">ValidateEventListener</span><span class="o">.</span><span class="na">onPreInsert</span><span class="o">(</span><span class="n">ValidateEventListener</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">172</span><span class="o">)</span>
</span><span class='line'><span class="n">at</span> <span class="n">org</span><span class="o">.</span><span class="na">hibernate</span><span class="o">.</span><span class="na">action</span><span class="o">.</span><span class="na">EntityIdentityInsertAction</span><span class="o">.</span><span class="na">preInsert</span><span class="o">(</span><span class="n">EntityIdentityInsertAction</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">119</span><span class="o">)</span>
</span><span class='line'><span class="o">.</span>
</span><span class='line'><span class="o">.</span>
</span><span class='line'><span class="o">.</span>
</span></code></pre></td></tr></table></div></figure>


<p>Of course, you should catch these exceptions and do something less hostile with them. For now, we&#8217;ll just log the details and re-throw so
you can get the general gist of what you can do. Here&#8217;s a generic insert method in a DAO base class:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">insert</span><span class="o">(</span><span class="n">T</span> <span class="n">valueObject</span><span class="o">,</span> <span class="n">Class</span><span class="o">...</span> <span class="n">clazz</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'> <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>   <span class="n">Session</span> <span class="n">s</span> <span class="o">=</span> <span class="n">getSession</span><span class="o">();</span>
</span><span class='line'>   <span class="n">s</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">valueObject</span><span class="o">);</span>
</span><span class='line'>   <span class="n">s</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
</span><span class='line'>   <span class="n">s</span><span class="o">.</span><span class="na">refresh</span><span class="o">(</span><span class="n">valueObject</span><span class="o">);</span>
</span><span class='line'> <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InvalidStateException</span> <span class="n">v</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>   <span class="n">setToRollback</span><span class="o">();</span>
</span><span class='line'>   <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">&quot;insert(), failed validation &quot;</span> <span class="o">+</span> <span class="n">valueObject</span><span class="o">.</span><span class="na">toString</span><span class="o">(),</span> <span class="n">v</span><span class="o">);</span>
</span><span class='line'>   <span class="n">InvalidValue</span><span class="o">[]</span> <span class="n">invalid</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="na">getInvalidValues</span><span class="o">();</span>
</span><span class='line'>   <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">invalid</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="o">++</span><span class="n">i</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>     <span class="n">InvalidValue</span> <span class="n">bad</span> <span class="o">=</span> <span class="n">invalid</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
</span><span class='line'>     <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">&quot;insert(), &quot;</span> <span class="o">+</span> <span class="n">bad</span><span class="o">.</span><span class="na">getPropertyPath</span><span class="o">()</span>
</span><span class='line'>     <span class="o">+</span> <span class="s">&quot;:&quot;</span> <span class="o">+</span> <span class="n">bad</span><span class="o">.</span><span class="na">getPropertyName</span><span class="o">()</span>
</span><span class='line'>     <span class="o">+</span> <span class="s">&quot;:&quot;</span> <span class="o">+</span> <span class="n">bad</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
</span><span class='line'>   <span class="o">}</span>
</span><span class='line'>   <span class="k">throw</span> <span class="n">v</span><span class="o">;</span>
</span><span class='line'> <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see, the InvalidStateException contains an array of InvalidValue objects which describe the nature of the validation
error. You can either log this information, or even present it to the user.</p>

<p>Hope that helps! Do you use Hibernate&#8217;s validator annotations for something nifty? Let us know in the comments!</p>
</div>


      <footer>
        <p class="meta text-muted">
          
  

<span class="glyphicon glyphicon-user"></span> <span class="byline author vcard">Posted by <span class="fn">mdesjardins</span></span>

          












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2008-06-10T00:00:00-04:00" pubdate data-updated="true">Jun 10<span>th</span>, 2008</time>
          

<span class="glyphicon glyphicon-tags"></span>&nbsp;
<span class="categories">
  
    <a class='category' href='/blog/categories/blog/'>blog</a>
  
</span>


        </p>
        
          <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://mdesjardins.github.io/2008/06/10/use-hibernate-validators-to-find-nasty/" data-via="mdesjardins" data-counturl="http://mdesjardins.github.io/2008/06/10/use-hibernate-validators-to-find-nasty/" >Tweet</a>
  
  
  
</div>

        
        
          <ul class="meta text-muted pager">
            
            <li class="previous"><a href="/2008/06/06/the-hibernate-song/" title="Previous Post: The Hibernate Song">&laquo; The Hibernate Song</a></li>
            
            
            <li class="next"><a href="/2008/06/16/why-you-should-not-not-use-orm/" title="Next Post: Why you should not not use ORM">Why you should not not use ORM &raquo;</a></li>
            
          </ul>
        
      </footer>
    </article>
    
  </div>

  
  <aside class="sidebar col-md-3">
    
      <section class="panel panel-default">
  <div class="panel-heading">
    <h3 class="panel-title">Recent Posts</h3>
  </div>
  
  <div id="recent_posts" class="list-group">
    
    <a class="list-group-item " href="/2011/08/23/amazon-ses-ses-verify-email-address-pl-failing-on-osx/">Amazon SES, ses-verify-email-address.pl Failing on OSX</a>
    
    <a class="list-group-item " href="/2011/06/28/android-development-the-basics/">Android Development : The Basics</a>
    
    <a class="list-group-item " href="/2011/03/18/how-i-debugged-a-jruby-stack-overflow/">How I Debugged a JRuby Stack Overflow</a>
    
    <a class="list-group-item " href="/2011/01/23/skicast-pro-now-with-widgets/">Skicast Pro&#8230; Now With Widgets!</a>
    
    <a class="list-group-item " href="/2010/10/25/skicast-1-0-released/">Skicast Android Application Released</a>
    
  </div>
</section>

<section class="panel panel-default clearfix">
  <div class="panel-heading">
      <h3 class="panel-title">GitHub Repos</h3>
  </div>
  <div class="list-group" id="gh_repos">
    <p class="loading">Status updating...</p>
  </div>
  
    <div class="gh-profile-link pull-right text-muted">
      <a href="https://github.com/mdesjardins">@mdesjardins</a> on GitHub
    </div>
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'mdesjardins',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>




<section class="googleplus panel panel-default">
  <div class="panel-body">
    <h1>
      <a href="https://plus.google.com/desjardinsmike?rel=author">
        <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
        Google+
      </a>
    </h1>
  </div>
</section>



    
  </aside>
  
</div>

        </div>
      </div>
    </div>
    <footer role="contentinfo"><div class="container">
    <p class="text-muted credits">
  Copyright &copy; 2013 - Mike Desjardins<br>
  <small>
      <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>,
      <span class="credit">customized with <a href="https://github.com/kAworu/octostrap3">octostrap3</a></span>.
  </small>
</p>

</div>
</footer>
    <script src="/assets/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="/javascripts/modernizr-2.0.js"></script>








  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





  </body>
</html>
