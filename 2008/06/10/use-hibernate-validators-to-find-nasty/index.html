
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Use Hibernate Validators to find Nasty DataTruncation exceptions - My Octopress Blog</title>
  <meta name="author" content="Your Name">

  
  <meta name="description" content="If you develop Hibernate applications against either Sybase or MS SQL Server databases, you may have had the pleasure of seeing this little gem: 09: &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://mdesjardins.github.io/2008/06/10/use-hibernate-validators-to-find-nasty">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="My Octopress Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">My Octopress Blog</a></h1>
  
    <h2>A blogging framework for hackers.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:mdesjardins.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Use Hibernate Validators to Find Nasty DataTruncation Exceptions</h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-06-10T00:00:00-04:00" pubdate data-updated="true">Jun 10<span>th</span>, 2008</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>If you develop Hibernate applications against either Sybase or MS SQL Server databases, you may have had the pleasure of seeing this little gem:</p>

<p><span style="font-size:78%;"><span style="font-family:courier new;">09:13:22,155 WARN [] org.hibernate.util.JDBCExceptionReporter &#8211; SQL Error: 0, SQLState: 22001</span><br /><span style="font-family:courier new;">09:13:22,155 ERROR [] org.hibernate.util.JDBCExceptionReporter &#8211; Data truncation</span><br /><span style="font-family:courier new;">09:13:22,155 WARN [] org.hibernate.util.JDBCExceptionReporter &#8211; SQL Error: 8152, SQLState: 22001</span><br /><span style="font-family:courier new;">09:13:22,155 ERROR [] org.hibernate.util.JDBCExceptionReporter &#8211; String or binary data would be truncated.</span><br /><span style="font-family:courier new;">09:13:22,159 ERROR [] org.hibernate.event.def.AbstractFlushingEventListener &#8211; Could not synchronize database state with session</span><br /><span style="font-family:courier new;"></span><span style="font-family:courier new;">.</span><br /><span style="font-family:courier new;">.</span><br /><span style="font-family:courier new;">.</span><br /><span style="font-family:courier new;">Caused by: java.sql.DataTruncation: Data truncation</span></span></p>

<p>The most maddening thing about these errors is that the database won&#8217;t tell you <span style="font-style: italic;">which</span> column is being truncated. A likely scenario is that you&#8217;ve developed a Web or Swing UI that permits the user to enter a value for a String field which is ultimately persisted to a database column, and the UI is not restricting the maximum length of the user&#8217;s input to the size of that the column supports. The question is, which field is the offender?</p>

<p><span style="font-weight: bold;">Hibernate Validators to the Rescue!</span><br/>
Situations like this are why it&#8217;s a pretty good idea to validate your data at the domain layer of your project, and not rely on your database and presentation layer to do all of the validation. Fortunately, Hibernate makes this pretty painless with validator annotations. Just import the org.hibernate.validator.Length annotation, and add the @Length annotation in your entity class, e.g.:</p>

<div class="wp_syntax">
  <div class="code">
    <pre class="java" style="font-family:monospace;">@Column<span style="color: #009900;">&#40;</span>name<span style="color: #339933;">=</span><span style="color: #0000ff;">"description"</span>,length<span style="color: #339933;">=</span><span style="color: #cc66cc;">20</span><span style="color: #009900;">&#41;</span>
@Length<span style="color: #009900;">&#40;</span>max<span style="color: #339933;">=</span><span style="color: #cc66cc;">20</span><span style="color: #009900;">&#41;</span>
<span style="color: #000000; font-weight: bold;">private</span> <span style="color: #003399;">String</span> description<span style="color: #339933;">;</span></pre>
  </div>
</div>


<p>Note that putting the length attribute in the @Column annotation <span style="font-style: italic;">is not enough</span>. That attribute is used for generating DDL, but will not cause any validation to take place.</p>

<p>Now that our new Annotation is in place, we get the <span style="font-style: italic;">slightly</span> more useful stack-trace below:</p>

<p><span style="font-size:78%;"><span style="font-family:courier new;">org.hibernate.validator.InvalidStateException: validation failed for: us.mikedesjardins.data.persist.MyClass</span><br /><span style="font-family:courier new;"> at org.hibernate.validator.event.ValidateEventListener.validate(ValidateEventListener.java:148)</span><br /><span style="font-family:courier new;"> at org.hibernate.validator.event.ValidateEventListener.onPreInsert(ValidateEventListener.java:172)</span><br /><span style="font-family:courier new;"> at org.hibernate.action.EntityIdentityInsertAction.preInsert(EntityIdentityInsertAction.java:119)</span><br /><span style="font-family:courier new;">.</span><br /><span style="font-family:courier new;">.</span><br /><span style="font-family:courier new;">.</span><br /><span style="font-family:courier new;"></span></span><br/>
Of course, you should catch these exceptions and do something less hostile with them. For now, we&#8217;ll just log the details and re-throw so you can get the general gist of what you can do. Here&#8217;s a generic insert method in a DAO base class:</p>

<div class="wp_syntax">
  <div class="code">
    <pre class="java" style="font-family:monospace;"><span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000066; font-weight: bold;">void</span> insert<span style="color: #009900;">&#40;</span>T valueObject, <span style="color: #000000; font-weight: bold;">Class</span>... <span style="color: #006633;">clazz</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
 <span style="color: #000000; font-weight: bold;">try</span> <span style="color: #009900;">&#123;</span>
   Session s <span style="color: #339933;">=</span> getSession<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
   s.<span style="color: #006633;">save</span><span style="color: #009900;">&#40;</span>valueObject<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
   s.<span style="color: #006633;">flush</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
   s.<span style="color: #006633;">refresh</span><span style="color: #009900;">&#40;</span>valueObject<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
 <span style="color: #009900;">&#125;</span> <span style="color: #000000; font-weight: bold;">catch</span> <span style="color: #009900;">&#40;</span>InvalidStateException v<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
   setToRollback<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
   log.<span style="color: #006633;">error</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">"insert(), failed validation "</span> <span style="color: #339933;">+</span> valueObject.<span style="color: #006633;">toString</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>, v<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
   <span style="color: #003399;">InvalidValue</span><span style="color: #009900;">&#91;</span><span style="color: #009900;">&#93;</span> invalid <span style="color: #339933;">=</span> v.<span style="color: #006633;">getInvalidValues</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
   <span style="color: #000000; font-weight: bold;">for</span> <span style="color: #009900;">&#40;</span><span style="color: #000066; font-weight: bold;">int</span> i<span style="color: #339933;">=</span><span style="color: #cc66cc;"></span><span style="color: #339933;">;</span> i<span style="color: #339933;">&lt;</span>invalid.<span style="color: #006633;">length</span><span style="color: #339933;">;</span> <span style="color: #339933;">++</span>i<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
     <span style="color: #003399;">InvalidValue</span> bad <span style="color: #339933;">=</span> invalid<span style="color: #009900;">&#91;</span>i<span style="color: #009900;">&#93;</span><span style="color: #339933;">;</span>
     log.<span style="color: #006633;">error</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">"insert(), "</span> <span style="color: #339933;">+</span> bad.<span style="color: #006633;">getPropertyPath</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>
     <span style="color: #339933;">+</span> <span style="color: #0000ff;">":"</span> <span style="color: #339933;">+</span> bad.<span style="color: #006633;">getPropertyName</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>
     <span style="color: #339933;">+</span> <span style="color: #0000ff;">":"</span> <span style="color: #339933;">+</span> bad.<span style="color: #006633;">getMessage</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
   <span style="color: #009900;">&#125;</span>
   <span style="color: #000000; font-weight: bold;">throw</span> v<span style="color: #339933;">;</span>
 <span style="color: #009900;">&#125;</span>
<span style="color: #009900;">&#125;</span></pre>
  </div>
</div>


<p><span style="font-size:100%;">As you can see, the InvalidStateException contains an array of InvalidValue objects which describe the nature of the validation error. You can either log this information, or even present it to the user.</p> <p>
  Hope that helps! Do you use Hibernate&#8217;s validator annotations for something nifty? Let us know in the comments!<br /></span>
</p></p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">mdesjardins</span></span>

      








  


<time datetime="2008-06-10T00:00:00-04:00" pubdate data-updated="true">Jun 10<span>th</span>, 2008</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/blog/'>blog</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://mdesjardins.github.io/2008/06/10/use-hibernate-validators-to-find-nasty/" data-via="" data-counturl="http://mdesjardins.github.io/2008/06/10/use-hibernate-validators-to-find-nasty/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/2008/06/06/the-hibernate-song/" title="Previous Post: The Hibernate Song">&laquo; The Hibernate Song</a>
      
      
        <a class="basic-alignment right" href="/2008/06/16/why-you-should-not-not-use-orm/" title="Next Post: Why you should not not use ORM">Why you should not not use ORM &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2011/08/23/amazon-ses-ses-verify-email-address-pl-failing-on-osx/">Amazon SES, ses-verify-email-address.pl Failing on OSX</a>
      </li>
    
      <li class="post">
        <a href="/2011/06/28/android-development-the-basics/">Android Development : The Basics</a>
      </li>
    
      <li class="post">
        <a href="/2011/03/18/how-i-debugged-a-jruby-stack-overflow/">How I Debugged a JRuby Stack Overflow</a>
      </li>
    
      <li class="post">
        <a href="/2011/01/23/skicast-pro-now-with-widgets/">Skicast Pro&#8230; Now With Widgets!</a>
      </li>
    
      <li class="post">
        <a href="/2010/10/25/skicast-1-0-released/">Skicast Android Application Released</a>
      </li>
    
  </ul>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Your Name -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
